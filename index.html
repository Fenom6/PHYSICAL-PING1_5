<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Physical Ping — pTCP v1.5 APPLICATION</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:auto;-webkit-overflow-scrolling:touch}
body{background:linear-gradient(170deg,#0a0f14 0%,#0d1520 40%,#0a1218 100%);color:#8899aa;font-family:'IBM Plex Mono','Courier New',monospace;font-size:13px}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes glowPulse{0%,100%{box-shadow:0 0 8px rgba(0,255,170,.1)}50%{box-shadow:0 0 20px rgba(0,255,170,.25)}}
@keyframes nfcRipple{0%{transform:scale(.8);opacity:.6}100%{transform:scale(1.4);opacity:0}}
@keyframes netPulse{0%{box-shadow:0 0 4px rgba(0,255,170,.2)}50%{box-shadow:0 0 16px rgba(0,255,170,.5)}100%{box-shadow:0 0 4px rgba(0,255,170,.2)}}
@keyframes scanLine{0%{top:0}100%{top:100%}}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#0a0f14}::-webkit-scrollbar-thumb{background:#1a2a3a;border-radius:2px}
.scan{position:fixed;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,170,.005) 2px,rgba(0,255,170,.005) 4px);pointer-events:none;z-index:100}
.ctn{max-width:960px;margin:0 auto;padding:20px 16px}
.hdr{margin-bottom:18px;border-bottom:1px solid #1a2530;padding-bottom:14px}
.hdr-row{display:flex;align-items:baseline;gap:10px;margin-bottom:4px;flex-wrap:wrap}
.hdr h1{font-size:18px;font-weight:600;color:#00ffaa;letter-spacing:3px;text-shadow:0 0 20px rgba(0,255,170,.3)}
.hdr .ver{font-size:10px;color:#334455;letter-spacing:1px}
.hdr .sub{font-size:10px;color:#00ffaa44;letter-spacing:1.5px;margin-top:2px}
.hdr p{font-size:11px;color:#445566;line-height:1.6;margin-top:6px}
.sec{margin-bottom:14px;padding:12px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.2)}
.sec-label{font-size:10px;color:#445566;letter-spacing:2px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.sec-label .dot{width:5px;height:5px;border-radius:50%;display:inline-block}
.layer-tabs{display:flex;gap:2px;margin-bottom:14px;border:1px solid #1a2530;border-radius:2px;overflow:hidden;flex-wrap:wrap}
.layer-tab{flex:1;padding:10px 6px;text-align:center;font-size:10px;letter-spacing:1px;cursor:pointer;border:none;background:rgba(0,0,0,.3);color:#556677;font-family:inherit;transition:all .2s;-webkit-tap-highlight-color:transparent;position:relative;min-width:42px}
.layer-tab:hover{background:rgba(255,255,255,.02)}
.layer-tab.active{background:rgba(0,0,0,.5);color:#c0d0e0}
.layer-tab .tab-icon{font-size:13px;display:block;margin-bottom:2px}
.lv-row{display:flex;align-items:center;gap:10px}
.lv-lbl{font-size:10px;color:#445566;letter-spacing:1.5px;min-width:44px}
.lv-bg{flex:1;height:8px;background:#0a0f14;border-radius:1px;overflow:hidden}
.lv-bar{height:100%;border-radius:1px;transition:width .06s linear;min-width:1px}
.lv-val{font-size:11px;min-width:68px;text-align:right;font-variant-numeric:tabular-nums}
.ctrl{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.btn{border:none;padding:10px 20px;font-size:12px;font-family:'IBM Plex Mono',monospace;letter-spacing:2px;cursor:pointer;border-radius:2px;transition:all .15s;-webkit-tap-highlight-color:transparent}
.btn:active{transform:scale(.97)}
.btn-ping{background:linear-gradient(180deg,#00ffaa22,#00ffaa11);border:1px solid #00ffaa44;color:#00ffaa}
.btn-ping:disabled{background:#0a2a1a;cursor:wait;opacity:.6}
.btn-cont{background:transparent;border:1px solid #334455;color:#667788;padding:10px 16px;font-size:11px;letter-spacing:1px}
.btn-stop{background:linear-gradient(180deg,#ff333322,#ff333311);border:1px solid #ff333344;color:#ff3333;animation:pulse 1s infinite}
.btn-sm{padding:6px 12px;font-size:10px;letter-spacing:1px}
.btn-clear{background:transparent;border:1px solid #1a2530;color:#445566;margin-left:auto}
.btn-calib{background:transparent;border:1px solid #ffcc0044;color:#ffcc00}
.sel-row{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:stretch}
.sel-grp{display:flex;align-items:center;gap:6px}
.sel-grp span{font-size:10px;color:#445566;letter-spacing:1px}
.sel-grp select{background:#0d1520;border:1px solid #1a2530;color:#8899aa;padding:4px 8px;font-size:11px;font-family:inherit;border-radius:2px}
.sig-info{font-size:10px;color:#556677;padding:6px 10px;background:rgba(0,0,0,.15);border:1px solid #1a2530;border-radius:2px;flex:1;min-width:200px;line-height:1.6}
.err{padding:10px 14px;background:rgba(255,50,50,.08);border:1px solid #ff333344;border-radius:2px;font-size:11px;color:#ff6666;margin-bottom:12px}
.nfo{padding:10px 14px;background:rgba(0,255,170,.04);border:1px solid #00ffaa22;border-radius:2px;font-size:11px;color:#00ffaa88;margin-bottom:12px;line-height:1.6}
.sts{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:1px;background:#1a2530;border:1px solid #1a2530;border-radius:2px;margin-bottom:14px;overflow:hidden}
.st{background:#0d1520;text-align:center;padding:7px 4px}
.st-l{font-size:9px;letter-spacing:1.5px;color:#556677;margin-bottom:2px}
.st-v{font-size:16px;font-weight:600;font-variant-numeric:tabular-nums}
.st-u{font-size:10px;color:#556677;margin-left:2px}
.cv-wrap{margin-bottom:14px;border:1px solid #1a2530;border-radius:2px;overflow:hidden;background:rgba(0,0,0,.2)}
.cv-lbl{font-size:10px;color:#445566;letter-spacing:1.5px;padding:8px 10px 4px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:4px}
.cv-lbl span:last-child{color:#334455}
.cv{display:block;width:100%}
.tl-bars{display:flex;align-items:flex-end;gap:2px;height:40px}
.tl-b{flex:1;border-radius:1px 1px 0 0;transition:height .3s ease;min-width:2px}
.log{border:1px solid #1a2530;border-radius:2px;overflow:hidden}
.log-h,.log-r{display:grid;grid-template-columns:56px 46px 60px 62px 56px 56px 1fr;padding:5px 8px;align-items:center}
.log-h{font-size:9px;letter-spacing:1.5px;color:#334455;border-bottom:1px solid #1a2530;background:rgba(0,0,0,.3)}
.log-b{max-height:300px;overflow:auto}
.log-r{font-size:11px;border-bottom:1px solid rgba(26,37,48,.5);color:#8899aa;animation:fadeIn .25s ease}
.log-r:nth-child(even){background:rgba(255,255,255,.008)}
.log-r.to{color:#555}
.empty{text-align:center;padding:44px 20px;color:#334455}
.empty-i{font-size:32px;margin-bottom:10px;opacity:.3}
.empty-t{font-size:11px;letter-spacing:2px;margin-bottom:8px}
.empty-d{font-size:10px;color:#223344;max-width:440px;margin:0 auto;line-height:1.8}
.leg{margin-top:14px;padding-top:10px;border-top:1px solid #1a2530;display:flex;flex-wrap:wrap;gap:10px;font-size:9px;color:#445566;letter-spacing:1px}
.leg-i{display:flex;align-items:center;gap:4px}
.leg-d{width:6px;height:6px;border-radius:1px}
.ftr{margin-top:8px;font-size:9px;color:#223344;line-height:1.8}
.em-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.em-card{padding:10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15)}
.em-card-h{font-size:9px;letter-spacing:2px;color:#556677;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.em-card-v{font-size:22px;font-weight:600;font-variant-numeric:tabular-nums}
.em-card-u{font-size:10px;color:#556677;margin-left:3px}
.em-card-sub{font-size:9px;color:#334455;margin-top:3px}
.em-bar-row{display:flex;align-items:center;gap:6px;margin-top:4px}
.em-bar-bg{flex:1;height:4px;background:#0a0f14;border-radius:1px;overflow:hidden}
.em-bar-fill{height:100%;border-radius:1px;transition:width .3s}
.med-coeff{padding:16px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.25);margin-bottom:14px;position:relative;overflow:hidden}
.med-coeff::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 30% 50%,rgba(0,255,170,.03) 0%,transparent 70%);pointer-events:none}
.med-val{font-size:28px;font-weight:600;font-variant-numeric:tabular-nums}
.med-lbl{font-size:8px;letter-spacing:2px;color:#556677;margin-top:2px}
.radar-wrap{margin-bottom:14px;border:1px solid #1a2530;border-radius:2px;overflow:hidden;background:rgba(0,0,0,.25);padding:12px}
.radar-wrap canvas{display:block;margin:0 auto}
.sp-tag{display:inline-block;padding:3px 8px;font-size:9px;letter-spacing:1.5px;border-radius:1px;margin:2px}
.rf-band-tag{display:inline-block;padding:2px 6px;font-size:8px;letter-spacing:1px;border-radius:1px;margin:1px;cursor:pointer;transition:all .15s}
.rf-band-tag.active{box-shadow:0 0 8px currentColor}
.nfc-pulse{width:80px;height:80px;border-radius:50%;margin:16px auto;position:relative;display:flex;align-items:center;justify-content:center}
.thermal-gradient{height:12px;border-radius:1px;background:linear-gradient(90deg,#0044ff,#00ccff,#00ff88,#ffcc00,#ff4400,#ff0000);position:relative}
.spatial-3d-wrap{border:1px solid #1a2530;border-radius:2px;overflow:hidden;background:#000;margin-bottom:14px;position:relative}
.spatial-3d-wrap canvas{display:block;width:100%}
.plane-card{padding:8px 10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15);margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;animation:fadeIn .25s ease}
.ble-dev{padding:8px 10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15);margin-bottom:4px;animation:fadeIn .25s ease}
.ble-rssi-bar{height:3px;border-radius:1px;transition:width .5s}
.net-node{padding:8px 10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15);margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;animation:fadeIn .3s ease}
.net-node.self{border-color:#00ffaa33;background:rgba(0,255,170,.04)}
.transport-badge{display:inline-block;padding:2px 6px;font-size:7px;letter-spacing:1.5px;font-weight:600;border-radius:2px;margin-left:4px}
.transport-badge.webrtc{background:rgba(0,221,255,.1);border:1px solid rgba(0,221,255,.35);color:#00ddff}
.transport-badge.bc{background:rgba(0,255,170,.1);border:1px solid rgba(0,255,170,.35);color:#00ffaa}
.transport-badge.sim{background:rgba(255,204,0,.08);border:1px solid rgba(255,204,0,.3);color:#ffcc00}
.ice-badge{display:inline-block;padding:1px 5px;font-size:7px;letter-spacing:1px;border-radius:2px}
.ice-badge.host{background:rgba(0,255,170,.1);color:#00ffaa}
.ice-badge.srflx{background:rgba(0,221,255,.1);color:#00ddff}
.ice-badge.relay{background:rgba(255,136,0,.1);color:#ff8800}
.anchor-card{padding:8px 10px;border:1px solid #ff446633;border-radius:2px;background:rgba(255,68,102,.03);margin-bottom:4px;animation:fadeIn .25s ease}
.peer-quality{display:flex;gap:2px;align-items:center}
.peer-quality .q-dot{width:4px;height:12px;border-radius:1px;transition:background .3s}
.qr-scan-line{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#00ffaa,transparent);animation:scanLine 2s linear infinite}
.pkt-row{display:grid;grid-template-columns:52px 32px 42px 60px 36px 28px 1fr;padding:4px 8px;font-size:10px;border-bottom:1px solid rgba(26,37,48,.3);align-items:center;animation:fadeIn .15s ease}
.pkt-row:nth-child(even){background:rgba(255,255,255,.005)}
.phase-law-card{padding:14px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.2);margin-bottom:8px;position:relative;overflow:hidden}
.src-badge{display:inline-block;padding:1px 5px;font-size:7px;letter-spacing:1.5px;font-weight:600;border-radius:2px;vertical-align:middle;line-height:1.6}
.src-badge.real{background:rgba(0,255,170,.1);border:1px solid rgba(0,255,170,.35);color:#00ffaa}
.src-badge.sim{background:rgba(255,204,0,.08);border:1px solid rgba(255,204,0,.3);color:#ffcc00}
.src-badge.na{background:rgba(102,119,136,.08);border:1px solid rgba(102,119,136,.25);color:#667788}
.src-badge.est{background:rgba(255,136,0,.08);border:1px solid rgba(255,136,0,.3);color:#ff8800}
.reality-bar{display:flex;height:10px;border-radius:1px;overflow:hidden;gap:1px;margin:8px 0}
.reality-bar .rb-seg{transition:width .4s ease}
.reality-idx{padding:14px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.25);margin-bottom:14px;position:relative;overflow:hidden}
.src-matrix{display:grid;grid-template-columns:repeat(auto-fit,minmax(78px,1fr));gap:4px;margin-top:8px}
.src-cell{text-align:center;padding:6px 3px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15)}
.src-cell-l{font-size:8px;letter-spacing:1px;color:#556677;margin-bottom:2px}
.src-cell-v{font-size:11px;font-weight:600}
.src-cell-s{font-size:7px;margin-top:2px;letter-spacing:1px}
/* ═══ v1.2 VISUALIZATION STYLES ═══ */
.ts-chart-wrap{border:1px solid #1a2530;border-radius:2px;overflow:hidden;background:rgba(0,0,0,.25);margin-bottom:14px}
.ts-chart-wrap canvas{display:block;width:100%}
.ts-legend{display:flex;flex-wrap:wrap;gap:6px;padding:6px 10px;font-size:8px}
.ts-legend-item{display:flex;align-items:center;gap:4px;cursor:pointer;opacity:.8;transition:opacity .2s}
.ts-legend-item.active{opacity:1}
.ts-legend-item.muted{opacity:.25}
.ts-legend-dot{width:6px;height:6px;border-radius:1px}
.heatmap-wrap{border:1px solid #1a2530;border-radius:2px;overflow:hidden;background:#000;margin-bottom:14px;position:relative}
.heatmap-wrap canvas{display:block;width:100%}
.heatmap-scale{display:flex;align-items:center;gap:8px;padding:6px 10px;font-size:9px;color:#556677}
.heatmap-scale-bar{flex:1;height:8px;border-radius:1px;background:linear-gradient(90deg,#0044ff,#00ccff,#00ff88,#ffcc00,#ff4400)}
.profile-card{padding:12px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15);margin-bottom:6px;cursor:pointer;transition:all .2s}
.profile-card:hover{border-color:#00ffaa33;background:rgba(0,255,170,.02)}
.profile-card.selected{border-color:#00ffaa44;background:rgba(0,255,170,.04)}
.dash-stat{padding:12px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.2);text-align:center}
.dash-stat-v{font-size:24px;font-weight:600;font-variant-numeric:tabular-nums}
.dash-stat-l{font-size:8px;letter-spacing:2px;color:#556677;margin-top:4px}
.dash-stat-sub{font-size:9px;color:#334455;margin-top:2px}
.weight-slider{display:flex;align-items:center;gap:8px;padding:4px 0}
.weight-slider input[type=range]{flex:1;-webkit-appearance:none;height:4px;background:#1a2530;border-radius:2px;outline:none}
.weight-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;cursor:pointer}
.pl-timeline-row{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:9px}
.pl-timeline-bar{flex:1;height:16px;border-radius:1px;position:relative;overflow:hidden;background:#0a0f14}
.pl-timeline-seg{position:absolute;top:0;bottom:0;border-radius:1px;transition:all .3s}
.compare-overlay{position:relative}
.compare-a{opacity:.7}
.compare-b{opacity:.7}
.alert-badge{display:inline-block;padding:2px 6px;font-size:7px;letter-spacing:1.5px;font-weight:600;border-radius:2px;animation:pulse 2s infinite}
.alert-badge.warn{background:rgba(255,204,0,.1);border:1px solid rgba(255,204,0,.3);color:#ffcc00}
.alert-badge.crit{background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.3);color:#ff4444}
/* ═══ v1.3 PRECISION STYLES ═══ */
.quality-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:6px;margin-bottom:10px}
.quality-cell{padding:8px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.2)}
.quality-cell-h{font-size:8px;letter-spacing:1.5px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.quality-bar{height:5px;background:#0a0f14;border-radius:2px;overflow:hidden;margin:3px 0}
.quality-bar-fill{height:100%;border-radius:2px;transition:width .4s}
.quality-score{font-size:16px;font-weight:600;font-variant-numeric:tabular-nums}
.snr-gauge{display:flex;align-items:center;gap:6px;padding:6px 0;font-size:9px}
.snr-gauge-track{flex:1;height:8px;background:#0a0f14;border-radius:4px;overflow:hidden;position:relative}
.snr-gauge-fill{height:100%;border-radius:4px;transition:width .5s}
.snr-label{min-width:40px;text-align:right;font-variant-numeric:tabular-nums}
.crossval-panel{padding:10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.2);margin-bottom:8px}
.crossval-pair{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:9px;border-bottom:1px solid #0a0f14}
.crossval-badge{display:inline-block;padding:2px 6px;font-size:7px;letter-spacing:1px;font-weight:600;border-radius:2px}
.crossval-badge.agree{background:rgba(0,255,170,.1);border:1px solid rgba(0,255,170,.3);color:#00ffaa}
.crossval-badge.warn{background:rgba(255,204,0,.1);border:1px solid rgba(255,204,0,.3);color:#ffcc00}
.crossval-badge.conflict{background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.3);color:#ff4444;animation:pulse 1.5s infinite}
.migration-card{padding:10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15);margin-bottom:6px}
.migration-card.done{border-color:#00ffaa33;background:rgba(0,255,170,.02)}
.migration-card.partial{border-color:#ffcc0033;background:rgba(255,204,0,.02)}
.migration-card.todo{border-color:#1a2530}
.migration-label{font-size:8px;letter-spacing:1.5px;margin-bottom:4px;display:flex;justify-content:space-between}
.migration-step{font-size:8px;color:#556677;padding:2px 0;padding-left:12px;position:relative}
.migration-step::before{content:'›';position:absolute;left:0;color:#334455}
.migration-step.done::before{content:'✓';color:#00ffaa}
.multichirp-result{padding:8px;border:1px solid #1a2530;border-radius:2px;margin-bottom:4px;font-size:9px}
.multichirp-band{display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid #0a0f14}
.em-fp-canvas{border:1px solid #1a2530;border-radius:2px;display:block;width:100%;height:60px;background:#050810;margin-bottom:6px}
.path-loss-eq{font-family:'IBM Plex Mono',monospace;font-size:11px;color:#00ddff;padding:6px;background:rgba(0,221,255,.05);border:1px solid #00ddff22;border-radius:2px;text-align:center;margin-bottom:8px}
.noise-floor-bar{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:9px}
.precision-badge{display:inline-block;padding:2px 5px;font-size:7px;letter-spacing:1px;border-radius:2px;border:1px solid #00ffaa33;color:#00ffaa;background:rgba(0,255,170,.05)}
@media(max-width:600px){
  .log-h,.log-r{grid-template-columns:50px 40px 52px 54px 48px 50px 1fr;font-size:10px;padding:4px 6px}
  .st-v{font-size:14px}.hdr h1{font-size:16px;letter-spacing:2px}
  .em-grid{grid-template-columns:1fr}
  .layer-tab{padding:8px 3px;font-size:7px;letter-spacing:.5px;min-width:36px}
  .pkt-row{grid-template-columns:46px 28px 38px 50px 30px 22px 1fr;font-size:9px}
  .dash-stat-v{font-size:18px}
  .quality-grid{grid-template-columns:1fr 1fr}
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.5 APPLICATION STYLES                                   */
/* ═══════════════════════════════════════════════════════════ */
/* Midbrain / 4-layer architecture */
.brain-layer{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:2px;margin-bottom:4px;border:1px solid;transition:all .3s;position:relative;overflow:hidden}
.brain-layer::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.brain-layer.L3{background:rgba(0,255,170,.04);border-color:#00ffaa33}
.brain-layer.L3::before{background:#00ffaa}
.brain-layer.L2{background:rgba(0,221,255,.04);border-color:#00ddff33}
.brain-layer.L2::before{background:#00ddff}
.brain-layer.L1{background:rgba(255,204,0,.04);border-color:#ffcc0033}
.brain-layer.L1::before{background:#ffcc00}
.brain-layer.L0{background:rgba(204,102,255,.04);border-color:#cc66ff33}
.brain-layer.L0::before{background:#cc66ff}
.brain-layer-id{font-size:9px;letter-spacing:2px;min-width:22px;font-weight:700}
.brain-layer-name{font-size:10px;font-weight:600;flex:1}
.brain-layer-status{font-size:9px;letter-spacing:1.5px;padding:3px 8px;border-radius:1px}
.brain-flow{text-align:center;font-size:10px;color:#334455;padding:2px 0;letter-spacing:1px}
.mode-badge{display:inline-block;padding:6px 16px;font-size:11px;font-weight:700;letter-spacing:3px;border-radius:2px;margin-bottom:8px}
.mode-NOMINAL{background:rgba(0,255,170,.1);border:1px solid #00ffaa44;color:#00ffaa}
.mode-ALERT{background:rgba(255,204,0,.1);border:1px solid #ffcc0044;color:#ffcc00;animation:pulse .8s infinite}
.mode-CRITICAL{background:rgba(255,80,0,.1);border:1px solid #ff500044;color:#ff5000;animation:pulse .5s infinite}
.mode-EMERGENCY{background:rgba(255,0,0,.15);border:1px solid #ff0000;color:#ff0000;animation:pulse .3s infinite}
.reflex-log{max-height:120px;overflow:auto;font-size:9px;letter-spacing:.5px}
.reflex-entry{padding:3px 6px;border-bottom:1px solid #0a0f14;display:flex;align-items:center;gap:6px;animation:fadeIn .2s ease}
.reflex-entry.pass{color:#00ffaa88}
.reflex-entry.block{color:#ff4444}
.reflex-entry.gate{color:#ffcc00}
.salience-queue{display:flex;flex-wrap:wrap;gap:4px;min-height:20px;padding:4px}
.salience-tag{padding:2px 8px;font-size:8px;border-radius:1px;letter-spacing:1px}
.cerebrum-panel{padding:12px;background:rgba(0,255,170,.03);border:1px solid #00ffaa22;border-radius:2px;margin-bottom:8px}
.cerebrum-thinking{display:flex;align-items:center;gap:6px;font-size:9px;color:#556677}
.cerebrum-response{font-size:11px;color:#aabbcc;line-height:1.8;white-space:pre-wrap;font-family:'IBM Plex Mono',monospace}
.cerebrum-meta{font-size:8px;color:#445566;margin-top:6px;display:flex;gap:12px;flex-wrap:wrap}
.cerebrum-spinner{width:12px;height:12px;border:2px solid #00ffaa22;border-top-color:#00ffaa;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ss-zone{padding:10px 12px;border-radius:2px;margin-bottom:6px;border:1px solid;position:relative}
.ss-zone.SAFE{border-color:#00ffaa33;background:rgba(0,255,170,.04)}
.ss-zone.CAUTION{border-color:#ffcc0033;background:rgba(255,204,0,.04)}
.ss-zone.DANGER{border-color:#ff500033;background:rgba(255,80,0,.06)}
.ss-zone.EXCLUSION{border-color:#ff000044;background:rgba(255,0,0,.08)}
.ss-zone-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.ss-zone-name{font-size:11px;font-weight:600}
.ss-zone-badge{padding:2px 8px;font-size:8px;letter-spacing:2px;border-radius:1px}
.ss-worker{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid #0a0f14;font-size:10px}
.ss-alert{padding:8px 12px;border-radius:2px;margin-bottom:4px;display:flex;align-items:flex-start;gap:8px;font-size:10px;line-height:1.5}
.ss-alert.WARN{background:rgba(255,204,0,.1);border:1px solid #ffcc0044;color:#ffcc00}
.ss-alert.DANGER{background:rgba(255,80,0,.1);border:1px solid #ff500044;color:#ff8844}
.ss-alert.CRIT{background:rgba(255,0,0,.15);border:1px solid #ff000044;color:#ff4444;animation:pulse .4s infinite}
.ss-report-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.ss-report-card{padding:8px;border:1px solid #1a2530;border-radius:2px;text-align:center}
.ss-report-val{font-size:20px;font-weight:700;font-variant-numeric:tabular-nums}
.ss-report-lbl{font-size:8px;letter-spacing:1.5px;color:#556677;margin-top:2px}
.ky-log{max-height:160px;overflow:auto}
.ky-entry{padding:5px 8px;border-bottom:1px solid #0a0f14;font-size:9px;display:flex;gap:8px;animation:fadeIn .3s ease}
.ky-time{color:#556677;min-width:55px;flex-shrink:0}
.ky-sev{min-width:44px;font-weight:700;flex-shrink:0}
.ky-msg{color:#aabbcc;flex:1}
.patent-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.patent-metric{text-align:center;padding:10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15)}
.patent-metric-val{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums}
.patent-metric-lbl{font-size:8px;letter-spacing:1.5px;color:#556677;margin-top:2px}
.patent-metric-target{font-size:7px;color:#445566;margin-top:2px}
.patent-metric.pass .patent-metric-val{color:#00ffaa}
.patent-metric.warn .patent-metric-val{color:#ffcc00}
.patent-metric.fail .patent-metric-val{color:#ff4444}
.demo-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,10,20,.94);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
.demo-card{max-width:480px;width:100%;background:#0d1520;border:1px solid #00ffaa44;border-radius:4px;padding:24px}
.demo-step{font-size:9px;color:#556677;letter-spacing:2px;margin-bottom:6px}
.demo-title{font-size:18px;color:#00ffaa;font-weight:700;letter-spacing:2px;margin-bottom:10px;line-height:1.3}
.demo-desc{font-size:11px;color:#8899aa;line-height:1.8;margin-bottom:16px}
.demo-progress{display:flex;gap:4px;margin-bottom:16px}
.demo-pip{height:3px;flex:1;border-radius:1px;background:#1a2530;transition:background .3s}
.demo-pip.done{background:#00ffaa}
.demo-pip.active{background:#00ffaa}
.demo-nav{display:flex;gap:8px;justify-content:space-between}
.emb-constraint{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #0a0f14;font-size:9px}
.emb-ok{color:#00ffaa}
.emb-warn{color:#ffcc00}
.emb-viol{color:#ff4444}
.card{margin-bottom:8px;padding:10px;border:1px solid #1a2530;border-radius:2px;background:rgba(0,0,0,.15)}
.dash-stat{padding:6px;background:#0a0f14;border-radius:2px;text-align:center}
</style>
</head>
<body>
<div class="scan"></div>
<div class="ctn" id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
<script>
/* ═══ Minimal QR Code Generator (qrcode-generator by kazuhikoarase) ═══ */
/* MIT License — inlined for single-file deployment */
var qrcode=function(){var qrcode=function(typeNumber,errorCorrectionLevel){var PAD0=0xEC,PAD1=0x11,_typeNumber=typeNumber,_errorCorrectionLevel=QRErrorCorrectionLevel[errorCorrectionLevel],_modules=null,_moduleCount=0,_dataCache=null,_dataList=[],_this={},_test=function(row,col){return _modules[row][col]},_getModuleCount=function(){return _moduleCount};_this.addData=function(data,mode){mode=mode||'Byte';var newData=null;switch(mode){case'Numeric':newData=qrNumber(data);break;case'Alphanumeric':newData=qrAlphaNum(data);break;case'Byte':newData=qr8BitByte(data);break;default:throw'mode:'+mode;}_dataList.push(newData);_dataCache=null;};_this.isDark=function(row,col){if(row<0||_moduleCount<=row||col<0||_moduleCount<=col)throw row+','+col;return _modules[row][col];};_this.getModuleCount=_getModuleCount;_this.make=function(){if(_typeNumber<1){var typeNumber=1;for(;typeNumber<40;typeNumber++){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,_errorCorrectionLevel);var buffer=qrBitBuffer();for(var i=0;i<_dataList.length;i++){var data=_dataList[i];buffer.put(data.getMode(),4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.getMode(),typeNumber));data.write(buffer);}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i++)totalDataCount+=rsBlocks[i].dataCount;if(buffer.getLengthInBits()<=totalDataCount*8)break;}_typeNumber=typeNumber;}_makeImpl(false,_getBestMaskPattern());};_this.createDataURL=function(cellSize,margin){cellSize=cellSize||2;margin=typeof margin=='undefined'?cellSize*4:margin;var size=_moduleCount*cellSize+margin*2;var cv=document.createElement('canvas');cv.width=size;cv.height=size;var ctx=cv.getContext('2d');ctx.fillStyle='#0a0f14';ctx.fillRect(0,0,size,size);ctx.fillStyle='#00ffaa';for(var r=0;r<_moduleCount;r++)for(var c=0;c<_moduleCount;c++)if(_this.isDark(r,c))ctx.fillRect(c*cellSize+margin,r*cellSize+margin,cellSize,cellSize);return cv.toDataURL('image/png');};var _makeImpl=function(test,maskPattern){_moduleCount=_typeNumber*4+17;_modules=function(mc){var m=[];for(var r=0;r<mc;r++){m.push([]);for(var c=0;c<mc;c++)m[r].push(null);}return m;}(_moduleCount);_setupPositionProbePattern(0,0);_setupPositionProbePattern(_moduleCount-7,0);_setupPositionProbePattern(0,_moduleCount-7);_setupPositionAdjustPattern();_setupTimingPattern();_setupTypeInfo(test,maskPattern);if(_typeNumber>=7)_setupTypeNumber(test);if(_dataCache==null)_dataCache=_createData(_typeNumber,_errorCorrectionLevel,_dataList);_mapData(_dataCache,maskPattern);};var _setupPositionProbePattern=function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||_moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||_moduleCount<=col+c)continue;if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4))_modules[row+r][col+c]=true;else _modules[row+r][col+c]=false;}}};var _getBestMaskPattern=function(){var minLostPoint=0,pattern=0;for(var i=0;i<8;i++){_makeImpl(true,i);var lostPoint=QRUtil.getLostPoint(_this);if(i==0||minLostPoint>lostPoint){minLostPoint=lostPoint;pattern=i;}}return pattern;};var _setupTimingPattern=function(){for(var r=8;r<_moduleCount-8;r++){if(_modules[r][6]!=null)continue;_modules[r][6]=(r%2==0);}for(var c=8;c<_moduleCount-8;c++){if(_modules[6][c]!=null)continue;_modules[6][c]=(c%2==0);}};var _setupPositionAdjustPattern=function(){var pos=QRUtil.getPatternPosition(_typeNumber);for(var i=0;i<pos.length;i++)for(var j=0;j<pos.length;j++){var row=pos[i],col=pos[j];if(_modules[row][col]!=null)continue;for(var r=-2;r<=2;r++)for(var c=-2;c<=2;c++){if(r==-2||r==2||c==-2||c==2||(r==0&&c==0))_modules[row+r][col+c]=true;else _modules[row+r][col+c]=false;}}};var _setupTypeNumber=function(test){var bits=QRUtil.getBCHTypeNumber(_typeNumber);for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);_modules[Math.floor(i/3)][i%3+_moduleCount-8-3]=mod;_modules[i%3+_moduleCount-8-3][Math.floor(i/3)]=mod;}};var _setupTypeInfo=function(test,maskPattern){var data=(_errorCorrectionLevel<<3)|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=(!test&&((bits>>i)&1)==1);if(i<6)_modules[i][8]=mod;else if(i<8)_modules[i+1][8]=mod;else _modules[_moduleCount-15+i][8]=mod;if(i<8)_modules[8][_moduleCount-i-1]=mod;else if(i<9)_modules[8][15-i-1+1]=mod;else _modules[8][15-i-1]=mod;}_modules[_moduleCount-8][8]=(!test);};var _mapData=function(data,maskPattern){var inc=-1,row=_moduleCount-1,bitIndex=7,byteIndex=0,maskFunc=QRUtil.getMaskFunction(maskPattern);for(var col=_moduleCount-1;col>0;col-=2){if(col==6)col--;while(true){for(var c=0;c<2;c++){if(_modules[row][col-c]==null){var dark=false;if(byteIndex<data.length)dark=(((data[byteIndex]>>>bitIndex)&1)==1);if(maskFunc(row,col-c))dark=!dark;_modules[row][col-c]=dark;bitIndex--;if(bitIndex==-1){byteIndex++;bitIndex=7;}}}row+=inc;if(row<0||_moduleCount<=row){row-=inc;inc=-inc;break;}}}};var _createData=function(typeNumber,errorCorrectionLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectionLevel);var buffer=qrBitBuffer();for(var i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(data.getMode(),4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.getMode(),typeNumber));data.write(buffer);}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i++)totalDataCount+=rsBlocks[i].dataCount;if(buffer.getLengthInBits()>totalDataCount*8)throw'code length overflow.';if(buffer.getLengthInBits()+4<=totalDataCount*8)buffer.put(0,4);while(buffer.getLengthInBits()%8!=0)buffer.putBit(false);while(true){if(buffer.getLengthInBits()>=totalDataCount*8)break;buffer.put(PAD0,8);if(buffer.getLengthInBits()>=totalDataCount*8)break;buffer.put(PAD1,8);}return _createBytes(buffer,rsBlocks);};var _createBytes=function(buffer,rsBlocks){var offset=0,maxDcCount=0,maxEcCount=0,dcdata=[],ecdata=[];for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount,ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);dcdata[r]=[];for(var i=0;i<dcCount;i++)dcdata[r][i]=0xff&buffer.getByte(i+offset);offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var rawPoly=qrPolynomial(dcdata[r],rsPoly.getLength()-1);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=[];for(var i=0;i<rsPoly.getLength()-1;i++){var modIndex=i+modPoly.getLength()-rsPoly.getLength()+1;ecdata[r][i]=(modIndex>=0)?modPoly.getAt(modIndex):0;}}var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i++)totalCodeCount+=rsBlocks[i].totalCount;var data=[];var index=0;for(var i=0;i<maxDcCount;i++)for(var r=0;r<rsBlocks.length;r++)if(i<dcdata[r].length)data[index++]=dcdata[r][i];for(var i=0;i<maxEcCount;i++)for(var r=0;r<rsBlocks.length;r++)if(i<ecdata[r].length)data[index++]=ecdata[r][i];return data;};return _this;};qrcode.stringToBytesFuncs={'default':function(s){var b=[];for(var i=0;i<s.length;i++){var c=s.charCodeAt(i);if(c<0x80)b.push(c);else if(c<0x800){b.push(0xc0|(c>>6));b.push(0x80|(c&0x3f));}else{b.push(0xe0|(c>>12));b.push(0x80|((c>>6)&0x3f));b.push(0x80|(c&0x3f));}}return b;}};qrcode.stringToBytes=qrcode.stringToBytesFuncs['default'];var QRMode={MODE_NUMBER:1<<0,MODE_ALPHA_NUM:1<<1,MODE_8BIT_BYTE:1<<2};var QRErrorCorrectionLevel={L:1,M:0,Q:3,H:2};var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var QRUtil=function(){var PATTERN_POSITION_TABLE=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]];var G15=(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0);var G18=(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0);var G15_MASK=(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1);var _this={};var getBCHDigit=function(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;};_this.getBCHTypeInfo=function(data){var d=data<<10;while(getBCHDigit(d)-getBCHDigit(G15)>=0)d^=(G15<<(getBCHDigit(d)-getBCHDigit(G15)));return((data<<10)|d)^G15_MASK;};_this.getBCHTypeNumber=function(data){var d=data<<12;while(getBCHDigit(d)-getBCHDigit(G18)>=0)d^=(G18<<(getBCHDigit(d)-getBCHDigit(G18)));return(data<<12)|d;};_this.getPatternPosition=function(typeNumber){return PATTERN_POSITION_TABLE[typeNumber-1];};_this.getMaskFunction=function(maskPattern){switch(maskPattern){case 0:return function(i,j){return(i+j)%2==0;};case 1:return function(i,j){return i%2==0;};case 2:return function(i,j){return j%3==0;};case 3:return function(i,j){return(i+j)%3==0;};case 4:return function(i,j){return(Math.floor(i/2)+Math.floor(j/3))%2==0;};case 5:return function(i,j){return(i*j)%2+(i*j)%3==0;};case 6:return function(i,j){return((i*j)%2+(i*j)%3)%2==0;};case 7:return function(i,j){return((i*j)%3+(i+j)%2)%2==0;};default:throw'bad maskPattern';}};_this.getErrorCorrectPolynomial=function(ecL){var a=qrPolynomial([1],0);for(var i=0;i<ecL;i++)a=a.multiply(qrPolynomial([1,QRMath.gexp(i)],0));return a;};_this.getLengthInBits=function(mode,type){if(type<10)switch(mode){case 1:return 10;case 2:return 9;case 4:return 8;default:throw'mode:'+mode;}else if(type<27)switch(mode){case 1:return 12;case 2:return 11;case 4:return 16;default:throw'mode:'+mode;}else switch(mode){case 1:return 14;case 2:return 13;case 4:return 16;default:throw'mode:'+mode;}};_this.getLostPoint=function(qr){var mc=qr.getModuleCount(),lp=0;for(var row=0;row<mc;row++)for(var col=0;col<mc;col++){var sc=0,dk=qr.isDark(row,col);for(var r=-1;r<=1;r++){if(row+r<0||mc<=row+r)continue;for(var c=-1;c<=1;c++){if(col+c<0||mc<=col+c)continue;if(r==0&&c==0)continue;if(dk==qr.isDark(row+r,col+c))sc++;}}if(sc>5)lp+=(3+sc-5);}for(var row=0;row<mc-1;row++)for(var col=0;col<mc-1;col++){var cnt=0;if(qr.isDark(row,col))cnt++;if(qr.isDark(row+1,col))cnt++;if(qr.isDark(row,col+1))cnt++;if(qr.isDark(row+1,col+1))cnt++;if(cnt==0||cnt==4)lp+=3;}for(var row=0;row<mc;row++)for(var col=0;col<mc-6;col++)if(qr.isDark(row,col)&&!qr.isDark(row,col+1)&&qr.isDark(row,col+2)&&qr.isDark(row,col+3)&&qr.isDark(row,col+4)&&!qr.isDark(row,col+5)&&qr.isDark(row,col+6))lp+=40;for(var col=0;col<mc;col++)for(var row=0;row<mc-6;row++)if(qr.isDark(row,col)&&!qr.isDark(row+1,col)&&qr.isDark(row+2,col)&&qr.isDark(row+3,col)&&qr.isDark(row+4,col)&&!qr.isDark(row+5,col)&&qr.isDark(row+6,col))lp+=40;var dc=0;for(var col=0;col<mc;col++)for(var row=0;row<mc;row++)if(qr.isDark(row,col))dc++;lp+=Math.abs(100*dc/mc/mc-50)/5*10;return lp;};return _this;}();var QRMath=function(){var EXP_TABLE=new Array(256),LOG_TABLE=new Array(256);for(var i=0;i<8;i++)EXP_TABLE[i]=1<<i;for(var i=8;i<256;i++)EXP_TABLE[i]=EXP_TABLE[i-4]^EXP_TABLE[i-5]^EXP_TABLE[i-6]^EXP_TABLE[i-8];for(var i=0;i<255;i++)LOG_TABLE[EXP_TABLE[i]]=i;var _this={};_this.glog=function(n){return LOG_TABLE[n];};_this.gexp=function(n){while(n<0)n+=255;while(n>=256)n-=255;return EXP_TABLE[n];};return _this;}();function qrPolynomial(num,shift){var _num=function(){var offset=0;while(offset<num.length&&num[offset]==0)offset++;var _n=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)_n[i]=num[i+offset];return _n;}();var _this={};_this.getAt=function(i){return _num[i];};_this.getLength=function(){return _num.length;};_this.multiply=function(e){var n=new Array(_this.getLength()+e.getLength()-1);for(var i=0;i<_this.getLength();i++)for(var j=0;j<e.getLength();j++)n[i+j]^=QRMath.gexp(QRMath.glog(_this.getAt(i))+QRMath.glog(e.getAt(j)));return qrPolynomial(n,0);};_this.mod=function(e){if(_this.getLength()-e.getLength()<0)return _this;var ratio=QRMath.glog(_this.getAt(0))-QRMath.glog(e.getAt(0));var n=new Array(_this.getLength());for(var i=0;i<_this.getLength();i++)n[i]=_this.getAt(i);for(var i=0;i<e.getLength();i++)n[i]^=QRMath.gexp(QRMath.glog(e.getAt(i))+ratio);return qrPolynomial(n,0).mod(e);};return _this;}
var QRRSBlock=function(){var RS=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16]];var qrRSBlock=function(t,d){return{totalCount:t,dataCount:d};};var _this={};_this.getRSBlocks=function(tn,ecl){var rsBlock;switch(ecl){case 1:rsBlock=RS[(tn-1)*4+0];break;case 0:rsBlock=RS[(tn-1)*4+1];break;case 3:rsBlock=RS[(tn-1)*4+2];break;case 2:rsBlock=RS[(tn-1)*4+3];break;}if(!rsBlock)throw'bad rs block';var len=rsBlock.length/3,list=[];for(var i=0;i<len;i++){var count=rsBlock[i*3+0],tc=rsBlock[i*3+1],dc=rsBlock[i*3+2];for(var j=0;j<count;j++)list.push(qrRSBlock(tc,dc));}return list;};return _this;}();var qrBitBuffer=function(){var _buffer=[],_length=0;var _this={};_this.getBuffer=function(){return _buffer;};_this.getAt=function(i){return((_buffer[Math.floor(i/8)]>>>(7-i%8))&1)==1;};_this.put=function(num,len){for(var i=0;i<len;i++)_this.putBit(((num>>>(len-i-1))&1)==1);};_this.getLengthInBits=function(){return _length;};_this.putBit=function(bit){var bi=Math.floor(_length/8);if(_buffer.length<=bi)_buffer.push(0);if(bit)_buffer[bi]|=(0x80>>>(_length%8));_length++;};_this.getByte=function(i){return _buffer[i];};return _this;};var qr8BitByte=function(data){var _bytes=qrcode.stringToBytes(data);return{getMode:function(){return 4;},getLength:function(){return _bytes.length;},write:function(buf){for(var i=0;i<_bytes.length;i++)buf.put(_bytes[i],8);}};};var qrNumber=function(data){return{getMode:function(){return 1;},getLength:function(){return data.length;},write:function(buf){var i=0;while(i+2<data.length){buf.put(parseInt(data.substring(i,i+3)),10);i+=3;}if(data.length-i==1)buf.put(parseInt(data.substring(i,i+1)),4);else if(data.length-i==2)buf.put(parseInt(data.substring(i,i+2)),7);}};};var qrAlphaNum=function(data){var getCode=function(c){if('0'<=c&&c<='9')return c.charCodeAt(0)-48;if('A'<=c&&c<='Z')return c.charCodeAt(0)-55;switch(c){case' ':return 36;case'$':return 37;case'%':return 38;case'*':return 39;case'+':return 40;case'-':return 41;case'.':return 42;case'/':return 43;case':':return 44;default:throw'illegal char';}};return{getMode:function(){return 2;},getLength:function(){return data.length;},write:function(buf){var i=0;while(i+1<data.length){buf.put(getCode(data.charAt(i))*45+getCode(data.charAt(i+1)),11);i+=2;}if(i<data.length)buf.put(getCode(data.charAt(i)),6);}};};return qrcode;}();
</script>
<script>
"use strict";
var h=React.createElement,useState=React.useState,useRef=React.useRef,useCallback=React.useCallback,useEffect=React.useEffect,useMemo=React.useMemo;

/* ═══════════════════════════════════════════════════════════ */
/*  SIGNALS & CORE DSP (v1.1 — unchanged)                     */
/* ═══════════════════════════════════════════════════════════ */
var SIGNALS={
  chirp_pro:{id:'chirp_pro',name:'CHIRP PRO',desc:'1→5kHz/30ms',type:'chirp',f1:1000,f2:5000,dur:.030,color:'#00ffaa'},
  chirp_mid:{id:'chirp_mid',name:'CHIRP MID',desc:'1.5→2.5kHz/20ms',type:'chirp',f1:1500,f2:2500,dur:.020,color:'#00ddff'},
  chirp_low:{id:'chirp_low',name:'CHIRP LOW',desc:'500→1.5kHz/30ms',type:'chirp',f1:500,f2:1500,dur:.030,color:'#ff8800'},
  chirp_high:{id:'chirp_high',name:'CHIRP HIGH',desc:'3→6kHz/15ms',type:'chirp',f1:3000,f2:6000,dur:.015,color:'#00ddff'},
  chirp_wide:{id:'chirp_wide',name:'CHIRP WIDE',desc:'800→4kHz/25ms',type:'chirp',f1:800,f2:4000,dur:.025,color:'#ffcc00'},
  pulse_2k:{id:'pulse_2k',name:'PULSE 2kHz',desc:'2kHz/15ms',type:'tone',freq:2000,dur:.015,color:'#cc66ff'},
  click:{id:'click',name:'CLICK',desc:'符号化/10ms',type:'click',dur:.010,color:'#ff4466'}
};
var SIG_ORDER=['chirp_pro','chirp_mid','chirp_low','chirp_high','chirp_wide','pulse_2k','click'];
function genSignal(sig,sr){var amp=CFG.sigAmplitude||.85;var N=Math.floor(sr*sig.dur),b=new Float32Array(N);if(sig.type==='chirp')for(var i=0;i<N;i++){var t=i/sr;b[i]=Math.sin(2*Math.PI*(sig.f1*t+(sig.f2-sig.f1)*t*t/(2*sig.dur)))*amp*(1-Math.cos(2*Math.PI*i/(N-1)));}else if(sig.type==='tone')for(var i=0;i<N;i++){var t=i/sr;b[i]=Math.sin(2*Math.PI*sig.freq*t)*amp*(1-Math.cos(2*Math.PI*i/(N-1)));}else{var fc=2500;for(var i=0;i<N;i++){var t=i/sr;b[i]=Math.sin(2*Math.PI*fc*t*(1+.5*t/sig.dur))*Math.exp(-Math.pow((i-N/2)/(N/5),2))*amp*2;}}return b;}
var CFG={sr:44100,listenMs:800,bufSize:256,blanking:2,maxThresh:.45,minConf:.003,histMax:128,burstCount:3,burstGap:80,kalmanQ:.08,kalmanR:2.5,rollingWindow:12,outlierK:2.2,speedOfSound:343.0,loopbackMarginMs:5,sigAmplitude:.85,maxLoopbackMs:20,defaultLoopbackMs:4,tsMaxPoints:1000};

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: MULTI-CHIRP BAND DEFINITIONS                        */
/* ═══════════════════════════════════════════════════════════ */
var CHIRP_BANDS=[
  {id:'low', name:'LOW',  f1:500,  f2:2000, dur:.035, color:'#ff8800', desc:'500→2kHz / 35ms'},
  {id:'mid', name:'MID',  f1:2000, f2:6000, dur:.025, color:'#00ffaa', desc:'2→6kHz / 25ms'},
  {id:'high',name:'HIGH', f1:6000, f2:12000,dur:.015, color:'#cc66ff', desc:'6→12kHz / 15ms'}
];

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: NOISE FLOOR ESTIMATION                              */
/* ═══════════════════════════════════════════════════════════ */
function estimateNoiseFloor(buf){
  /* RMS of entire buffer */
  var sum=0;for(var i=0;i<buf.length;i++)sum+=buf[i]*buf[i];
  var rms=Math.sqrt(sum/buf.length);
  /* Percentile-based noise estimate (10th percentile of absolute values) */
  var abs=new Float32Array(buf.length);for(var i=0;i<buf.length;i++)abs[i]=Math.abs(buf[i]);
  var sorted=Array.from(abs).sort(function(a,b){return a-b;});
  var p10=sorted[Math.floor(sorted.length*0.1)];
  return{rms:rms,noiseFloor:p10,dB:p10>0?20*Math.log10(p10):-80};
}
function computeSNR(signalPeakVal,noiseFloor){
  if(!noiseFloor||noiseFloor<=0)return 40;/* fallback */
  var ratio=signalPeakVal/noiseFloor;
  return 20*Math.log10(Math.max(ratio,1));
}
function adaptiveThreshold(noiseFloor,baseConf){
  /* Scale confidence threshold based on ambient noise */
  var noiseFactor=Math.min(1,noiseFloor/0.01);/* normalize */
  return Math.max(baseConf,baseConf+noiseFactor*0.02);
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: MULTI-CHIRP HOOK                                    */
/* ═══════════════════════════════════════════════════════════ */
function useMultiChirp(){
  var _r=useState(null),results=_r[0],setResults=_r[1];
  var _m=useState(false),measuring=_m[0],setMeasuring=_m[1];
  var _n=useState(null),noiseData=_n[0],setNoiseData=_n[1];
  var _p=useState(0),progress=_p[0],setProgress=_p[1];
  var audioCtxRef=useRef(null);

  var measureBand=useCallback(function(band,loopbackMs,audioCtx){
    return new Promise(function(resolve){
      var sig={id:band.id,type:'chirp',f1:band.f1,f2:band.f2,dur:band.dur};
      var sr=audioCtx.sampleRate;
      var refBuf=genSignal(sig,sr);
      navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}}).then(function(stream){
        var src=audioCtx.createMediaStreamSource(stream);
        var proc=audioCtx.createScriptProcessor(4096,1,1);
        var chunks=[];
        proc.onaudioprocess=function(ev){chunks.push(new Float32Array(ev.inputBuffer.getChannelData(0)));};
        src.connect(proc);proc.connect(audioCtx.destination);
        /* Play chirp */
        var abuf=audioCtx.createBuffer(1,refBuf.length,sr);abuf.getChannelData(0).set(refBuf);
        var sn=audioCtx.createBufferSource();sn.buffer=abuf;sn.connect(audioCtx.destination);sn.start();
        /* Record for listenMs */
        setTimeout(function(){
          try{proc.disconnect();src.disconnect();stream.getTracks().forEach(function(t){t.stop();});}catch(e){}
          var rec=flat(chunks);
          var nf=estimateNoiseFloor(rec);
          var blankMs=sanitizeLoopback(loopbackMs)+CFG.loopbackMarginMs;
          var xc=xcorr(rec,refBuf,sr,blankMs);
          var snr=computeSNR(xc.peakVal,nf.noiseFloor);
          var th=adaptiveThreshold(nf.noiseFloor,CFG.minConf);
          var distM=null;
          if(xc.peakVal>=th){
            distM=Math.max(0,(xc.refinedLag/sr)*CFG.speedOfSound);
          }
          resolve({band:band,distM:distM,conf:xc.peakVal,snr:snr,noiseFloor:nf,valid:xc.peakVal>=th,corr:xc.corr,peakVal:xc.peakVal});
        },CFG.listenMs);
      }).catch(function(e){resolve({band:band,distM:null,conf:0,snr:0,noiseFloor:{rms:0,noiseFloor:0,dB:-80},valid:false,error:e.message});});
    });
  },[]);

  var runMultiChirp=useCallback(function(loopbackMs){
    if(measuring)return Promise.resolve(null);
    setMeasuring(true);setResults(null);setProgress(0);
    var ac=audioCtxRef.current||new(window.AudioContext||window.webkitAudioContext)({sampleRate:CFG.sr});
    audioCtxRef.current=ac;
    if(ac.state==='suspended')ac.resume();
    /* Measure noise floor first */
    return new Promise(function(resolve){
      navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}}).then(function(stream){
        var src=ac.createMediaStreamSource(stream);var proc=ac.createScriptProcessor(4096,1,1);var chunks=[];
        proc.onaudioprocess=function(ev){chunks.push(new Float32Array(ev.inputBuffer.getChannelData(0)));};
        src.connect(proc);proc.connect(ac.destination);
        setTimeout(function(){
          try{proc.disconnect();src.disconnect();stream.getTracks().forEach(function(t){t.stop();});}catch(e){}
          var rec=flat(chunks);
          var nf=estimateNoiseFloor(rec);
          setNoiseData(nf);
          /* Now measure each band sequentially with gap */
          var bandResults=[];
          var doNext=function(idx){
            if(idx>=CHIRP_BANDS.length){
              /* Aggregate */
              var validResults=bandResults.filter(function(r){return r.valid&&r.distM!=null;});
              var finalDist=null,finalConf=0;
              if(validResults.length>0){
                /* Confidence-weighted average */
                var wSum=0,dSum=0;
                validResults.forEach(function(r){wSum+=r.conf;dSum+=r.distM*r.conf;});
                finalDist=dSum/wSum;finalConf=wSum/validResults.length;
              }
              var agg={bands:bandResults,distM:finalDist,conf:finalConf,noiseFloor:nf,validCount:validResults.length,agreement:computeBandAgreement(validResults)};
              setResults(agg);setMeasuring(false);setProgress(0);
              resolve(agg);
            }else{
              setProgress(Math.round((idx/CHIRP_BANDS.length)*100));
              setTimeout(function(){
                measureBand(CHIRP_BANDS[idx],loopbackMs,ac).then(function(r){
                  bandResults.push(r);doNext(idx+1);
                });
              },idx===0?0:150);/* 150ms gap between bands */
            }
          };
          doNext(0);
        },100);/* 100ms noise floor sample */
      }).catch(function(e){setMeasuring(false);resolve(null);});
    });
  },[measuring,measureBand]);

  return{results:results,measuring:measuring,noiseData:noiseData,progress:progress,runMultiChirp:runMultiChirp};
}

function computeBandAgreement(validResults){
  if(validResults.length<2)return{score:1,stdDev:0,maxDiff:0};
  var dists=validResults.map(function(r){return r.distM;});
  var mean=dists.reduce(function(s,v){return s+v;},0)/dists.length;
  var variance=dists.reduce(function(s,v){return s+(v-mean)*(v-mean);},0)/dists.length;
  var stdDev=Math.sqrt(variance);
  var maxDiff=Math.max.apply(null,dists)-Math.min.apply(null,dists);
  /* Score: 1 = perfect agreement, 0 = >20cm disagreement */
  var score=Math.max(0,1-maxDiff/0.20);
  return{score:score,stdDev:stdDev,maxDiff:maxDiff,mean:mean};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: EM FIELD FINGERPRINT                                */
/* ═══════════════════════════════════════════════════════════ */
function useEMFingerprint(){
  var _fp=useState(null),fingerprint=_fp[0],setFingerprint=_fp[1];
  var _rec=useState(false),recording=_rec[0],setRecording=_rec[1];
  var _sim=useState(null),similarity=_sim[0],setSimilarity=_sim[1];
  var samplesRef=useRef([]);
  var timerRef=useRef(null);

  var startCapture=useCallback(function(magGetter){
    if(recording)return;
    setRecording(true);samplesRef.current=[];
    timerRef.current=setInterval(function(){
      var v=magGetter();
      if(v)samplesRef.current.push({x:v.x,y:v.y,z:v.z,mag:v.mag,ts:Date.now()});
      if(samplesRef.current.length>=30){
        clearInterval(timerRef.current);
        var fp=buildFingerprint(samplesRef.current);
        setFingerprint(fp);setRecording(false);
        dbPut(CALIB_STORE,Object.assign({key:'em_fingerprint'},fp));
      }
    },100);
  },[recording]);

  var stopCapture=useCallback(function(){
    if(timerRef.current)clearInterval(timerRef.current);
    setRecording(false);
  },[]);

  var compare=useCallback(function(currentMag){
    if(!fingerprint||!currentMag)return;
    var sim=fingerprintSimilarity(fingerprint,currentMag);
    setSimilarity(sim);
    return sim;
  },[fingerprint]);

  /* Load saved fingerprint on mount */
  useEffect(function(){
    dbGet(CALIB_STORE,'em_fingerprint').then(function(fp){if(fp)setFingerprint(fp);}).catch(function(){});
    return function(){if(timerRef.current)clearInterval(timerRef.current);};
  },[]);

  return{fingerprint:fingerprint,recording:recording,similarity:similarity,startCapture:startCapture,stopCapture:stopCapture,compare:compare,sampleCount:samplesRef.current.length};
}

function buildFingerprint(samples){
  var n=samples.length;
  var mx=samples.reduce(function(s,v){return s+v.x;},0)/n;
  var my=samples.reduce(function(s,v){return s+v.y;},0)/n;
  var mz=samples.reduce(function(s,v){return s+v.z;},0)/n;
  var mm=samples.reduce(function(s,v){return s+v.mag;},0)/n;
  /* Variance */
  var vx=samples.reduce(function(s,v){return s+(v.x-mx)*(v.x-mx);},0)/n;
  var vy=samples.reduce(function(s,v){return s+(v.y-my)*(v.y-my);},0)/n;
  var vz=samples.reduce(function(s,v){return s+(v.z-mz)*(v.z-mz);},0)/n;
  return{mean:{x:mx,y:my,z:mz,mag:mm},variance:{x:vx,y:vy,z:vz},samples:samples,ts:Date.now(),n:n};
}

function fingerprintSimilarity(fp,currentMag){
  if(!fp||!fp.mean)return 0;
  /* Euclidean distance in normalized XYZ space */
  var dx=(currentMag.x-fp.mean.x);var dy=(currentMag.y-fp.mean.y);var dz=(currentMag.z-fp.mean.z);
  var dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
  /* Normalize by expected variation (3 sigma of stored fingerprint) */
  var sigma=Math.sqrt(fp.variance.x+fp.variance.y+fp.variance.z)*3||5;
  return Math.max(0,Math.min(1,1-dist/Math.max(sigma,5)));
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: BLE PATH-LOSS CALIBRATION                          */
/* ═══════════════════════════════════════════════════════════ */
function useBLEPathLoss(){
  var _n=useState(2.0),pathLossN=_n[0],setN=_n[1];/* default free-space exponent */
  var _r0=useState(-59),rssiAt1m=_r0[0],setRssi0=_r0[1];/* RSSI at 1m reference */
  var _calib=useState(null),calibration=_calib[0],setCalib=_calib[1];

  var calibrate=useCallback(function(rssiSamples,knownDistM){
    /* rssiSamples: array of RSSI dBm values at knownDistM */
    if(!rssiSamples||!rssiSamples.length||!knownDistM)return;
    var avgRSSI=rssiSamples.reduce(function(s,v){return s+v;},0)/rssiSamples.length;
    /* RSSI_0 = avgRSSI + 10n*log10(d/1) but we don't know n yet */
    /* Use reference: RSSI_0 = RSSI_measured + 10*n*log10(d) with n=2 initial */
    var rssi0=avgRSSI+10*pathLossN*Math.log10(Math.max(knownDistM,0.1));
    setRssi0(rssi0);
    setCalib({rssiAt1m:rssi0,n:pathLossN,knownDist:knownDistM,avgRSSI:avgRSSI,ts:Date.now()});
    dbPut(CALIB_STORE,{key:'ble_pathloss',rssiAt1m:rssi0,n:pathLossN,ts:Date.now()});
  },[pathLossN]);

  var rssiToDistance=useCallback(function(rssi){
    /* d = 10^((RSSI_0 - RSSI) / (10*n)) */
    return Math.pow(10,(rssiAt1m-rssi)/(10*pathLossN));
  },[rssiAt1m,pathLossN]);

  /* Load saved calibration */
  useEffect(function(){
    dbGet(CALIB_STORE,'ble_pathloss').then(function(c){
      if(c){setRssi0(c.rssiAt1m);setN(c.n||2.0);setCalib(c);}
    }).catch(function(){});
  },[]);

  return{pathLossN:pathLossN,setN:setN,rssiAt1m:rssiAt1m,calibration:calibration,calibrate:calibrate,rssiToDistance:rssiToDistance};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: CROSS-DIMENSION VALIDATOR                           */
/* ═══════════════════════════════════════════════════════════ */
function crossValidate(acousticDistM,bleAvgRSSI,blePathLoss){
  var pairs=[];
  /* Acoustic vs BLE */
  if(acousticDistM!=null&&bleAvgRSSI&&blePathLoss){
    var bleDist=blePathLoss.rssiToDistance(bleAvgRSSI);
    var diff=Math.abs(acousticDistM-bleDist);
    var relDiff=diff/Math.max(acousticDistM,0.1);
    var agree=relDiff<0.25;/* within 25% */
    var warn=relDiff>=0.25&&relDiff<0.5;
    pairs.push({
      dimA:'ACOUS',dimB:'BLE',
      valA:acousticDistM.toFixed(2)+'m',valB:bleDist.toFixed(2)+'m',
      diff:diff.toFixed(2)+'m',relDiff:(relDiff*100).toFixed(0)+'%',
      status:agree?'agree':warn?'warn':'conflict',
      score:Math.max(0,1-relDiff)
    });
  }
  return{pairs:pairs,overallScore:pairs.length>0?pairs.reduce(function(s,p){return s+p.score;},0)/pairs.length:1,hasConflicts:pairs.some(function(p){return p.status==='conflict';})};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: QUALITY SCORE SYSTEM                                */
/* ═══════════════════════════════════════════════════════════ */
var QUALITY_FRESHNESS_MS=5000;/* within 5s = fresh */
function computeQualityScores(mediation,multiChirpResults,noiseData,emFp){
  var now=Date.now();var scores={};
  DIM_KEYS.forEach(function(k,i){
    var src=mediation.sources[k]||'na';
    var val=mediation.dims[k]||0;
    /* Freshness score: real=1, est=0.6, sim=0.2, na=0 */
    var freshness=src==='real'?1:src==='est'?0.6:src==='sim'?0.2:0;
    /* Signal quality */
    var signalQ=val;
    /* Dimension-specific bonuses */
    var bonus=0;
    if(k==='acoustic'&&multiChirpResults){
      var mc=multiChirpResults;
      if(mc.validCount===3)bonus=0.3;
      else if(mc.validCount===2)bonus=0.15;
      if(mc.agreement&&mc.agreement.score>0.8)bonus+=0.1;
      signalQ=mc.conf||val;
    }
    if(k==='emField'&&emFp&&emFp.similarity!=null){
      bonus=emFp.similarity*0.3;
    }
    /* Noise penalty for acoustic */
    var noisePenalty=0;
    if(k==='acoustic'&&noiseData){
      noisePenalty=Math.min(0.3,noiseData.rms*10);
    }
    var score=Math.max(0,Math.min(1,(freshness*0.5+signalQ*0.4+bonus)*Math.max(0,1-noisePenalty)));
    scores[k]={src:src,freshness:freshness,signalQ:signalQ,bonus:bonus,noisePenalty:noisePenalty,score:score};
  });
  return scores;
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: SIM→REAL MIGRATION GUIDE                           */
/* ═══════════════════════════════════════════════════════════ */
var MIGRATION_GUIDE={
  acoustic:{label:'ACOUSTIC',steps:[{text:'Request microphone permission',check:function(s){return s==='real'||s==='est';}},{text:'Press PING to fire chirp',check:function(s){return s==='real';}},{text:'Run CALIBRATE for loopback',check:function(s){return s==='real';}},{text:'Try MULTI-CHIRP for accuracy',check:function(){return false;}}]},
  emField:{label:'EM FIELD',steps:[{text:'Grant DeviceOrientation permission',check:function(s){return s!=='sim'&&s!=='na';}},{text:'Enable magnetometer (Generic Sensor API)',check:function(s){return s==='real';}},{text:'Capture EM fingerprint',check:function(){return false;}}]},
  photonic:{label:'PHOTONIC',steps:[{text:'AmbientLightSensor API (Chrome 56+)',check:function(s){return s==='real';}},{text:'Grant "sensors" permission',check:function(s){return s!=='sim';}},{text:'Indirect: use time-of-day model (EST)',check:function(s){return s==='est';}}]},
  kinetic:{label:'KINETIC',steps:[{text:'Grant DeviceMotion permission',check:function(s){return s==='real';}},{text:'Move device to calibrate baseline',check:function(s){return s==='real';}}]},
  rfDensity:{label:'RF DENSITY',steps:[{text:'Web NFC API for NFC field',check:function(s){return s==='real';}},{text:'WiFi RTT (Android Chrome, needs flag)',check:function(){return false;}},{text:'BLE scan gives approximate RF density',check:function(s){return s!=='sim';}}]},
  nfcField:{label:'NFC FIELD',steps:[{text:'Web NFC API (Chrome Android only)',check:function(s){return s==='real';}},{text:'Tap NFC tag to measure field strength',check:function(){return false;}}]},
  thermal:{label:'THERMAL',steps:[{text:'CPU load-based thermal estimation (EST)',check:function(s){return s==='est'||s==='real';}},{text:'External BLE thermometer via WebBluetooth',check:function(s){return s==='real';}}]},
  spatial:{label:'SPATIAL',steps:[{text:'Grant Geolocation permission',check:function(s){return s==='real';}},{text:'Enable high accuracy GPS',check:function(s){return s==='real';}},{text:'Higher accuracy: acoustic trilateration',check:function(){return false;}}]},
  bleMesh:{label:'BLE MESH',steps:[{text:'Web Bluetooth API (Chrome only)',check:function(s){return s!=='sim';}},{text:'Scan for nearby BLE devices',check:function(s){return s!=='sim';}},{text:'Calibrate path-loss model',check:function(){return false;}}]},
  network:{label:'NETWORK',steps:[{text:'Connect pTCP mesh (BroadcastChannel)',check:function(s){return s==='real';}},{text:'WebRTC P2P for cross-device',check:function(s){return s==='real';}}]},
  collaborative:{label:'COLLAB',steps:[{text:'Connect ≥1 peer via mesh/WebRTC',check:function(s){return s==='real';}}]}
};
function getMigrationStatus(key,source){var m=MIGRATION_GUIDE[key];if(!m)return'todo';if(source==='real')return'done';if(source==='est')return'partial';return'todo';}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.3: CANVAS COMPONENTS                                   */
/* ═══════════════════════════════════════════════════════════ */
function EMFingerprintCanvas(props){
  var ref=useRef(null);var fp=props.fingerprint;
  useEffect(function(){
    var cv=ref.current;if(!cv)return;var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var W=cv.offsetWidth*dpr,H=60*dpr;cv.width=W;cv.height=H;cv.style.height='60px';
    ctx.fillStyle='#050810';ctx.fillRect(0,0,W,H);
    if(!fp||!fp.samples||!fp.samples.length){
      ctx.fillStyle='#334455';ctx.font=(9*dpr)+'px IBM Plex Mono';ctx.textAlign='center';
      ctx.fillText('EM FINGERPRINT NOT CAPTURED',W/2,H/2);return;
    }
    var n=fp.samples.length,cols=['#cc66ff','#00ddff','#ffcc00'];
    var keys=['x','y','z'];
    keys.forEach(function(k,ki){
      var vals=fp.samples.map(function(s){return s[k];});
      var mn=Math.min.apply(null,vals),mx=Math.max.apply(null,vals),rng=mx-mn||1;
      ctx.strokeStyle=cols[ki]+'88';ctx.lineWidth=1.5;ctx.beginPath();
      for(var i=0;i<n;i++){var x=i/n*W,y=H-((vals[i]-mn)/rng)*H;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
      ctx.stroke();
    });
    /* Similarity indicator */
    if(props.similarity!=null){
      var pct=props.similarity;
      ctx.fillStyle=(pct>.7?'#00ffaa':pct>.4?'#ffcc00':'#ff4444')+'33';
      ctx.fillRect(0,0,W*pct,H);
    }
  },[fp,props.similarity]);
  return h('canvas',{ref:ref,className:'em-fp-canvas',style:{width:'100%',height:'60px'}});
}

function MultiChirpCanvas(props){
  var ref=useRef(null);var results=props.results;
  useEffect(function(){
    var cv=ref.current;if(!cv)return;var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var W=cv.offsetWidth*dpr,H=80*dpr;cv.width=W;cv.height=H;cv.style.height='80px';
    ctx.fillStyle='#050810';ctx.fillRect(0,0,W,H);
    if(!results||!results.bands){
      ctx.fillStyle='#334455';ctx.font=(9*dpr)+'px IBM Plex Mono';ctx.textAlign='center';
      ctx.fillText('RUN MULTI-CHIRP TO ANALYZE',W/2,H/2);return;
    }
    var n=results.bands.length,cW=W/n;
    results.bands.forEach(function(b,i){
      var x=i*cW,h2=H*0.8;
      var height=b.valid?Math.max(h2*0.1,h2*b.conf):h2*0.05;
      var y=H-height;
      ctx.fillStyle=(b.band.color||'#00ffaa')+(b.valid?'66':'22');
      ctx.fillRect(x+4*dpr,y,cW-8*dpr,height);
      ctx.fillStyle=b.valid?'#00ffaa':'#556677';
      ctx.font='bold '+(8*dpr)+'px IBM Plex Mono';ctx.textAlign='center';
      ctx.fillText(b.band.name,x+cW/2,H-2*dpr);
      ctx.fillStyle=b.valid?'#ccddeef0':'#556677';
      ctx.font=(7*dpr)+'px IBM Plex Mono';
      ctx.fillText(b.valid&&b.distM!=null?b.distM.toFixed(2)+'m':'N/A',x+cW/2,y-4*dpr);
    });
    /* Agreement line */
    if(results.agreement&&results.agreement.mean!=null&&results.bands.some(function(b){return b.valid&&b.distM!=null;})){
      var maxD=Math.max.apply(null,results.bands.filter(function(b){return b.valid&&b.distM!=null;}).map(function(b){return b.distM;}))||1;
      var my=H*0.8*(1-results.agreement.mean/maxD);
      ctx.strokeStyle='#ffffff44';ctx.lineWidth=1.5*dpr;ctx.setLineDash([4*dpr,3*dpr]);
      ctx.beginPath();ctx.moveTo(0,my);ctx.lineTo(W,my);ctx.stroke();ctx.setLineDash([]);
    }
  },[results]);
  return h('canvas',{ref:ref,style:{width:'100%',height:'80px',display:'block',border:'1px solid #1a2530',borderRadius:'2px',background:'#050810'}});
}

function NoiseFloorGauge(props){
  var nd=props.noiseData;if(!nd)return null;
  var dB=nd.dB||(-80);var pct=Math.max(0,Math.min(1,(dB+80)/60));/* -80dB=0%, -20dB=100% */
  var color=pct<0.3?'#00ffaa':pct<0.6?'#ffcc00':'#ff4444';
  return h('div',{className:'noise-floor-bar'},
    h('span',{style:{color:'#556677',minWidth:'70px'}},'NOISE FLOOR'),
    h('div',{className:'snr-gauge-track'},
      h('div',{className:'snr-gauge-fill',style:{width:(pct*100)+'%',background:color}})),
    h('span',{className:'snr-label',style:{color:color}},dB.toFixed(0)+'dB'));
}

function parabolicPeak(corr,idx){if(idx<=0||idx>=corr.length-1)return{lag:idx,val:corr[idx]};var a=corr[idx-1],b=corr[idx],c=corr[idx+1];var d=a-2*b+c;if(Math.abs(d)<1e-12)return{lag:idx,val:b};var delta=0.5*(a-c)/d;delta=Math.max(-0.5,Math.min(0.5,delta));return{lag:idx+delta,val:b-0.25*(a-c)*delta};}
function findFirstPeakIdx(corr,threshold,startIdx){startIdx=Math.max(startIdx||0,1);for(var i=startIdx;i<corr.length-1;i++)if(corr[i]>=threshold&&corr[i]>corr[i-1]&&corr[i]>=corr[i+1])return i;return-1;}
function calcEchoThreshold(mf,searchStartIdx,directPeakVal){var tailStart=Math.floor(Math.max(searchStartIdx,mf.length*0.75)),tailEnd=mf.length;if(tailEnd-tailStart<30)tailStart=Math.max(0,mf.length-200);var sum=0,cnt=0;for(var i=tailStart;i<tailEnd;i++){sum+=Math.abs(mf[i]);cnt++;}var mean=cnt>0?sum/cnt:0;var varSum=0;for(var i=tailStart;i<tailEnd;i++){var d=Math.abs(mf[i])-mean;varSum+=d*d;}var std=cnt>1?Math.sqrt(varSum/(cnt-1)):0.001;return{th:Math.max(mean+4*std,Math.abs(directPeakVal)*0.02)};}
function xcorr(sig,ref,sr,blankMs){var rL=ref.length,sL=sig.length,bS=Math.floor(sr*blankMs/1000),mL=sL-rL;if(mL<=bS)return{corr:new Float32Array(0),mf:new Float32Array(0),peakLag:-1,peakVal:0,bS:bS,refinedLag:-1,mfPeakVal:0};var rE=0;for(var i=0;i<rL;i++)rE+=ref[i]*ref[i];var rEsq=Math.sqrt(rE);var cL=mL-bS,corr=new Float32Array(cL),mf=new Float32Array(cL),pV=0,pI=0;for(var lag=bS;lag<mL;lag++){var sum=0,sE=0;for(var j=0;j<rL;j++){sum+=sig[lag+j]*ref[j];sE+=sig[lag+j]*sig[lag+j];}sE=Math.sqrt(sE);var ncc=(rEsq>0&&sE>0)?sum/(rEsq*sE):0;var idx=lag-bS;corr[idx]=ncc;mf[idx]=rE>0?sum/rE:0;if(ncc>pV){pV=ncc;pI=idx;}}var refined=parabolicPeak(corr,pI);return{corr:corr,mf:mf,peakLag:pI+bS,peakVal:pV,bS:bS,refinedLag:refined.lag+bS,refinedVal:refined.val};}
function findLoopbackMs(sig,ref,sr){var maxLag=Math.floor(sr*CFG.maxLoopbackMs/1000),minLag=Math.floor(sr*CFG.blanking/1000),rL=ref.length,sL=sig.length;if(sL<rL+maxLag)return{ms:CFG.defaultLoopbackMs,conf:0,method:'fallback'};var rE=0;for(var i=0;i<rL;i++)rE+=ref[i]*ref[i];if(rE===0)return{ms:CFG.defaultLoopbackMs,conf:0,method:'fallback'};var bestVal=0,bestLag=minLag,vals=[];for(var lag=minLag;lag<=maxLag&&lag<sL-rL;lag++){var sum=0,sE=0;for(var j=0;j<rL;j++){sum+=sig[lag+j]*ref[j];sE+=sig[lag+j]*sig[lag+j];}sE=Math.sqrt(sE);var rEsq=Math.sqrt(rE);var ncc=(rEsq>0&&sE>0)?sum/(rEsq*sE):0;vals.push({lag:lag,ncc:ncc});if(ncc>bestVal){bestVal=ncc;bestLag=lag;}}if(bestVal<0.05)return{ms:CFG.defaultLoopbackMs,conf:bestVal,method:'fallback_weak'};var firstThresh=bestVal*0.4,firstLag=bestLag;for(var k=0;k<vals.length;k++)if(vals[k].ncc>=firstThresh){firstLag=vals[k].lag;break;}return{ms:(firstLag/sr)*1000,conf:bestVal,method:'first_arrival'};}
function sanitizeLoopback(rawMs){if(rawMs==null||rawMs<=0||!isFinite(rawMs)||rawMs>CFG.maxLoopbackMs)return CFG.defaultLoopbackMs;return rawMs;}
function lagMs(l){return(l/CFG.sr)*1000;}
function calcTh(cn){return Math.max(CFG.minConf,Math.min(cn*2.5,CFG.maxThresh));}
function genId(){return Math.floor(Math.random()*0xFFFF).toString(16).padStart(4,'0').toUpperCase();}
function fMs(v){return v==null?'---':v<1?v.toFixed(2)+'ms':v<10?v.toFixed(1)+'ms':Math.round(v)+'ms';}
function fT(d){return d.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function cls(ms){if(ms==null)return{l:'TIMEOUT',c:'#ff3333'};if(ms<5)return{l:'NEAR',c:'#00ffaa'};if(ms<20)return{l:'ROOM',c:'#00ddff'};if(ms<50)return{l:'HALL',c:'#ffcc00'};if(ms<150)return{l:'OPEN',c:'#ff8800'};return{l:'DISTANT',c:'#ff4444'};}
function speedOfSound(tempC){return tempC!=null&&!isNaN(tempC)?331.3+0.606*tempC:CFG.speedOfSound;}
function eD(ms,tempC){if(ms==null)return null;return((ms/1000)*speedOfSound(tempC))/2;}
function cC(c){return c>=.5?'#00ffaa':c>=.3?'#00ddff':c>=.15?'#ffcc00':'#ff4444';}
function KalmanFilter(q,r){this.Q=q||0.08;this.R=r||2.5;this.x=null;this.P=1.0;}
KalmanFilter.prototype.update=function(z){if(this.x===null){this.x=z;this.P=1.0;return z;}this.P+=this.Q;this.K=this.P/(this.P+this.R);this.x+=this.K*(z-this.x);this.P*=(1-this.K);return this.x;};
KalmanFilter.prototype.reset=function(){this.x=null;this.P=1.0;};KalmanFilter.prototype.value=function(){return this.x;};
function RollingStats(w,k){this.win=w||12;this.k=k||2.2;this.data=[];}
RollingStats.prototype.push=function(v){this.data.push(v);if(this.data.length>this.win)this.data.shift();};
RollingStats.prototype.median=function(){if(!this.data.length)return null;var s=this.data.slice().sort(function(a,b){return a-b;});var m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;};
RollingStats.prototype.mad=function(){var med=this.median();if(med===null)return 0;var devs=this.data.map(function(v){return Math.abs(v-med);}).sort(function(a,b){return a-b;});var m=Math.floor(devs.length/2);return devs.length%2?devs[m]:(devs[m-1]+devs[m])/2;};
RollingStats.prototype.isOutlier=function(v){if(this.data.length<3)return false;var med=this.median(),mad=this.mad();if(mad<0.001)return Math.abs(v-med)>0.5;return Math.abs(v-med)>this.k*1.4826*mad;};
RollingStats.prototype.filteredMean=function(){if(!this.data.length)return null;var med=this.median(),self=this;var valid=this.data.filter(function(v){return!self.isOutlier(v);});if(!valid.length)return med;return valid.reduce(function(s,v){return s+v;},0)/valid.length;};
RollingStats.prototype.std=function(){if(this.data.length<2)return null;var m=this.filteredMean();if(m===null)return null;var self=this;var valid=this.data.filter(function(v){return!self.isOutlier(v);});if(valid.length<2)return null;return Math.sqrt(valid.reduce(function(s,v){return s+(v-m)*(v-m);},0)/(valid.length-1));};
RollingStats.prototype.clear=function(){this.data=[];};RollingStats.prototype.count=function(){return this.data.length;};
RollingStats.prototype.stability=function(){var s=this.std();if(s===null)return null;var m=this.filteredMean();if(!m||m===0)return null;return Math.max(0,Math.min(1,1-(s/Math.abs(m))*5));};
function flat(b){var t=0;for(var i=0;i<b.length;i++)t+=b[i].length;var f=new Float32Array(t);var o=0;for(var i=0;i<b.length;i++){f.set(b[i],o);o+=b[i].length;}return f;}
function rmsV(a){var s=0;for(var i=0;i<a.length;i++)s+=a[i]*a[i];return Math.sqrt(s/a.length);}

/* CRC32 */
var CRC32_TABLE=(function(){var t=new Uint32Array(256);for(var i=0;i<256;i++){var c=i;for(var j=0;j<8;j++)c=(c&1)?0xEDB88320^(c>>>1):c>>>1;t[i]=c;}return t;})();
function crc32(str){var c=0xFFFFFFFF;for(var i=0;i<str.length;i++)c=CRC32_TABLE[(c^str.charCodeAt(i))&0xFF]^(c>>>8);return(c^0xFFFFFFFF)>>>0;}
function computeChecksum(pkt){return crc32(''+pkt.ver+pkt.type+pkt.seq+pkt.src+(pkt.dst||'')+pkt.ts+pkt.ttl+JSON.stringify(pkt.payload||{}));}
function verifyChecksum(pkt){return pkt.checksum&&pkt.checksum===computeChecksum(pkt);}

/* WebRTC Signaling */
function compressSDP(sdp){var lines=sdp.split('\r\n').filter(function(l){return l&&l.indexOf('a=extmap')!==0&&l.indexOf('a=rtcp-rsize')!==0&&l.indexOf('a=msid')!==0&&l.indexOf('a=ssrc')!==0&&l.indexOf('a=rtpmap')!==0&&l.indexOf('a=fmtp')!==0&&l.indexOf('a=rtcp-fb')!==0;});return LZString.compressToEncodedURIComponent(lines.join('\n'));}
function decompressSDP(c){var raw=LZString.decompressFromEncodedURIComponent(c);return raw?raw.replace(/\n/g,'\r\n')+'\r\n':null;}
function createSignalPayload(type,sdp,deviceId,deviceName){return JSON.stringify({t:type,s:compressSDP(sdp),i:deviceId,n:deviceName});}
function parseSignalPayload(data){try{var o=JSON.parse(data);if(!o.t||!o.s||!o.i)return null;var sdp=decompressSDP(o.s);return sdp?{type:o.t,sdp:sdp,deviceId:o.i,deviceName:o.n||'Unknown'}:null;}catch(e){return null;}}
function generateQRDataURL(text){try{var qr=qrcode(0,'L');qr.addData(text);qr.make();return qr.createDataURL(3,8);}catch(e){return null;}}
/* ═══════════════════════════════════════════════════════════ */
/*  DEVICE / NETWORK INFRASTRUCTURE (v1.1 condensed)          */
/* ═══════════════════════════════════════════════════════════ */
var DEVICE_ID=(function(){var id=sessionStorage.getItem('ptcp_device_id');if(!id){id='DEV-'+genId()+'-'+genId();sessionStorage.setItem('ptcp_device_id',id);}return id;})();
var DEVICE_NAME=(function(){var ua=navigator.userAgent;if(/iPhone/.test(ua))return'iPhone';if(/iPad/.test(ua))return'iPad';if(/Android/.test(ua))return'Android';if(/Mac/.test(ua))return'Mac';if(/Win/.test(ua))return'Windows';return'Device';})()+'-'+DEVICE_ID.slice(-4);
var PKT={SYN:0x01,SYN_ACK:0x02,ACK:0x03,PING:0x10,PONG:0x11,SENSOR_DATA:0x20,SPATIAL_SHARE:0x21,ANCHOR_SHARE:0x22,MEDIATION_BROADCAST:0x30,PROFILE_SYNC:0x31,PHASE_LAW_UPDATE:0x40,HEARTBEAT:0x50,DISCONNECT:0xFF};
var PKT_NAMES={};Object.keys(PKT).forEach(function(k){PKT_NAMES[PKT[k]]=k;});
function createPacket(type,payload,destId){var pkt={ver:0x12,type:type,seq:Math.floor(Math.random()*0xFFFFFF),src:DEVICE_ID,dst:destId||'BROADCAST',ts:Date.now(),ttl:8,payload:payload||{},checksum:0};pkt.checksum=computeChecksum(pkt);return pkt;}

/* ICE Config */
var ICE_CONFIG={iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]};
function getICECandidateType(pc){if(!pc||!pc.localDescription)return'unknown';var sdp=pc.localDescription.sdp||'';if(sdp.indexOf('typ relay')>=0)return'relay';if(sdp.indexOf('typ srflx')>=0)return'srflx';if(sdp.indexOf('typ host')>=0)return'host';return'unknown';}
function calcConnQuality(samples){if(!samples||samples.length<2)return{quality:0,label:'---',bars:0};var l5=samples.slice(-5);var avg=l5.reduce(function(s,v){return s+v;},0)/l5.length;var j=0;for(var i=1;i<l5.length;i++)j+=Math.abs(l5[i]-l5[i-1]);j/=(l5.length-1);var q=Math.max(0,1-avg/500)*.6+Math.max(0,1-j/100)*.4;return{quality:q,label:q>.8?'EXCELLENT':q>.6?'GOOD':q>.3?'FAIR':'POOR',bars:q>.8?5:q>.6?4:q>.4?3:q>.2?2:1,avgRtt:Math.round(avg),jitter:Math.round(j)};}

/* Multi-Peer WebRTC Manager */
function useMultiPeer(){
  var peersRef=useRef({});
  var _p=useState([]),rtcPeers=_p[0],setRtcPeers=_p[1];
  var _s=useState('idle'),rtcState=_s[0],setRtcState=_s[1];
  var _qr=useState(null),qrData=_qr[0],setQrData=_qr[1];
  var _qi=useState(null),qrImg=_qi[0],setQrImg=_qi[1];
  var _e=useState(null),rtcErr=_e[0],setRtcErr=_e[1];
  var _pp=useState(null),pendingPeer=_pp[0],setPendingPeer=_pp[1];
  var onMessageRef=useRef(null);var reconnectTimers=useRef({});
  var syncPeerList=useCallback(function(){var list=[];Object.keys(peersRef.current).forEach(function(id){var p=peersRef.current[id];if(p&&p.info){var q=calcConnQuality(p.rttSamples||[]);list.push({id:id,name:p.info.name||'Unknown',deviceId:p.info.deviceId||id,state:p.state||'unknown',iceType:p.iceType||'unknown',transport:'webrtc',quality:q,rtt:q.avgRtt||null,lastSeen:p.lastSeen||Date.now()});}});setRtcPeers(list);},[]);
  var createPCForPeer=useCallback(function(peerId,info){var existing=peersRef.current[peerId];if(existing&&existing.pc)try{existing.pc.close();}catch(e){}var pc=new RTCPeerConnection(ICE_CONFIG);var entry={pc:pc,dc:null,info:info||{},rttSamples:[],iceType:'unknown',state:'connecting',lastSeen:Date.now()};peersRef.current[peerId]=entry;pc.oniceconnectionstatechange=function(){var s=pc.iceConnectionState;if(s==='connected'||s==='completed'){entry.state='connected';entry.iceType=getICECandidateType(pc);syncPeerList();}if(s==='disconnected'){entry.state='disconnected';syncPeerList();}if(s==='failed'){entry.state='failed';syncPeerList();setTimeout(function(){if(peersRef.current[peerId]&&peersRef.current[peerId].pc===pc)removePeer(peerId);},10000);}if(s==='closed')removePeer(peerId);};return{pc:pc,peerEntry:entry};},[syncPeerList]);
  var setupDC=useCallback(function(peerId,dc){var entry=peersRef.current[peerId];if(!entry)return;entry.dc=dc;dc.onopen=function(){entry.state='connected';syncPeerList();};dc.onmessage=function(ev){entry.lastSeen=Date.now();try{var pkt=JSON.parse(ev.data);if(pkt.type===PKT.PONG&&pkt.ts){entry.rttSamples.push(Date.now()-pkt.ts);if(entry.rttSamples.length>20)entry.rttSamples.shift();}if(pkt.type===PKT.HEARTBEAT&&pkt.payload)entry.info.mediation=pkt.payload.mediation;if(onMessageRef.current)onMessageRef.current(pkt,peerId);}catch(e){}syncPeerList();};dc.onclose=function(){entry.state='disconnected';syncPeerList();};},[syncPeerList]);
  var createOffer=useCallback(function(){setRtcErr(null);setRtcState('creating_offer');var tempId='pending_'+genId();var res=createPCForPeer(tempId,{});var pc=res.pc;var dc=pc.createDataChannel('ptcp',{ordered:true});setupDC(tempId,dc);setPendingPeer(tempId);pc.createOffer().then(function(offer){return pc.setLocalDescription(offer);}).then(function(){return new Promise(function(resolve){if(pc.iceGatheringState==='complete'){resolve();return;}var check=function(){if(pc.iceGatheringState==='complete'){pc.removeEventListener('icegatheringstatechange',check);resolve();}};pc.addEventListener('icegatheringstatechange',check);setTimeout(resolve,5000);});}).then(function(){setQrData(createSignalPayload('offer',pc.localDescription.sdp,DEVICE_ID,DEVICE_NAME));setQrImg(generateQRDataURL(createSignalPayload('offer',pc.localDescription.sdp,DEVICE_ID,DEVICE_NAME)));setRtcState('waiting_answer');}).catch(function(e){setRtcErr('Offer failed: '+e.message);setRtcState('error');removePeer(tempId);});},[createPCForPeer,setupDC]);
  var processOffer=useCallback(function(payload){setRtcErr(null);var signal=parseSignalPayload(payload);if(!signal||signal.type!=='offer'){setRtcErr('Invalid offer');return;}setRtcState('creating_answer');var peerId=signal.deviceId;var res=createPCForPeer(peerId,{name:signal.deviceName,deviceId:signal.deviceId});var pc=res.pc;setPendingPeer(peerId);pc.ondatachannel=function(ev){setupDC(peerId,ev.channel);};pc.setRemoteDescription(new RTCSessionDescription({type:'offer',sdp:signal.sdp})).then(function(){return pc.createAnswer();}).then(function(answer){return pc.setLocalDescription(answer);}).then(function(){return new Promise(function(resolve){if(pc.iceGatheringState==='complete'){resolve();return;}var check=function(){if(pc.iceGatheringState==='complete'){pc.removeEventListener('icegatheringstatechange',check);resolve();}};pc.addEventListener('icegatheringstatechange',check);setTimeout(resolve,5000);});}).then(function(){var p=createSignalPayload('answer',pc.localDescription.sdp,DEVICE_ID,DEVICE_NAME);setQrData(p);setQrImg(generateQRDataURL(p));setRtcState('waiting_scan');}).catch(function(e){setRtcErr('Answer failed: '+e.message);setRtcState('error');removePeer(peerId);});},[createPCForPeer,setupDC]);
  var processAnswer=useCallback(function(payload){setRtcErr(null);var signal=parseSignalPayload(payload);if(!signal||signal.type!=='answer'){setRtcErr('Invalid answer');return;}var tempId=pendingPeer;if(!tempId||!peersRef.current[tempId]){setRtcErr('No pending');return;}var entry=peersRef.current[tempId];entry.info={name:signal.deviceName,deviceId:signal.deviceId};if(tempId!==signal.deviceId){peersRef.current[signal.deviceId]=entry;delete peersRef.current[tempId];}entry.pc.setRemoteDescription(new RTCSessionDescription({type:'answer',sdp:signal.sdp})).then(function(){setRtcState('connecting');setPendingPeer(null);}).catch(function(e){setRtcErr(e.message);setRtcState('error');});},[pendingPeer]);
  var sendData=useCallback(function(data,target){var sent=0,json=JSON.stringify(data);if(target){var p=peersRef.current[target];if(p&&p.dc&&p.dc.readyState==='open')try{p.dc.send(json);sent++;}catch(e){}}else Object.keys(peersRef.current).forEach(function(id){var p=peersRef.current[id];if(p&&p.dc&&p.dc.readyState==='open')try{p.dc.send(json);sent++;}catch(e){}});return sent;},[]);
  var removePeer=useCallback(function(id){var p=peersRef.current[id];if(p){if(p.dc)try{p.dc.close();}catch(e){}if(p.pc)try{p.pc.close();}catch(e){}}delete peersRef.current[id];syncPeerList();},[syncPeerList]);
  var closeAll=useCallback(function(){Object.keys(peersRef.current).forEach(removePeer);setRtcState('idle');setQrData(null);setQrImg(null);setRtcErr(null);setPendingPeer(null);},[removePeer]);
  var connectedCount=rtcPeers.filter(function(p){return p.state==='connected';}).length;
  useEffect(function(){if(connectedCount>0&&rtcState!=='connected')setRtcState('connected');else if(connectedCount===0&&rtcState==='connected')setRtcState('idle');},[connectedCount]);
  useEffect(function(){return function(){Object.keys(peersRef.current).forEach(function(id){var p=peersRef.current[id];if(p){if(p.dc)try{p.dc.close();}catch(e){}if(p.pc)try{p.pc.close();}catch(e){}}});};},[]);
  return{state:rtcState,qrData:qrData,qrImg:qrImg,error:rtcErr,peers:rtcPeers,connectedCount:connectedCount,createOffer:createOffer,processOffer:processOffer,processAnswer:processAnswer,sendData:sendData,removePeer:removePeer,close:closeAll,onMessageRef:onMessageRef,isConnected:connectedCount>0,remoteInfo:rtcPeers.length>0?{id:rtcPeers[0].deviceId,name:rtcPeers[0].name}:null};
}

/* IndexedDB Anchor Store */
var ANCHOR_DB_NAME='ptcp_anchors';var ANCHOR_STORE='anchors';var CALIB_STORE='calibration';var PROFILE_STORE='profiles';var TS_STORE='timeseries';
function openAnchorDB(){return new Promise(function(resolve,reject){var req=indexedDB.open(ANCHOR_DB_NAME,3);req.onupgradeneeded=function(ev){var db=ev.target.result;if(!db.objectStoreNames.contains(ANCHOR_STORE))db.createObjectStore(ANCHOR_STORE,{keyPath:'id'});if(!db.objectStoreNames.contains(CALIB_STORE))db.createObjectStore(CALIB_STORE,{keyPath:'key'});if(!db.objectStoreNames.contains(PROFILE_STORE))db.createObjectStore(PROFILE_STORE,{keyPath:'id'});};req.onsuccess=function(ev){resolve(ev.target.result);};req.onerror=function(){reject(req.error);};});}
function dbPut(store,data){return openAnchorDB().then(function(db){return new Promise(function(ok,fail){var tx=db.transaction(store,'readwrite');tx.objectStore(store).put(data);tx.oncomplete=ok;tx.onerror=function(){fail(tx.error);};});});}
function dbGetAll(store){return openAnchorDB().then(function(db){return new Promise(function(ok,fail){var tx=db.transaction(store,'readonly');var req=tx.objectStore(store).getAll();req.onsuccess=function(){ok(req.result||[]);};req.onerror=function(){fail(req.error);};});});}
function dbGet(store,key){return openAnchorDB().then(function(db){return new Promise(function(ok,fail){var tx=db.transaction(store,'readonly');var req=tx.objectStore(store).get(key);req.onsuccess=function(){ok(req.result);};req.onerror=function(){fail(req.error);};});});}
function dbDelete(store,key){return openAnchorDB().then(function(db){return new Promise(function(ok,fail){var tx=db.transaction(store,'readwrite');tx.objectStore(store).delete(key);tx.oncomplete=ok;tx.onerror=function(){fail(tx.error);};});});}

function useAnchorStore(){
  var _a=useState([]),anchors=_a[0],setAnchors=_a[1];var _l=useState(false),loaded=_l[0],setLoaded=_l[1];
  useEffect(function(){dbGetAll(ANCHOR_STORE).then(function(s){if(s&&s.length)setAnchors(s);setLoaded(true);}).catch(function(){setLoaded(true);});},[]);
  var addAnchor=useCallback(function(anchor){var a=Object.assign({id:'a_'+genId()+'_'+Date.now(),time:new Date().toISOString(),deviceId:DEVICE_ID,deviceName:DEVICE_NAME},anchor);setAnchors(function(p){return p.concat([a]).slice(-32);});dbPut(ANCHOR_STORE,a);return a;},[]);
  var mergeAnchor=useCallback(function(pa){setAnchors(function(prev){var ex=prev.find(function(a){return a.id===pa.id;});if(ex){if(pa.time>ex.time){dbPut(ANCHOR_STORE,pa);return prev.map(function(a){return a.id===pa.id?pa:a;});}return prev;}dbPut(ANCHOR_STORE,pa);return prev.concat([pa]).slice(-32);});},[]);
  var removeAnchor=useCallback(function(id){setAnchors(function(p){return p.filter(function(a){return a.id!==id;});});dbDelete(ANCHOR_STORE,id);},[]);
  var clearAnchors=useCallback(function(){setAnchors([]);openAnchorDB().then(function(db){db.transaction(ANCHOR_STORE,'readwrite').objectStore(ANCHOR_STORE).clear();});},[]);
  var saveCalibration=useCallback(function(c){dbPut(CALIB_STORE,Object.assign({key:'last_calib'},c));},[]);
  var loadCalibration=useCallback(function(){return dbGet(CALIB_STORE,'last_calib');},[]);
  return{anchors:anchors,loaded:loaded,addAnchor:addAnchor,mergeAnchor:mergeAnchor,removeAnchor:removeAnchor,clearAnchors:clearAnchors,saveCalibration:saveCalibration,loadCalibration:loadCalibration};
}

/* QR Scanner */
function QRScanner(props){
  var videoRef=useRef(null),canvasRef=useRef(null),streamRef=useRef(null),scanRef=useRef(null);
  var _sc=useState(false),scanning=_sc[0],setScanning=_sc[1];var _r=useState(null),result=_r[0],setResult=_r[1];var _ce=useState(null),camErr=_ce[0],setCamErr=_ce[1];
  var startScan=useCallback(function(){setCamErr(null);setResult(null);if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){setCamErr('Camera not available');return;}navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}}}).then(function(stream){streamRef.current=stream;var v=videoRef.current;if(!v)return;v.srcObject=stream;v.setAttribute('playsinline','');v.muted=true;v.play();setScanning(true);var hasBD=typeof BarcodeDetector!=='undefined';var det=hasBD?new BarcodeDetector({formats:['qr_code']}):null;scanRef.current=setInterval(function(){if(!v||v.readyState<2)return;var cv=canvasRef.current;if(!cv)return;cv.width=v.videoWidth||640;cv.height=v.videoHeight||480;cv.getContext('2d').drawImage(v,0,0);if(det)det.detect(cv).then(function(b){if(b.length>0){setResult(b[0].rawValue);if(props.onScan)props.onScan(b[0].rawValue);stopScan();}}).catch(function(){});},250);}).catch(function(e){setCamErr('Camera denied: '+e.message);});},[props.onScan]);
  var stopScan=useCallback(function(){if(scanRef.current){clearInterval(scanRef.current);scanRef.current=null;}if(streamRef.current){streamRef.current.getTracks().forEach(function(t){t.stop();});streamRef.current=null;}setScanning(false);},[]);
  useEffect(function(){return stopScan;},[]);
  return h('div',{style:{marginBottom:'12px'}},!scanning?h('button',{className:'btn',onClick:startScan,style:{background:'#00ddff22',border:'1px solid #00ddff44',color:'#00ddff',width:'100%',padding:'12px'}},'📷 カメラでQRスキャン'):h('div',null,h('div',{style:{position:'relative',borderRadius:'2px',overflow:'hidden',border:'1px solid #00ddff44',marginBottom:'8px'}},h('video',{ref:videoRef,style:{width:'100%',display:'block',maxHeight:'300px',objectFit:'cover'}})),h('canvas',{ref:canvasRef,style:{display:'none'}}),h('button',{className:'btn btn-sm',onClick:stopScan,style:{background:'#ff333322',border:'1px solid #ff333344',color:'#ff3333'}},'■ STOP')),!scanning?h('div',{style:{marginTop:'8px'}},h('textarea',{style:{width:'100%',background:'#0a0f14',border:'1px solid #1a2530',color:'#8899aa',fontFamily:'"IBM Plex Mono",monospace',fontSize:'10px',padding:'8px',borderRadius:'2px',resize:'vertical',height:'60px'},placeholder:'QRコードデータを貼り付け...',onChange:function(ev){var val=ev.target.value.trim();if(val&&val.length>20){setResult(val);if(props.onScan)props.onScan(val);}}})):null,camErr?h('div',{style:{fontSize:'10px',color:'#ff6666',marginTop:'6px'}},camErr):null,result?h('div',{style:{fontSize:'10px',color:'#00ffaa',marginTop:'6px'}},'✓ QRデータ受信完了'):null);
}

/* iOS Sensor Permissions */
var IS_IOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1);
var NEEDS_ORIENT_PERM=IS_IOS&&typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function';
var NEEDS_MOTION_PERM=IS_IOS&&typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function';
var _sp={orient:'unknown',motion:'unknown',listeners:[]};
function notifyP(){_sp.listeners.forEach(function(fn){fn({orient:_sp.orient,motion:_sp.motion});});}
function useSP(){var _s=useState({orient:_sp.orient,motion:_sp.motion}),p=_s[0],set=_s[1];useEffect(function(){var fn=function(v){set(v);};_sp.listeners.push(fn);if(!NEEDS_ORIENT_PERM&&_sp.orient==='unknown'){_sp.orient='granted';notifyP();}if(!NEEDS_MOTION_PERM&&_sp.motion==='unknown'){_sp.motion='granted';notifyP();}return function(){_sp.listeners=_sp.listeners.filter(function(f){return f!==fn;});};});var req=useCallback(function(){var p1=NEEDS_ORIENT_PERM?DeviceOrientationEvent.requestPermission().then(function(r){_sp.orient=r;}).catch(function(){_sp.orient='denied';}):Promise.resolve();var p2=NEEDS_MOTION_PERM?DeviceMotionEvent.requestPermission().then(function(r){_sp.motion=r;}).catch(function(){_sp.motion='denied';}):Promise.resolve();return Promise.all([p1,p2]).then(notifyP);});return{perms:p,requestAll:req,needsRequest:NEEDS_ORIENT_PERM||NEEDS_MOTION_PERM?p.orient!=='granted'||p.motion!=='granted':false};}

/* Sensor Hooks (condensed) */
function useMag(){var _s=useState({x:0,y:0,z:0,mag:0,available:false,source:'none'}),d=_s[0],set=_s[1];var ref=useRef(null);var sp=useSP();useEffect(function(){if(ref.current){ref.current();ref.current=null;}if(window.Magnetometer){try{var s=new Magnetometer({frequency:10});s.addEventListener('reading',function(){set({x:s.x,y:s.y,z:s.z,mag:Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z),available:true,source:'magnetometer'});});s.addEventListener('error',function(){tryO();});s.start();ref.current=function(){try{s.stop();}catch(e){}};return function(){if(ref.current)ref.current();};}catch(e){tryO();}}else tryO();function tryO(){var handler=function(ev){var hd=ev.alpha,abs=ev.webkitCompassHeading||hd,b=ev.beta||0,g=ev.gamma||0;set({x:g,y:b,z:abs||0,mag:Math.sqrt(b*b+g*g),available:abs!=null||b!==0||g!==0,heading:abs,source:'orientation'});};window.addEventListener('deviceorientation',handler);ref.current=function(){window.removeEventListener('deviceorientation',handler);};}return function(){if(ref.current)ref.current();};},[sp.perms.orient]);return d;}
function useLight(){var _s=useState({lux:null,available:false,source:'none'}),d=_s[0],set=_s[1];useEffect(function(){if(window.AmbientLightSensor){try{var s=new AmbientLightSensor({frequency:5});s.addEventListener('reading',function(){set({lux:s.illuminance,available:true,source:'sensor'});});s.start();return function(){try{s.stop();}catch(e){}};}catch(e){}}set({lux:500,available:true,source:'est'});},[]);return d;}
function useMotion(){var _s=useState({x:0,y:0,z:0,mag:0,available:false,source:'none'}),d=_s[0],set=_s[1];var sp=useSP();useEffect(function(){var handler=function(ev){var a=ev.accelerationIncludingGravity;if(a&&(a.x!=null)){set({x:a.x||0,y:a.y||0,z:a.z||0,mag:Math.sqrt((a.x||0)*(a.x||0)+(a.y||0)*(a.y||0)+(a.z||0)*(a.z||0)),available:true,source:'devicemotion'});}};window.addEventListener('devicemotion',handler);return function(){window.removeEventListener('devicemotion',handler);};},[sp.perms.motion]);return d;}
function useGeo(){var _s=useState({lat:null,lon:null,acc:null,available:false}),d=_s[0],set=_s[1];var fetch=useCallback(function(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(p){set({lat:p.coords.latitude,lon:p.coords.longitude,acc:p.coords.accuracy,available:true});},function(){},{enableHighAccuracy:true,timeout:5000});},[]);return[d,fetch];}

/* Simulated Sensors (RF, NFC, Thermal, Spatial, BLE — condensed) */
var RF_BANDS={wifi24:{id:'wifi24',name:'WiFi 2.4G',fStart:2400,fEnd:2500,color:'#00ffaa'},wifi5:{id:'wifi5',name:'WiFi 5G',fStart:5150,fEnd:5850,color:'#00ddff'},ble:{id:'ble',name:'BLE',fStart:2402,fEnd:2480,color:'#cc66ff'}};
function genSimSpec(band,bins){var d=new Float32Array(bins),nf=-90;for(var i=0;i<bins;i++)d[i]=nf+Math.random()*6-3;var pk=function(p,w,s){var c=Math.floor(p*bins),ww=Math.floor(bins*w);for(var j=-ww;j<=ww;j++){var idx=c+j;if(idx>=0&&idx<bins){var env=Math.exp(-(j*j)/(2*(ww/3)*(ww/3)));d[idx]=Math.max(d[idx],s*env+nf*(1-env));}}};if(band.id==='wifi24'){pk(.08,.08,-45-Math.random()*15);pk(.375,.08,-40-Math.random()*20);pk(.67,.08,-42-Math.random()*18);}else{[.1,.25,.45,.65,.85].forEach(function(p){if(Math.random()>.3)pk(p,.04,-35-Math.random()*25);});}return d;}
function rfDensity(sp,th){if(!sp||!sp.length)return 0;var a=0;for(var i=0;i<sp.length;i++)if(sp[i]>(th||-70))a++;return a/sp.length;}
function useRF(){var _s=useState({scanning:false}),st=_s[0],setSt=_s[1];var _sp=useState(null),spec=_sp[0],setSpec=_sp[1];var _b=useState('wifi24'),bid=_b[0],setBid=_b[1];var ref=useRef(null);var start=useCallback(function(){setSt({scanning:true});ref.current=setInterval(function(){setSpec(genSimSpec(RF_BANDS[bid],256));},500);},[bid]);var stop=useCallback(function(){setSt({scanning:false});if(ref.current){clearInterval(ref.current);ref.current=null;}},[]);useEffect(function(){return function(){if(ref.current)clearInterval(ref.current);};},[]);return{state:st,spectrum:spec,bandId:bid,setBandId:setBid,band:RF_BANDS[bid],start:start,stop:stop};}
function useThermal(){var _s=useState({est:null,cpuLoad:0,available:false}),d=_s[0],set=_s[1];var ref=useRef(null);var start=useCallback(function(){ref.current=setInterval(function(){var s=performance.now(),sum=0;for(var i=0;i<1e6;i++)sum+=Math.sin(i*.001);var el=performance.now()-s;var load=Math.min(1,Math.max(0,(el-15)/15));var est=22+load*15+Math.random()*2-1;set({est:Math.round(est*10)/10,cpuLoad:load,available:true});},3000);},[]);var stop=useCallback(function(){if(ref.current)clearInterval(ref.current);set(function(s){return Object.assign({},s,{available:false});});},[]);useEffect(function(){return function(){if(ref.current)clearInterval(ref.current);};},[]);return{data:d,start:start,stop:stop};}
function useBLE(){var _s=useState({scanning:false,source:'sim',devices:[],total:0,avgRSSI:-80,density:0}),st=_s[0],setSt=_s[1];var ref=useRef(null);var start=useCallback(function(){setSt(function(s){return Object.assign({},s,{scanning:true,source:'sim'});});var names=['iPhone-Pro','Galaxy-S24','AirPods','ESP32','BLE-Beacon','SmartLock'];var devs=[];for(var i=0;i<4+Math.floor(Math.random()*6);i++){var r=-45-Math.floor(Math.random()*50);devs.push({id:'sim_'+i+'_'+genId(),name:names[i%names.length],rssi:r,distance:Math.pow(10,(-20-r)/20),real:false});}setSt(function(s){return Object.assign({},s,{devices:devs,total:devs.length,avgRSSI:devs.reduce(function(s,d){return s+d.rssi;},0)/devs.length,density:Math.random()*.5});});ref.current=setInterval(function(){setSt(function(s){var ds=s.devices.map(function(d){var r=d.rssi+Math.floor(Math.random()*6-3);return Object.assign({},d,{rssi:r,distance:Math.pow(10,(-20-r)/20)});});return Object.assign({},s,{devices:ds,total:ds.length,avgRSSI:ds.length?ds.reduce(function(ss,d){return ss+d.rssi;},0)/ds.length:-80});});},3000);},[]);var stop=useCallback(function(){if(ref.current){clearInterval(ref.current);ref.current=null;}setSt(function(s){return Object.assign({},s,{scanning:false});});},[]);useEffect(function(){return function(){if(ref.current)clearInterval(ref.current);};},[]);return{state:st,startScan:start,stopScan:stop};}

/* pTCP Network (BroadcastChannel + Sim) */
function usePTCPNetwork(){
  var _peers=useState([]),peers=_peers[0],setPeers=_peers[1];var _pkts=useState([]),packets=_pkts[0],setPkts=_pkts[1];var _c=useState(false),connected=_c[0],setConnected=_c[1];
  var _stats=useState({sent:0,recv:0,dropped:0,verified:0,rtt:null,peers:0,uptime:0,jitter:0,lossRate:0}),stats=_stats[0],setStats=_stats[1];
  var channelRef=useRef(null),peersRef=useRef({}),statsRef=useRef({sent:0,recv:0,dropped:0,verified:0,rttSamples:[]}),hbRef=useRef(null),uptimeRef=useRef(null),startTimeRef=useRef(null),simRef=useRef(null);
  var logPacket=useCallback(function(pkt,dir,valid){setPkts(function(p){return[{pkt:pkt,dir:dir,time:new Date(),valid:valid!==false}].concat(p).slice(0,128);});if(dir==='TX')statsRef.current.sent++;else{statsRef.current.recv++;if(valid!==false)statsRef.current.verified++;}},[]);
  var sendPacket=useCallback(function(type,payload,dest){var pkt=createPacket(type,payload,dest);if(channelRef.current)try{channelRef.current.postMessage(pkt);}catch(e){}logPacket(pkt,'TX');return pkt;},[logPacket]);
  var connect=useCallback(function(){try{var ch=new BroadcastChannel('ptcp_v1_mesh');channelRef.current=ch;ch.onmessage=function(ev){var pkt=ev.data;if(!pkt||!pkt.src||pkt.src===DEVICE_ID)return;var valid=verifyChecksum(pkt);if(!valid){statsRef.current.dropped++;return;}logPacket(pkt,'RX',true);if(pkt.type===PKT.SYN){sendPacket(PKT.SYN_ACK,{name:DEVICE_NAME},pkt.src);peersRef.current[pkt.src]={id:pkt.src,name:pkt.payload.name||'Unknown',lastSeen:Date.now(),mediation:0,connected:true};}if(pkt.type===PKT.HEARTBEAT&&peersRef.current[pkt.src])peersRef.current[pkt.src].lastSeen=Date.now();setPeers(Object.values(peersRef.current).filter(function(p){return Date.now()-p.lastSeen<30000;}));};}catch(e){}setConnected(true);startTimeRef.current=Date.now();sendPacket(PKT.SYN,{name:DEVICE_NAME});hbRef.current=setInterval(function(){sendPacket(PKT.HEARTBEAT,{name:DEVICE_NAME,mediation:0});},5000);uptimeRef.current=setInterval(function(){setStats({sent:statsRef.current.sent,recv:statsRef.current.recv,dropped:statsRef.current.dropped,verified:statsRef.current.verified,rtt:null,peers:Object.keys(peersRef.current).length,uptime:Math.floor((Date.now()-startTimeRef.current)/1000),jitter:0,lossRate:0});},1000);var simNames=['iPhone-Lab','Android-Field','Mac-Base','RPi-Probe'];var simPeers=[];for(var i=0;i<2+Math.floor(Math.random()*2);i++){var sp={id:'SIM-'+genId()+'-'+genId(),name:simNames[i],lastSeen:Date.now(),mediation:.2+Math.random()*.6,rtt:5+Math.floor(Math.random()*50),connected:true,simulated:true};simPeers.push(sp);peersRef.current[sp.id]=sp;}setPeers(Object.values(peersRef.current));simRef.current=setInterval(function(){simPeers.forEach(function(sp){sp.lastSeen=Date.now();sp.mediation=Math.max(0,Math.min(1,sp.mediation+(Math.random()-.5)*.1));});setPeers(Object.values(peersRef.current));},3000);},[sendPacket,logPacket]);
  var disconnect=useCallback(function(){if(channelRef.current){channelRef.current.close();channelRef.current=null;}[hbRef,uptimeRef,simRef].forEach(function(r){if(r.current)clearInterval(r.current);});peersRef.current={};setPeers([]);setConnected(false);},[]);
  var broadcastMediation=useCallback(function(med){if(connected)sendPacket(PKT.MEDIATION_BROADCAST,med);},[connected,sendPacket]);
  var shareAnchor=useCallback(function(a){if(connected)sendPacket(PKT.ANCHOR_SHARE,a);},[connected,sendPacket]);
  useEffect(function(){return function(){if(channelRef.current)try{channelRef.current.close();}catch(e){}[hbRef,uptimeRef,simRef].forEach(function(r){if(r.current)clearInterval(r.current);});};},[]);
  return{peers:peers,packets:packets,connected:connected,stats:stats,connect:connect,disconnect:disconnect,broadcastMediation:broadcastMediation,shareAnchor:shareAnchor,deviceId:DEVICE_ID,deviceName:DEVICE_NAME};
}
/* ═══════════════════════════════════════════════════════════ */
/*  v1.2: TIME-SERIES STORAGE                                 */
/* ═══════════════════════════════════════════════════════════ */
var DIM_KEYS=['acoustic','emField','photonic','kinetic','rfDensity','nfcField','thermal','spatial','bleMesh','network','collaborative'];
var DIM_LABELS=['ACOUS','EM','PHOTO','KINET','RF','NFC','THERM','SPACE','BLE','NET','COLLAB'];
var DIM_COLORS=['#00ffaa','#cc66ff','#ffcc00','#00ddff','#ff4466','#9966ff','#ff8800','#22ee88','#4488ff','#00ffaa','#ffaa00'];

function useTimeSeries(maxPoints){
  var _d=useState([]),data=_d[0],setData=_d[1];
  var max=maxPoints||CFG.tsMaxPoints;
  var addSnapshot=useCallback(function(mediation,phaseLaws){
    var snap={ts:Date.now(),time:new Date().toISOString(),composite:mediation.composite,dims:{},sources:{},reality:mediation.reality,phaseLawStates:{}};
    DIM_KEYS.forEach(function(k){snap.dims[k]=mediation.dims[k]||0;snap.sources[k]=mediation.sources[k]||'na';});
    if(phaseLaws)phaseLaws.forEach(function(l){snap.phaseLawStates[l.id]=l.result.state;});
    setData(function(prev){return prev.concat([snap]).slice(-max);});
    return snap;
  },[max]);
  var clear=useCallback(function(){setData([]);},[]);
  /* Compute stats over time range */
  var getStats=useCallback(function(fromTs,toTs){
    var filtered=data.filter(function(d){return(!fromTs||d.ts>=fromTs)&&(!toTs||d.ts<=toTs);});
    if(!filtered.length)return null;
    var stats={count:filtered.length,duration:filtered.length>1?filtered[filtered.length-1].ts-filtered[0].ts:0,composite:{}};
    var vals=filtered.map(function(d){return d.composite;});
    stats.composite={mean:vals.reduce(function(s,v){return s+v;},0)/vals.length,min:Math.min.apply(null,vals),max:Math.max.apply(null,vals),std:vals.length>1?Math.sqrt(vals.reduce(function(s,v){return s+(v-vals.reduce(function(s2,v2){return s2+v2;},0)/vals.length)*(v-vals.reduce(function(s2,v2){return s2+v2;},0)/vals.length);},0)/(vals.length-1)):0};
    stats.dims={};
    DIM_KEYS.forEach(function(k){var dv=filtered.map(function(d){return d.dims[k]||0;});stats.dims[k]={mean:dv.reduce(function(s,v){return s+v;},0)/dv.length,min:Math.min.apply(null,dv),max:Math.max.apply(null,dv)};});
    return stats;
  },[data]);
  return{data:data,addSnapshot:addSnapshot,clear:clear,getStats:getStats,count:data.length};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.2: TIME-SERIES CHART CANVAS                            */
/* ═══════════════════════════════════════════════════════════ */
function TimeSeriesCanvas(props){
  var ref=useRef(null);var data=props.data||[];var activeDims=props.activeDims||DIM_KEYS;var showComposite=props.showComposite!==false;
  useEffect(function(){
    var cv=ref.current;if(!cv||!data.length)return;
    var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var W=cv.offsetWidth*dpr,H=(props.height||200)*dpr;
    cv.width=W;cv.height=H;cv.style.height=(props.height||200)+'px';
    ctx.clearRect(0,0,W,H);
    /* Grid */
    ctx.strokeStyle='#1a253044';ctx.lineWidth=1;
    for(var g=0;g<=4;g++){var gy=H*g/4;ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(W,gy);ctx.stroke();}
    /* Y-axis labels */
    ctx.fillStyle='#33445588';ctx.font=(8*dpr)+'px IBM Plex Mono';
    ctx.fillText('1.0',2*dpr,12*dpr);ctx.fillText('0.5',2*dpr,H/2+4*dpr);ctx.fillText('0.0',2*dpr,H-2*dpr);
    /* Time axis */
    var tMin=data[0].ts,tMax=data[data.length-1].ts,tRange=Math.max(tMax-tMin,1000);
    var xScale=W/tRange;
    /* Draw each active dimension */
    DIM_KEYS.forEach(function(k,di){
      if(activeDims.indexOf(k)===-1)return;
      ctx.strokeStyle=DIM_COLORS[di]+'66';ctx.lineWidth=1.2*dpr;
      ctx.beginPath();
      for(var i=0;i<data.length;i++){
        var x=(data[i].ts-tMin)*xScale;
        var y=H-(data[i].dims[k]||0)*H;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      }
      ctx.stroke();
    });
    /* Composite line (bold) */
    if(showComposite){
      ctx.strokeStyle='#ffffff88';ctx.lineWidth=2*dpr;ctx.setLineDash([4*dpr,2*dpr]);
      ctx.beginPath();
      for(var i=0;i<data.length;i++){
        var x=(data[i].ts-tMin)*xScale;
        var y=H-data[i].composite*H;
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      }
      ctx.stroke();ctx.setLineDash([]);
    }
    /* Time labels */
    ctx.fillStyle='#33445588';ctx.font=(7*dpr)+'px IBM Plex Mono';ctx.textAlign='center';
    var labelCount=Math.min(6,data.length);
    for(var i=0;i<labelCount;i++){
      var idx=Math.floor(i*data.length/labelCount);
      var x=(data[idx].ts-tMin)*xScale;
      var t=new Date(data[idx].ts);
      ctx.fillText(fT(t),x,H-2*dpr);
    }
  },[data,activeDims,showComposite,props.height]);
  return h('canvas',{ref:ref,className:'cv',style:{width:'100%',height:(props.height||200)+'px',cursor:'crosshair'}});
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.2: 2D SPATIAL HEATMAP                                  */
/* ═══════════════════════════════════════════════════════════ */
function HeatmapCanvas(props){
  var ref=useRef(null);var points=props.points||[];/* [{x,y,mu}] */
  useEffect(function(){
    var cv=ref.current;if(!cv)return;
    var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var W=cv.offsetWidth*dpr,H=220*dpr;cv.width=W;cv.height=H;cv.style.height='220px';
    ctx.fillStyle='#050810';ctx.fillRect(0,0,W,H);
    if(!points.length){ctx.fillStyle='#334455';ctx.font=(10*dpr)+'px IBM Plex Mono';ctx.textAlign='center';ctx.fillText('計測データなし — PINGで計測開始',W/2,H/2);return;}
    /* Find bounds */
    var xMin=Infinity,xMax=-Infinity,yMin=Infinity,yMax=-Infinity;
    points.forEach(function(p){xMin=Math.min(xMin,p.x);xMax=Math.max(xMax,p.x);yMin=Math.min(yMin,p.y);yMax=Math.max(yMax,p.y);});
    var pad=Math.max((xMax-xMin)*0.15,(yMax-yMin)*0.15,0.5);
    xMin-=pad;xMax+=pad;yMin-=pad;yMax+=pad;
    var xRange=xMax-xMin||1,yRange=yMax-yMin||1;
    var margin=20*dpr;var pW=W-2*margin,pH=H-2*margin;
    /* Draw heatmap using gaussian splats */
    var GRID=64;var grid=new Float32Array(GRID*GRID);var count=new Float32Array(GRID*GRID);
    var radius=Math.max(2,Math.floor(GRID*0.08));
    points.forEach(function(p){
      var gx=Math.floor(((p.x-xMin)/xRange)*GRID);
      var gy=Math.floor(((p.y-yMin)/yRange)*GRID);
      for(var dx=-radius;dx<=radius;dx++)for(var dy=-radius;dy<=radius;dy++){
        var nx=gx+dx,ny=gy+dy;
        if(nx>=0&&nx<GRID&&ny>=0&&ny<GRID){
          var w=Math.exp(-(dx*dx+dy*dy)/(radius*radius*0.5));
          grid[ny*GRID+nx]+=p.mu*w;count[ny*GRID+nx]+=w;
        }
      }
    });
    /* Normalize and render */
    var maxVal=0;for(var i=0;i<grid.length;i++){if(count[i]>0)grid[i]/=count[i];maxVal=Math.max(maxVal,grid[i]);}
    if(maxVal===0)maxVal=1;
    var cellW=pW/GRID,cellH=pH/GRID;
    for(var gy=0;gy<GRID;gy++)for(var gx=0;gx<GRID;gx++){
      var v=grid[gy*GRID+gx]/maxVal;
      if(v<0.01)continue;
      var r=Math.floor(v<0.5?0:v<0.75?(v-0.5)*4*255:255);
      var g=Math.floor(v<0.25?v*4*255:v<0.75?255:(1-v)*4*255);
      var b=Math.floor(v<0.25?255:v<0.5?(0.5-v)*4*255:0);
      ctx.fillStyle='rgba('+r+','+g+','+b+','+(0.3+v*0.5)+')';
      ctx.fillRect(margin+gx*cellW,margin+gy*cellH,Math.ceil(cellW)+1,Math.ceil(cellH)+1);
    }
    /* Draw measurement points */
    points.forEach(function(p,i){
      var px=margin+((p.x-xMin)/xRange)*pW;
      var py=margin+((p.y-yMin)/yRange)*pH;
      ctx.beginPath();ctx.arc(px,py,3*dpr,0,Math.PI*2);
      ctx.fillStyle=p.mu>.6?'#00ffaa':p.mu>.3?'#ffcc00':'#ff4444';ctx.fill();
      ctx.strokeStyle='#ffffff33';ctx.lineWidth=1;ctx.stroke();
      /* Connect sequential points */
      if(i>0){var pp=points[i-1];var ppx=margin+((pp.x-xMin)/xRange)*pW;var ppy=margin+((pp.y-yMin)/yRange)*pH;ctx.beginPath();ctx.moveTo(ppx,ppy);ctx.lineTo(px,py);ctx.strokeStyle='#ffffff11';ctx.lineWidth=1;ctx.stroke();}
    });
    /* Scale labels */
    ctx.fillStyle='#44556688';ctx.font=(7*dpr)+'px IBM Plex Mono';ctx.textAlign='left';
    ctx.fillText(xMin.toFixed(1)+'m',margin,H-4*dpr);ctx.textAlign='right';ctx.fillText(xMax.toFixed(1)+'m',W-margin,H-4*dpr);
  },[points]);
  return h('canvas',{ref:ref,className:'cv',style:{width:'100%',height:'220px'}});
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.2: PROFILE PERSISTENCE                                 */
/* ═══════════════════════════════════════════════════════════ */
function useProfiles(){
  var _p=useState([]),profiles=_p[0],setProfiles=_p[1];var _l=useState(false),loaded=_l[0],setLoaded=_l[1];
  useEffect(function(){dbGetAll(PROFILE_STORE).then(function(s){if(s)setProfiles(s);setLoaded(true);}).catch(function(){setLoaded(true);});},[]);
  var saveProfile=useCallback(function(name,tsData,mediation,phaseLaws){
    var profile={id:'prof_'+genId()+'_'+Date.now(),name:name||'Profile '+new Date().toLocaleString(),created:new Date().toISOString(),deviceId:DEVICE_ID,deviceName:DEVICE_NAME,
      timeSeries:tsData.slice(-500),/* Cap at 500 points for storage */
      snapshot:{composite:mediation.composite,dims:Object.assign({},mediation.dims),sources:Object.assign({},mediation.sources),reality:Object.assign({},mediation.reality)},
      phaseLaws:phaseLaws.map(function(l){return{id:l.id,state:l.result.state,score:l.result.score};}),
      stats:tsData.length>0?computeProfileStats(tsData):null};
    setProfiles(function(p){return p.concat([profile]).slice(-20);});
    dbPut(PROFILE_STORE,profile);return profile;
  },[]);
  var deleteProfile=useCallback(function(id){setProfiles(function(p){return p.filter(function(pr){return pr.id!==id;});});dbDelete(PROFILE_STORE,id);},[]);
  var exportProfile=useCallback(function(profile){
    var blob=new Blob([JSON.stringify(profile,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='ptcp_profile_'+profile.id+'.json';a.click();URL.revokeObjectURL(url);
  },[]);
  var importProfile=useCallback(function(jsonStr){
    try{var p=JSON.parse(jsonStr);if(!p.id||!p.snapshot)return null;p.id='imp_'+genId()+'_'+Date.now();/* New ID to avoid collisions */setProfiles(function(prev){return prev.concat([p]).slice(-20);});dbPut(PROFILE_STORE,p);return p;}catch(e){return null;}
  },[]);
  return{profiles:profiles,loaded:loaded,saveProfile:saveProfile,deleteProfile:deleteProfile,exportProfile:exportProfile,importProfile:importProfile};
}
function computeProfileStats(tsData){
  if(!tsData||!tsData.length)return null;
  var vals=tsData.map(function(d){return d.composite;});
  var mean=vals.reduce(function(s,v){return s+v;},0)/vals.length;
  var std=vals.length>1?Math.sqrt(vals.reduce(function(s,v){return s+(v-mean)*(v-mean);},0)/(vals.length-1)):0;
  return{count:vals.length,mean:mean,std:std,min:Math.min.apply(null,vals),max:Math.max.apply(null,vals),ci95:1.96*std/Math.sqrt(vals.length)};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.2: PHASE-LAW TIMELINE                                  */
/* ═══════════════════════════════════════════════════════════ */
function PhaseTimelineCanvas(props){
  var ref=useRef(null);var data=props.data||[];var laws=props.laws||[];
  useEffect(function(){
    var cv=ref.current;if(!cv||!data.length||!laws.length)return;
    var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var rowH=18*dpr,labelW=50*dpr,W=cv.offsetWidth*dpr,H=laws.length*rowH+10*dpr;
    cv.width=W;cv.height=H;cv.style.height=(H/dpr)+'px';
    ctx.clearRect(0,0,W,H);
    var tMin=data[0].ts,tMax=data[data.length-1].ts,tRange=Math.max(tMax-tMin,1000);
    var barW=W-labelW;
    var stateColors={'MATCHED':'#00ffaa','CONTINUOUS':'#00ffaa','OPEN':'#00ddff','STABLE':'#00ffaa','DENSE':'#ff4466','COMPLETE':'#22ee88','CONNECTED':'#4488ff','COUPLED':'#00ffaa','MISMATCHED':'#ff4444','SPARSE':'#ff880088','NARROW':'#ffcc00','UNSTABLE':'#ff333388','PARTIAL':'#ffcc00','ISOLATED':'#ff444488','DECOUPLED':'#ff3333'};
    laws.forEach(function(law,li){
      var y=li*rowH+2*dpr;
      /* Label */
      ctx.fillStyle='#55667788';ctx.font=(7*dpr)+'px IBM Plex Mono';ctx.textAlign='left';
      ctx.fillText(law.id,2*dpr,y+rowH*0.7);
      /* Timeline segments */
      var prevState=null,segStart=0;
      data.forEach(function(d,di){
        var state=d.phaseLawStates&&d.phaseLawStates[law.id]?d.phaseLawStates[law.id]:'N/A';
        if(state!==prevState||di===data.length-1){
          if(prevState!=null){
            var x1=labelW+((data[segStart].ts-tMin)/tRange)*barW;
            var x2=labelW+((data[di].ts-tMin)/tRange)*barW;
            ctx.fillStyle=(stateColors[prevState]||'#334455')+'88';
            ctx.fillRect(x1,y+2*dpr,Math.max(x2-x1,2*dpr),rowH-4*dpr);
          }
          prevState=state;segStart=di;
        }
      });
    });
  },[data,laws]);
  return h('canvas',{ref:ref,className:'cv',style:{width:'100%'}});
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.2: INTERACTIVE RADAR WITH WEIGHT ADJUSTMENT             */
/* ═══════════════════════════════════════════════════════════ */
function InteractiveRadar(props){
  var dims=props.dims||{};var sources=props.sources||{};var weights=props.weights||{};
  var ref=useRef(null);
  useEffect(function(){
    var cv=ref.current;if(!cv)return;
    var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1,S=300*dpr;
    cv.width=S;cv.height=S;cv.style.width='300px';cv.style.height='300px';
    ctx.clearRect(0,0,S,S);
    var cx=S/2,cy=S/2,maxR=S/2-30*dpr;
    var n=DIM_KEYS.length;
    /* Grid circles */
    for(var r=1;r<=4;r++){ctx.beginPath();ctx.arc(cx,cy,maxR*(r/4),0,Math.PI*2);ctx.strokeStyle='#1a253044';ctx.lineWidth=1;ctx.stroke();}
    /* Axes + labels */
    for(var i=0;i<n;i++){
      var angle=-Math.PI/2+(Math.PI*2/n)*i;
      var src=sources[DIM_KEYS[i]]||'na';
      var w=weights[DIM_KEYS[i]]||0;
      /* Axis line — thickness reflects weight */
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(angle)*maxR,cy+Math.sin(angle)*maxR);
      ctx.strokeStyle=src==='sim'?'#ffcc0022':'#1a253066';ctx.lineWidth=(1+w*10)*dpr;ctx.stroke();
      /* Label */
      var lx=cx+Math.cos(angle)*(maxR+18*dpr),ly=cy+Math.sin(angle)*(maxR+18*dpr);
      ctx.fillStyle=src==='real'?DIM_COLORS[i]:src==='sim'?'#ffcc00aa':'#44556688';
      ctx.font='bold '+(7*dpr)+'px IBM Plex Mono';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(DIM_LABELS[i],lx,ly);
      /* Weight indicator */
      ctx.fillStyle='#33445588';ctx.font=(5*dpr)+'px IBM Plex Mono';
      ctx.fillText('w='+(w).toFixed(2),lx,ly+9*dpr);
    }
    /* Polygon */
    ctx.beginPath();
    for(var i=0;i<n;i++){var angle=-Math.PI/2+(Math.PI*2/n)*i;var v=Math.min(1,dims[DIM_KEYS[i]]||0);var px=cx+Math.cos(angle)*maxR*v,py=cy+Math.sin(angle)*maxR*v;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);}
    ctx.closePath();ctx.fillStyle='rgba(0,255,170,.06)';ctx.fill();ctx.strokeStyle='#00ffaa88';ctx.lineWidth=2*dpr;ctx.stroke();
    /* Dots */
    for(var i=0;i<n;i++){var angle=-Math.PI/2+(Math.PI*2/n)*i;var v=Math.min(1,dims[DIM_KEYS[i]]||0);var src=sources[DIM_KEYS[i]]||'na';ctx.beginPath();ctx.arc(cx+Math.cos(angle)*maxR*v,cy+Math.sin(angle)*maxR*v,3*dpr,0,Math.PI*2);ctx.fillStyle=src==='real'?DIM_COLORS[i]:src==='sim'?'#ffcc00':'#445566';ctx.fill();}
  },[dims,sources,weights]);
  return h('canvas',{ref:ref,style:{width:'300px',height:'300px',display:'block',margin:'0 auto'}});
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.2: SNAPSHOT EXPORT (PNG)                               */
/* ═══════════════════════════════════════════════════════════ */
function exportCanvasPNG(canvasRef,filename){
  if(!canvasRef.current)return;
  var url=canvasRef.current.toDataURL('image/png');
  var a=document.createElement('a');a.href=url;a.download=filename||'ptcp_snapshot.png';a.click();
}
function exportJSON(data,filename){
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);
}
function exportCSV(tsData,filename){
  if(!tsData||!tsData.length)return;
  var header='timestamp,composite,'+DIM_KEYS.join(',')+','+DIM_KEYS.map(function(k){return k+'_source';}).join(',');
  var rows=tsData.map(function(d){return d.time+','+d.composite.toFixed(4)+','+DIM_KEYS.map(function(k){return(d.dims[k]||0).toFixed(4);}).join(',')+','+DIM_KEYS.map(function(k){return d.sources[k]||'na';}).join(',');});
  var csv=header+'\n'+rows.join('\n');
  var blob=new Blob([csv],{type:'text/csv'});
  var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download=filename||'ptcp_timeseries.csv';a.click();URL.revokeObjectURL(url);
}

/* Profile comparison utility */
function compareProfiles(a,b){
  if(!a||!b)return null;
  var result={dimDiffs:{},compositeDiff:0,alerts:[]};
  result.compositeDiff=(b.snapshot.composite||0)-(a.snapshot.composite||0);
  DIM_KEYS.forEach(function(k){
    var va=a.snapshot.dims[k]||0,vb=b.snapshot.dims[k]||0;
    var diff=vb-va;
    result.dimDiffs[k]={a:va,b:vb,diff:diff,pct:va>0?(diff/va)*100:0};
    if(Math.abs(diff)>0.15)result.alerts.push({dim:k,diff:diff,severity:Math.abs(diff)>0.3?'crit':'warn',msg:DIM_LABELS[DIM_KEYS.indexOf(k)]+': '+(diff>0?'+':'')+diff.toFixed(3)+' ('+(va>0?(diff/va*100).toFixed(0):'+∞')+'%)'});
  });
  return result;
}
/* ═══════════════════════════════════════════════════════════ */
/*  TIME FORMATTER                                             */
/* ═══════════════════════════════════════════════════════════ */
function fT(d){if(!d)return'--:--';return ('0'+d.getHours()).slice(-2)+':'+('0'+d.getMinutes()).slice(-2)+':'+('0'+d.getSeconds()).slice(-2);}

/* ═══════════════════════════════════════════════════════════ */
/*  MEDIATION COEFFICIENT μ(x,t) CALCULATION                  */
/* ═══════════════════════════════════════════════════════════ */
var DEFAULT_WEIGHTS={acoustic:.20,emField:.10,photonic:.08,kinetic:.08,rfDensity:.10,nfcField:.05,thermal:.07,spatial:.10,bleMesh:.10,network:.08,collaborative:.04};

function calcMediation(sensor,weights){
  weights=weights||DEFAULT_WEIGHTS;var dims={},sources={},reality={realCount:0,simCount:0,estCount:0,naCount:0,total:11};
  /* Acoustic */
  var acDist=sensor.acoustic&&sensor.acoustic.distM!=null?sensor.acoustic.distM:null;
  var acConf=sensor.acoustic&&sensor.acoustic.conf||0;
  dims.acoustic=acDist!=null?Math.max(0,Math.min(1,1-acDist/10))*Math.min(1,acConf*3):0;
  sources.acoustic=acDist!=null?'real':'na';
  /* EM */
  var mag=sensor.mag;
  if(mag&&mag.available){dims.emField=Math.min(1,mag.mag/80);sources.emField=mag.source==='magnetometer'?'real':'est';}
  else{dims.emField=.3+Math.random()*.15;sources.emField='sim';}
  /* Photonic */
  var lux=sensor.light;
  if(lux&&lux.available&&lux.source==='sensor'){dims.photonic=Math.min(1,lux.lux/5000);sources.photonic='real';}
  else if(lux&&lux.available){dims.photonic=Math.min(1,(lux.lux||500)/5000);sources.photonic='est';}
  else{dims.photonic=.4+Math.random()*.1;sources.photonic='sim';}
  /* Kinetic */
  var mot=sensor.motion;
  if(mot&&mot.available){dims.kinetic=Math.min(1,mot.mag/15);sources.kinetic='real';}
  else{dims.kinetic=.2+Math.random()*.1;sources.kinetic='sim';}
  /* RF */
  if(sensor.rfSpec){var d=rfDensity(sensor.rfSpec,-70);dims.rfDensity=d;sources.rfDensity='sim';}
  else{dims.rfDensity=.3+Math.random()*.1;sources.rfDensity='sim';}
  /* NFC */
  dims.nfcField=.15+Math.random()*.05;sources.nfcField='sim';
  /* Thermal */
  if(sensor.thermal&&sensor.thermal.available){dims.thermal=Math.max(0,Math.min(1,(sensor.thermal.est-18)/20));sources.thermal='est';}
  else{dims.thermal=.5+Math.random()*.08;sources.thermal='sim';}
  /* Spatial */
  if(sensor.geo&&sensor.geo.available){dims.spatial=Math.min(1,100/(sensor.geo.acc||100));sources.spatial='real';}
  else{dims.spatial=.2+Math.random()*.1;sources.spatial='sim';}
  /* BLE */
  if(sensor.ble&&sensor.ble.scanning){dims.bleMesh=Math.min(1,sensor.ble.total/10)*.6+sensor.ble.density*.4;sources.bleMesh='sim';}
  else{dims.bleMesh=.15+Math.random()*.05;sources.bleMesh='sim';}
  /* Network */
  var nPeers=sensor.networkPeers||0;
  dims.network=Math.min(1,nPeers/5)*.5+(sensor.networkQuality||0)*.5;
  sources.network=nPeers>0?'real':'sim';
  if(sources.network==='sim')dims.network=.25+Math.random()*.1;
  /* Collaborative */
  dims.collaborative=Math.min(1,nPeers/3);
  sources.collaborative=nPeers>0?'real':'sim';
  if(sources.collaborative==='sim')dims.collaborative=.1+Math.random()*.05;
  /* Compute composite + reality */
  var wSum=0,vSum=0;
  DIM_KEYS.forEach(function(k){
    var src=sources[k];
    if(src==='real')reality.realCount++;
    else if(src==='est')reality.estCount++;
    else if(src==='sim')reality.simCount++;
    else reality.naCount++;
    vSum+=dims[k]*(weights[k]||0);wSum+=(weights[k]||0);
  });
  var composite=wSum>0?vSum/wSum:0;
  reality.index=reality.total>0?(reality.realCount+reality.estCount*.5)/reality.total:0;
  return{composite:composite,dims:dims,sources:sources,weights:weights,reality:reality};
}

/* ═══════════════════════════════════════════════════════════ */
/*  PHASE-LAW ENGINE (8 Laws)                                 */
/* ═══════════════════════════════════════════════════════════ */
function evaluatePhaseLaws(med){
  var d=med.dims,s=med.sources;
  function sc(v,lo,hi){return Math.max(0,Math.min(1,(v-lo)/(hi-lo)));}
  function state(sc){return sc>.65?'COUPLED':sc>.35?'PARTIAL':'DECOUPLED';}
  var laws=[
    {id:'PL-001',name:'Acoustic-Spatial Coupling',check:function(){
      var v=(d.acoustic*.6+d.spatial*.4);return{score:v,state:state(v)};}},
    {id:'PL-002',name:'EM Continuity',check:function(){
      var v=d.emField;return{score:v,state:v>.6?'CONTINUOUS':v>.3?'PARTIAL':'DISCONTINUOUS'};}},
    {id:'PL-003',name:'Spectral Openness',check:function(){
      var v=1-d.rfDensity;return{score:v,state:v>.7?'OPEN':v>.4?'PARTIAL':'NARROW'};}},
    {id:'PL-004',name:'Kinetic Stability',check:function(){
      var v=1-Math.min(1,d.kinetic*1.5);return{score:v,state:v>.6?'STABLE':v>.3?'PARTIAL':'UNSTABLE'};}},
    {id:'PL-005',name:'RF Density',check:function(){
      var v=d.rfDensity;return{score:v,state:v>.5?'DENSE':v>.2?'MODERATE':'SPARSE'};}},
    {id:'PL-006',name:'Sensor Completeness',check:function(){
      var rc=med.reality.realCount+med.reality.estCount;var v=rc/med.reality.total;
      return{score:v,state:v>.7?'COMPLETE':v>.4?'PARTIAL':'INCOMPLETE'};}},
    {id:'PL-007',name:'Network Connectivity',check:function(){
      var v=d.network;return{score:v,state:v>.5?'CONNECTED':v>.2?'PARTIAL':'ISOLATED'};}},
    {id:'PL-008',name:'Thermal-Photonic Coupling',check:function(){
      var v=(d.thermal*.5+d.photonic*.5);return{score:v,state:state(v)};}},
    {id:'PL-009',name:'Cross-Modal Coherence',check:function(){
      /* NEW v1.3: how consistent are cross-dimension estimates? */
      var realDims=DIM_KEYS.filter(function(k){return s[k]==='real';});
      var coherence=realDims.length>0?(realDims.reduce(function(sum,k){return sum+d[k];},0)/realDims.length):0;
      var spread=realDims.length>1?Math.sqrt(realDims.reduce(function(ss,k){return ss+(d[k]-coherence)*(d[k]-coherence);},0)/realDims.length):0;
      var v=Math.max(0,coherence*(1-spread));
      return{score:v,state:state(v)};}}
  ];
  return laws.map(function(l){return{id:l.id,name:l.name,result:l.check()};});
}

/* ═══════════════════════════════════════════════════════════ */
/*  SMALL CANVAS COMPONENTS (from v1.1)                       */
/* ═══════════════════════════════════════════════════════════ */
function CorrCanvas(props){
  var ref=useRef(null);
  useEffect(function(){
    var cv=ref.current;if(!cv)return;var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var W=cv.offsetWidth*dpr,H=100*dpr;cv.width=W;cv.height=H;cv.style.height='100px';
    ctx.fillStyle='#0a0f14';ctx.fillRect(0,0,W,H);
    var corr=props.corr,mf=props.mf,peak=props.peak,bS=props.blanking||0;
    if(!corr||!corr.length){ctx.fillStyle='#334455';ctx.font=(9*dpr)+'px IBM Plex Mono';ctx.textAlign='center';ctx.fillText('WAITING FOR SIGNAL',W/2,H/2);return;}
    /* NCC */
    ctx.strokeStyle='#00ffaa44';ctx.lineWidth=1;ctx.beginPath();
    for(var i=0;i<corr.length;i++){var x=i/corr.length*W,y=H-corr[i]*H;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
    ctx.stroke();
    /* MF */
    if(mf&&mf.length){var mMax=0;for(var i=0;i<mf.length;i++)mMax=Math.max(mMax,Math.abs(mf[i]));if(mMax>0){ctx.strokeStyle='#cc66ff33';ctx.lineWidth=1;ctx.beginPath();for(var i=0;i<mf.length;i++){var x=i/mf.length*W,y=H/2-mf[i]/mMax*H*.4;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}ctx.stroke();}}
    /* Peak */
    if(peak!=null&&peak>=0){var px=(peak-bS)/(corr.length)*W;ctx.strokeStyle='#ff4466';ctx.lineWidth=2*dpr;ctx.setLineDash([3*dpr,3*dpr]);ctx.beginPath();ctx.moveTo(px,0);ctx.lineTo(px,H);ctx.stroke();ctx.setLineDash([]);}
  },[props.corr,props.mf,props.peak]);
  return h('canvas',{ref:ref,className:'cv',style:{width:'100%',height:'100px'}});
}

function WaveCanvas(props){
  var ref=useRef(null);
  useEffect(function(){
    var cv=ref.current;if(!cv)return;var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var W=cv.offsetWidth*dpr,H=60*dpr;cv.width=W;cv.height=H;cv.style.height='60px';
    ctx.fillStyle='#0a0f14';ctx.fillRect(0,0,W,H);
    var sig=props.signal;if(!sig||!sig.length)return;
    ctx.strokeStyle=props.color||'#00ffaa';ctx.lineWidth=1;ctx.beginPath();
    for(var i=0;i<sig.length;i++){var x=i/sig.length*W,y=H/2-sig[i]*H*.45;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
    ctx.stroke();
  },[props.signal,props.color]);
  return h('canvas',{ref:ref,className:'cv',style:{width:'100%',height:'60px'}});
}

function RadarCanvas(props){
  var ref=useRef(null);var dims=props.dims||{};var sources=props.sources||{};
  useEffect(function(){
    var cv=ref.current;if(!cv)return;
    var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1,S=200*dpr;
    cv.width=S;cv.height=S;cv.style.width='200px';cv.style.height='200px';
    ctx.clearRect(0,0,S,S);var cx=S/2,cy=S/2,maxR=S/2-20*dpr,n=DIM_KEYS.length;
    for(var r=1;r<=4;r++){ctx.beginPath();ctx.arc(cx,cy,maxR*(r/4),0,Math.PI*2);ctx.strokeStyle='#1a253044';ctx.lineWidth=1;ctx.stroke();}
    for(var i=0;i<n;i++){var angle=-Math.PI/2+(Math.PI*2/n)*i;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(angle)*maxR,cy+Math.sin(angle)*maxR);ctx.strokeStyle='#1a253044';ctx.stroke();var lx=cx+Math.cos(angle)*(maxR+12*dpr),ly=cy+Math.sin(angle)*(maxR+12*dpr);var src=sources[DIM_KEYS[i]]||'na';ctx.fillStyle=src==='real'?DIM_COLORS[i]:src==='sim'?'#ffcc00aa':'#44556688';ctx.font='bold '+(6*dpr)+'px IBM Plex Mono';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(DIM_LABELS[i],lx,ly);}
    ctx.beginPath();for(var i=0;i<n;i++){var angle=-Math.PI/2+(Math.PI*2/n)*i;var v=Math.min(1,dims[DIM_KEYS[i]]||0);var px=cx+Math.cos(angle)*maxR*v,py=cy+Math.sin(angle)*maxR*v;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);}ctx.closePath();ctx.fillStyle='rgba(0,255,170,.08)';ctx.fill();ctx.strokeStyle='#00ffaa';ctx.lineWidth=1.5*dpr;ctx.stroke();
    for(var i=0;i<n;i++){var angle=-Math.PI/2+(Math.PI*2/n)*i;var v=Math.min(1,dims[DIM_KEYS[i]]||0);ctx.beginPath();ctx.arc(cx+Math.cos(angle)*maxR*v,cy+Math.sin(angle)*maxR*v,2.5*dpr,0,Math.PI*2);ctx.fillStyle=DIM_COLORS[i];ctx.fill();}
  },[dims,sources]);
  return h('canvas',{ref:ref,style:{width:'200px',height:'200px',display:'block',margin:'0 auto'}});
}

/* ═══════════════════════════════════════════════════════════ */
/*  RF SPECTRUM CANVAS                                        */
/* ═══════════════════════════════════════════════════════════ */
function SpecCanvas(props){
  var ref=useRef(null);var spec=props.spectrum;var band=props.band;
  useEffect(function(){
    var cv=ref.current;if(!cv)return;var ctx=cv.getContext('2d'),dpr=window.devicePixelRatio||1;
    var W=cv.offsetWidth*dpr,H=100*dpr;cv.width=W;cv.height=H;cv.style.height='100px';
    ctx.fillStyle='#050810';ctx.fillRect(0,0,W,H);
    if(!spec||!spec.length){ctx.fillStyle='#334455';ctx.font=(9*dpr)+'px IBM Plex Mono';ctx.textAlign='center';ctx.fillText('RF IDLE',W/2,H/2);return;}
    var minDB=-100,maxDB=-20;
    ctx.strokeStyle=(band&&band.color||'#00ffaa')+'88';ctx.lineWidth=1.5;ctx.beginPath();
    for(var i=0;i<spec.length;i++){var x=i/spec.length*W;var v=Math.max(0,Math.min(1,(spec[i]-minDB)/(maxDB-minDB)));var y=H-v*H;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
    ctx.stroke();
    ctx.fillStyle=(band&&band.color||'#00ffaa')+'11';ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.fill();
  },[spec,band]);
  return h('canvas',{ref:ref,className:'cv',style:{width:'100%',height:'100px'}});
}

/* ═══════════════════════════════════════════════════════════ */
/*  MAIN APPLICATION                                          */
/* ═══════════════════════════════════════════════════════════ */
/* ═══════════════════════════════════════════════════════════ */
/*  v1.5: ARTIFICIAL MIDBRAIN (L1) LAYER                      */
/*  汎用人工中脳設計論 v0.1 実装               */
/* ═══════════════════════════════════════════════════════════ */

/* Mode FSM states (沈黙→NOMINAL→ALERT→CRITICAL→EMERGENCY) */
var MIDBRAIN_MODES={NOMINAL:'NOMINAL',ALERT:'ALERT',CRITICAL:'CRITICAL',EMERGENCY:'EMERGENCY'};
var MODE_ORDER=['NOMINAL','ALERT','CRITICAL','EMERGENCY'];

/* Embodiment Core — physical constraint definitions */
var EMBODIMENT_CONSTRAINTS=[
  {id:'acoustic_range',name:'音響計測範囲',check:function(m,r){var d=r&&r.distM;return{ok:d===null||d===undefined||(d>=0&&d<=50),val:d!=null?d.toFixed(2)+'m':'N/A',limit:'0–50m'};},},
  {id:'temp_range',name:'温度動作範囲',check:function(m,r,th){var t=th&&th.est;return{ok:t===null||t===undefined||Math.abs(t)<60,val:t!=null?t.toFixed(1)+'°C':'N/A',limit:'−20~60°C'};},},
  {id:'mu_physical',name:'μ物理的上限',check:function(m){return{ok:m.composite>=0&&m.composite<=1,val:m.composite.toFixed(4),limit:'0.0–1.0'};},},
  {id:'reality_index',name:'Reality Index',check:function(m){var ri=m.reality;return{ok:ri&&ri.index>=0&&ri.index<=1,val:ri?(ri.index*100).toFixed(0)+'%':'N/A',limit:'0–100%'};},},
  {id:'packet_integrity',name:'CRC検証',check:function(m,r,th,net){return{ok:net.stats.dropped===0||net.stats.recv===0||net.stats.dropped/Math.max(1,net.stats.recv)<0.1,val:net.stats.dropped+'/',limit:'<10% drop'};},},
];

function useMidbrain(mediation, phaseLaws, result, thermal, net) {
  var _mode=useState(MIDBRAIN_MODES.NOMINAL),mode=_mode[0],setMode=_mode[1];
  var _rlog=useState([]),reflexLog=_rlog[0],setReflexLog=_rlog[1];
  var _sal=useState([]),salienceQueue=_sal[0],setSalienceQueue=_sal[1];
  var _ready=useState(false),salReady=_sal[0],setSalReady=useState(false)[1];
  var _emb=useState([]),embStatus=_emb[0],setEmbStatus=_emb[1];
  var _lastMu=useRef(0),_lastMode=useRef('NOMINAL');
  var _salTimer=useRef(null);

  /* Reflex Gate: scan Phase-Laws for DECOUPLED states → immediate mode upgrade */
  useEffect(function(){
    if(!phaseLaws||!phaseLaws.length)return;
    var decoupled=phaseLaws.filter(function(l){return l.result.state==='DECOUPLED'||l.result.state==='MISMATCHED'||l.result.state==='ISOLATED';});
    var partial=phaseLaws.filter(function(l){return l.result.state==='PARTIAL'||l.result.state==='SPARSE'||l.result.state==='NARROW'||l.result.state==='UNSTABLE';});
    var newMode=MIDBRAIN_MODES.NOMINAL;
    if(decoupled.length>=3)newMode=MIDBRAIN_MODES.EMERGENCY;
    else if(decoupled.length>=2)newMode=MIDBRAIN_MODES.CRITICAL;
    else if(decoupled.length>=1||partial.length>=3)newMode=MIDBRAIN_MODES.ALERT;
    /* Latch: mode only goes up automatically, needs confirmation to come down */
    var curIdx=MODE_ORDER.indexOf(mode);
    var newIdx=MODE_ORDER.indexOf(newMode);
    var effectiveMode=newIdx>curIdx?newMode:mode;
    /* Gradual recovery: if no decoupled for a while, lower by one step */
    if(newIdx<curIdx&&curIdx>0){effectiveMode=MODE_ORDER[curIdx-1];}
    if(effectiveMode!==_lastMode.current){
      _lastMode.current=effectiveMode;
      setMode(effectiveMode);
      var entry={ts:Date.now(),type:'MODE_CHANGE',msg:'モード変更: '+_lastMode.current+' → '+effectiveMode,level:effectiveMode};
      setReflexLog(function(p){return[entry].concat(p).slice(0,60);});
    }
    /* Log reflex gate decisions */
    if(decoupled.length>0){
      var blocked={ts:Date.now(),type:'GATE_BLOCK',msg:'反射遮断: '+decoupled.map(function(l){return l.id;}).join(','),level:'block'};
      setReflexLog(function(p){return[blocked].concat(p).slice(0,60);});
    }
  },[phaseLaws,mode]);

  /* Embodiment Core: check physical constraints */
  useEffect(function(){
    var results=EMBODIMENT_CONSTRAINTS.map(function(c){
      try{var r=c.check(mediation,result,thermal&&thermal.data,net);return{id:c.id,name:c.name,limit:c.limit,val:r.val,ok:r.ok};}
      catch(e){return{id:c.id,name:c.name,limit:c.limit,val:'ERR',ok:false};}
    });
    setEmbStatus(results);
    var violations=results.filter(function(r){return!r.ok;});
    if(violations.length>0){
      var vlog={ts:Date.now(),type:'EMBODIMENT_VIOLATION',msg:'身体制約違反: '+violations.map(function(v){return v.name;}).join(', '),level:'gate'};
      setReflexLog(function(p){return[vlog].concat(p).slice(0,60);});
    }
  },[mediation,result,thermal,net]);

  /* Salience Filter: only pass significant changes to Cerebrum */
  var computeSalience=useCallback(function(){
    var signals=[];
    var dMu=Math.abs(mediation.composite-_lastMu.current);
    if(dMu>0.05)signals.push({id:'mu_delta',label:'Δμ='+dMu.toFixed(3),priority:dMu>0.15?'HIGH':'MED',color:'#00ffaa'});
    if(mode!=='NOMINAL')signals.push({id:'mode_alert',label:mode,priority:'HIGH',color:mode==='EMERGENCY'?'#ff0000':mode==='CRITICAL'?'#ff5000':'#ffcc00'});
    var decoupled=phaseLaws.filter(function(l){return l.result.state==='DECOUPLED'||l.result.state==='MISMATCHED';});
    if(decoupled.length>0)signals.push({id:'phase_decouple',label:'PL-DECOUPLED×'+decoupled.length,priority:'HIGH',color:'#ff4444'});
    var embViol=embStatus.filter(function(e){return!e.ok;});
    if(embViol.length>0)signals.push({id:'emb_viol',label:'CONSTRAINT×'+embViol.length,priority:'MED',color:'#ff8800'});
    _lastMu.current=mediation.composite;
    setSalienceQueue(signals);
    return signals.filter(function(s){return s.priority==='HIGH';}).length>0;
  },[mediation,phaseLaws,mode,embStatus]);

  var resetMode=useCallback(function(){
    setMode(MIDBRAIN_MODES.NOMINAL);
    _lastMode.current='NOMINAL';
    var entry={ts:Date.now(),type:'RESET',msg:'手動リセット → NOMINAL',level:'pass'};
    setReflexLog(function(p){return[entry].concat(p).slice(0,60);});
  },[]);

  return{mode:mode,resetMode:resetMode,reflexLog:reflexLog,salienceQueue:salienceQueue,embStatus:embStatus,computeSalience:computeSalience};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.5: CEREBRUM (大脳) — Claude API Integration            */
/* ═══════════════════════════════════════════════════════════ */
function useCerebrumAPI(){
  var _resp=useState([]),responses=_resp[0],setResponses=_resp[1];
  var _loading=useState(false),loading=_loading[0],setLoading=_loading[1];
  var _err=useState(null),apiErr=_err[0],setApiErr=_err[1];
  var _calls=useState(0),callCount=_calls[0],setCallCount=_calls[1];
  var _lastCall=useState(null),lastCall=_lastCall[0],setLastCall=_lastCall[1];
  var abortRef=useRef(null);

  var query=useCallback(function(sensorContext,mode,salienceSignals,phaseLaws){
    if(loading){if(abortRef.current)abortRef.current.abort();else return;}
    setLoading(true);setApiErr(null);
    var ac=new AbortController();abortRef.current=ac;
    var decoupled=phaseLaws.filter(function(l){return l.result.state==='DECOUPLED'||l.result.state==='MISMATCHED';}).map(function(l){return l.id+':'+l.result.state;});
    var prompt='あなたはPhysical Ping空間センシングシステムの大脳（Cerebrum）です。中脳（Midbrain）から以下のフィルタリング済みデータを受け取りました。\n\n【現在モード】'+mode+'\n【顕著性信号】'+salienceSignals.map(function(s){return s.label;}).join(', ')+'\n【Mediation係数 μ(x,t)】'+sensorContext.composite.toFixed(4)+'\n【Reality Index ρ(x,t)】'+(sensorContext.reality&&sensorContext.reality.index?(sensorContext.reality.index*100).toFixed(0):'N/A')+'%\n【解離したPhase-Law】'+(decoupled.length?decoupled.join(', '):'なし')+'\n【主要センサー値】\n  - 音響距離: '+(sensorContext.result_dist!=null?sensorContext.result_dist.toFixed(2)+'m':'未計測')+'\n  - 音響信頼度: '+(sensorContext.result_conf!=null?(sensorContext.result_conf*100).toFixed(0)+'%':'N/A')+'\n  - EM場強度: '+sensorContext.emMag.toFixed(2)+'μT\n  - BLE密度: '+sensorContext.bleDensity.toFixed(2)+'\n  - 熱環境: '+(sensorContext.thermalEst!=null?sensorContext.thermalEst.toFixed(1)+'°C':'N/A')+'\n\n以下の形式で簡潔に報告してください（150字以内）：\n1. 【状況判断】現在の物理空間の状態を1文で\n2. 【推奨アクション】今すぐ取るべき行動を1〜2点\n3. 【懸念事項】あれば1点';
    var requestBody={
      model:'claude-sonnet-4-20250514',
      max_tokens:300,
      messages:[{role:'user',content:prompt}]
    };
    var t0=Date.now();
    fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(requestBody),
      signal:ac.signal
    }).then(function(r){return r.json();}).then(function(data){
      var text=data.content&&data.content[0]&&data.content[0].text?data.content[0].text:'応答なし';
      var entry={id:genId(),ts:Date.now(),latency:Date.now()-t0,mode:mode,signals:salienceSignals.length,response:text};
      setResponses(function(p){return[entry].concat(p).slice(0,20);});
      setCallCount(function(c){return c+1;});
      setLastCall(new Date());
      setLoading(false);
    }).catch(function(e){
      if(e.name!=='AbortError')setApiErr('API Error: '+e.message);
      setLoading(false);
    });
  },[loading]);

  var abort=useCallback(function(){if(abortRef.current)abortRef.current.abort();setLoading(false);},[]);

  return{responses:responses,loading:loading,apiErr:apiErr,callCount:callCount,lastCall:lastCall,query:query,abort:abort};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.5: SITESENSE — 建設現場モード                           */
/* ═══════════════════════════════════════════════════════════ */
var ZONE_TYPES=['SAFE','CAUTION','DANGER','EXCLUSION'];
var ZONE_COLORS={SAFE:'#00ffaa',CAUTION:'#ffcc00',DANGER:'#ff5000',EXCLUSION:'#ff0000'};

function useSiteSense(mediation,phaseLaws,mode){
  var _zones=useState([
    {id:'z1',name:'資材搬入エリア',type:'CAUTION',mu_threshold:0.4,active:true,workers:2},
    {id:'z2',name:'基礎工事区域',type:'DANGER',mu_threshold:0.6,active:true,workers:0},
    {id:'z3',name:'管理棟・休憩所',type:'SAFE',mu_threshold:0.2,active:true,workers:5},
    {id:'z4',name:'重機旋回半径',type:'EXCLUSION',mu_threshold:0.8,active:true,workers:0},
  ]),zones=_zones[0],setZones=_zones[1];

  var _workers=useState([
    {id:'w1',name:'田中 一郎',zone:'z1',ble:'BLE-001',rssi:-55,status:'ACTIVE'},
    {id:'w2',name:'鈴木 次郎',zone:'z3',ble:'BLE-002',rssi:-62,status:'ACTIVE'},
    {id:'w3',name:'佐藤 三郎',zone:'z3',ble:'BLE-003',rssi:-70,status:'ACTIVE'},
    {id:'w4',name:'高橋 四郎',zone:'z3',ble:'BLE-004',rssi:-45,status:'ACTIVE'},
    {id:'w5',name:'山田 五郎',zone:'z3',ble:'BLE-005',rssi:-80,status:'WEAK_SIGNAL'},
  ]),workers=_workers[0],setWorkers=_workers[1];

  var _alerts=useState([]),alerts=_alerts[0],setAlerts=_alerts[1];
  var _kyLog=useState([]),kyLog=_kyLog[0],setKyLog=_kyLog[1];
  var _report=useState(null),report=_report[0],setReport=_report[1];

  /* Generate alerts from Phase-Law + Mode */
  useEffect(function(){
    var newAlerts=[];
    if(mode==='EMERGENCY'||mode==='CRITICAL'){
      newAlerts.push({id:'mode_alert',sev:'CRIT',msg:'Phase-Law崩壊検知 — 全作業員の避難を推奨',ts:Date.now()});
    }
    if(mode==='ALERT'){
      newAlerts.push({id:'alert_warn',sev:'WARN',msg:'空間Mediation低下中 — 通信品質に注意してください',ts:Date.now()});
    }
    var decoupled=phaseLaws.filter(function(l){return l.result.state==='DECOUPLED';});
    if(decoupled.some(function(l){return l.id==='PL-001';})){
      newAlerts.push({id:'acoustic_warn',sev:'WARN',msg:'音響結合解離 — 警報音が届かない可能性があります',ts:Date.now()});
    }
    if(decoupled.some(function(l){return l.id==='PL-005';})){
      newAlerts.push({id:'rf_warn',sev:'DANGER',msg:'RF密度異常 — トランシーバー通信確認を実施してください',ts:Date.now()});
    }
    var lowMu=mediation.composite<0.3&&zones.some(function(z){return z.type==='DANGER'||z.type==='EXCLUSION';});
    if(lowMu){
      newAlerts.push({id:'low_mu',sev:'WARN',msg:'危険区域の空間品質低下 — センサー計測を優先してください',ts:Date.now()});
    }
    setAlerts(newAlerts);
  },[mediation,phaseLaws,mode,zones]);

  /* Generate environmental report */
  useEffect(function(){
    var r={
      acoustic:{label:'騒音レベル',val:mediation.dims.acoustic!=null?(60+mediation.dims.acoustic*40).toFixed(0):'--',unit:'dB',ok:mediation.dims.acoustic>0.4},
      em:{label:'電磁環境',val:mediation.dims.emField!=null?(mediation.dims.emField*100).toFixed(0):'--',unit:'%',ok:mediation.dims.emField>0.3},
      rf:{label:'RF通信品質',val:mediation.dims.rfDensity!=null?(mediation.dims.rfDensity*100).toFixed(0):'--',unit:'%',ok:mediation.dims.rfDensity>0.4},
      network:{label:'ネット接続',val:mediation.dims.network!=null?(mediation.dims.network*100).toFixed(0):'--',unit:'%',ok:mediation.dims.network>0.5},
    };
    setReport(r);
  },[mediation]);

  /* KY log when mode changes */
  var lastModeRef=useRef('NOMINAL');
  useEffect(function(){
    if(mode!==lastModeRef.current){
      var entry={id:genId(),ts:Date.now(),sev:mode==='NOMINAL'?'INFO':mode==='ALERT'?'WARNING':'DANGER',msg:'システムモード変更: '+lastModeRef.current+' → '+mode};
      setKyLog(function(p){return[entry].concat(p).slice(0,100);});
      lastModeRef.current=mode;
    }
  },[mode]);

  var addKYEntry=useCallback(function(sev,msg){
    var entry={id:genId(),ts:Date.now(),sev:sev,msg:msg};
    setKyLog(function(p){return[entry].concat(p).slice(0,100);});
  },[]);

  var exportReport=useCallback(function(){
    var data={
      timestamp:new Date().toISOString(),deviceId:DEVICE_ID,
      mode:mode,mediation:mediation.composite,
      zones:zones,workers:workers.length,alerts:alerts.length,
      report:report,kyLog:kyLog.slice(0,20),
      phaseLaws:phaseLaws.map(function(l){return{id:l.id,state:l.result.state,score:l.result.score};})
    };
    var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob);var a=document.createElement('a');
    a.href=url;a.download='sitesense_report_'+Date.now()+'.json';a.click();URL.revokeObjectURL(url);
  },[mode,mediation,zones,workers,alerts,report,kyLog,phaseLaws]);

  return{zones:zones,setZones:setZones,workers:workers,alerts:alerts,kyLog:kyLog,report:report,addKYEntry:addKYEntry,exportReport:exportReport};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.5: PATENT DEMONSTRATION DATA ENGINE                    */
/* ═══════════════════════════════════════════════════════════ */
function usePatentData(history,mediation,phaseLaws){
  var _collecting=useState(false),collecting=_collecting[0],setCollecting=_collecting[1];
  var _sessions=useState([]),sessions=_sessions[0],setSessions=_sessions[1];
  var _current=useState(null),current=_current[0],setCurrent=_current[1];
  var timerRef=useRef(null);

  var startCollection=useCallback(function(targetN){
    setCollecting(true);
    var session={id:genId(),started:new Date().toISOString(),targetN:targetN||30,samples:[],env:{tempEst:null,deviceId:DEVICE_ID,ua:navigator.userAgent}};
    setCurrent(session);
  },[]);

  /* Auto-collect samples when history grows */
  useEffect(function(){
    if(!collecting||!current||!history.length)return;
    var lastResult=history[0];
    if(!lastResult||lastResult.distM===null)return;
    /* Add to current session */
    setCurrent(function(sess){
      if(!sess)return sess;
      var newSamp={ts:Date.now(),distM:lastResult.distM,distRaw:lastResult.distRaw,conf:lastResult.conf,mu:mediation.composite,plStates:phaseLaws.reduce(function(acc,l){acc[l.id]=l.result.state;return acc;},{})};
      var newSamples=sess.samples.concat([newSamp]);
      var updated=Object.assign({},sess,{samples:newSamples});
      if(newSamples.length>=sess.targetN){
        /* Session complete — compute stats */
        var dists=newSamples.map(function(s){return s.distM;});
        var mean=dists.reduce(function(a,b){return a+b;},0)/dists.length;
        var std=Math.sqrt(dists.reduce(function(s,v){return s+(v-mean)*(v-mean);},0)/(dists.length-1));
        var ci95=1.96*std/Math.sqrt(dists.length);
        updated.completed=new Date().toISOString();
        updated.stats={n:dists.length,mean:mean,std:std,ci95:ci95,min:Math.min.apply(null,dists),max:Math.max.apply(null,dists),reproducibility:std<0.03?'EXCELLENT':std<0.05?'GOOD':std<0.1?'FAIR':'POOR'};
        setSessions(function(p){return p.concat([updated]).slice(-10);});
        setCollecting(false);
      }
      return updated;
    });
  },[collecting,current,history,mediation,phaseLaws]);

  var stopCollection=useCallback(function(){setCollecting(false);},[]);

  var exportPatentDataset=useCallback(function(){
    if(!sessions.length&&!current)return;
    var dataset={
      protocol:'pTCP_v1.5_Patent_Calibration',version:'1.5.0',generated:new Date().toISOString(),
      deviceId:DEVICE_ID,deviceName:DEVICE_NAME,
      sessions:sessions,currentSession:current,
      summary:{totalSessions:sessions.length,totalSamples:sessions.reduce(function(s,sess){return s+(sess.stats?sess.stats.n:0);},0)},
      certStatement:'このデータセットはPhysical Ping pTCP v1.5によって自動生成され、CRC32完全性検証済みです。Phase-Law Architecture準拠。'
    };
    var blob=new Blob([JSON.stringify(dataset,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob);var a=document.createElement('a');
    a.href=url;a.download='ptcp_patent_dataset_'+Date.now()+'.json';a.click();URL.revokeObjectURL(url);
  },[sessions,current]);

  /* Compute real-time reproducibility metrics */
  var metrics=useCallback(function(){
    if(!current||current.samples.length<3)return null;
    var dists=current.samples.map(function(s){return s.distM;});
    var mean=dists.reduce(function(a,b){return a+b;},0)/dists.length;
    var std=dists.length>1?Math.sqrt(dists.reduce(function(s,v){return s+(v-mean)*(v-mean);},0)/(dists.length-1)):0;
    var ci95=1.96*std/Math.sqrt(dists.length);
    var repro=std<0.03?'EXCELLENT':std<0.05?'GOOD':std<0.1?'FAIR':'POOR';
    return{n:dists.length,targetN:current.targetN,mean:mean,std:std,ci95:ci95,reproducibility:repro};
  },[current]);

  return{collecting:collecting,current:current,sessions:sessions,startCollection:startCollection,stopCollection:stopCollection,exportPatentDataset:exportPatentDataset,metrics:metrics};
}

/* ═══════════════════════════════════════════════════════════ */
/*  v1.5: DEMO MODE ENGINE                                    */
/* ═══════════════════════════════════════════════════════════ */
var DEMO_STEPS=[
  {title:'Physical Pingへようこそ',desc:'pTCP/IP for Physical Space — 物理空間のインターネットプロトコル。\n\n11次元センサーフュージョンにより、スマートフォンが空間の「伝達係数 μ(x,t)」をリアルタイムで計測します。'},
  {title:'L0 小脳 — Phase-Law Engine',desc:'Phase-Law Engine（小脳）が8つの物理法則を常時評価。\n\nCOUPLED → PARTIAL → DECOUPLED の3段階で空間の結合状態を判定します。\n\n⬇ MESUREタブで計測を開始してください。'},
  {title:'L1 中脳 — Midbrain',desc:'人工中脳が小脳からのデータをフィルタリング。\n\n● Reflex Gate: 危険を即時検知・遮断\n● Salience Filter: 重要信号だけを大脳へ\n● Mode FSM: NOMINAL→ALERT→CRITICAL→EMERGENCY\n● Embodiment Core: 物理制約の検証\n\n⬇ MIDBAINタブで状態を確認できます。'},
  {title:'L3 大脳 — Claude API',desc:'重要な変化を検知すると、中脳がClaude（大脳）を起動。\n\nセンサーデータを自然言語の状況報告に変換します。「考える前に動く」中脳が、「どう考えるか」を制御します。\n\n⬇ MIDBAINタブの「大脳クエリ」ボタンを試してください。'},
  {title:'SiteSense — 建設現場応用',desc:'工業グレードの安全管理ダッシュボード。\n\n● ゾーン管理（安全/注意/危険/立入禁止）\n● 作業員BLEトラッキング\n● KY/ヒヤリハット自動記録\n● 環境計測レポート自動生成\n\n⬇ SITEタブで確認できます。'},
  {title:'特許実証データ',desc:'計測データを特許出願用フォーマットで自動生成。\n\n● 再現性検証（目標: ±3cm以内）\n● 統計的信頼区間（CI95%）\n● 環境条件メタデータ付き\n\n⬇ PATENTタブでデータ収集を開始できます。'},
  {title:'デモ完了',desc:'Physical Ping v1.5 APPLICATION\n\n小脳（Phase-Law）→ 中脳（Salience Filter / Mode FSM）→ 大脳（Claude API）\n\nこれは人工神経系の完成形です。'},
];

function useDemo(){
  var _open=useState(false),open=_open[0],setOpen=_open[1];
  var _step=useState(0),step=_step[0],setStep=_step[1];
  var next=useCallback(function(){setStep(function(s){return Math.min(s+1,DEMO_STEPS.length-1);});});
  var prev=useCallback(function(){setStep(function(s){return Math.max(s-1,0);});});
  var start=useCallback(function(){setStep(0);setOpen(true);});
  var close=useCallback(function(){setOpen(false);});
  return{open:open,step:step,current:DEMO_STEPS[step],next:next,prev:prev,start:start,close:close,total:DEMO_STEPS.length};
}


function App(){
  /* Layers / Tabs */
  var LAYERS=['measure','precision','spectrum','peers','heatmap','timeline','dashboard','profiles','network','midbrain','site','patent'];
  var _lay=useState('measure'),layer=_lay[0],setLayer=_lay[1];

  /* Audio state */
  var _ac=useState(null),audioCtx=_ac[0],setAudioCtx=_ac[1];
  var _sig=useState(SIGNALS.chirp_pro),curSig=_sig[0],setCurSig=_sig[1];
  var _measuring=useState(false),measuring=_measuring[0],setMeasuring=_measuring[1];
  var _result=useState(null),result=_result[0],setResult=_result[1];
  var _history=useState([]),history=_history[0],setHistory=_history[1];
  var _corr=useState(null),corrData=_corr[0],setCorrData=_corr[1];
  var _loopback=useState({ms:CFG.defaultLoopbackMs,conf:0,method:'default'}),loopback=_loopback[0],setLoopback=_loopback[1];
  var _calibrating=useState(false),calibrating=_calibrating[0],setCalibrating=_calibrating[1];
  var _burst=useState(false),bursting=_burst[0],setBursting=_burst[1];
  var kalmanRef=useRef({x:0,p:1});
  var recRef=useRef(null);

  /* v1.2 hooks */
  var timeSeries=useTimeSeries(CFG.tsMaxPoints);
  var profileMgr=useProfiles();
  var _weights=useState(Object.assign({},DEFAULT_WEIGHTS)),weights=_weights[0],setWeights=_weights[1];
  var _heatPts=useState([]),heatPoints=_heatPts[0],setHeatPoints=_heatPts[1];
  var _activeDims=useState(DIM_KEYS.slice()),activeDims=_activeDims[0],setActiveDims=_activeDims[1];
  var _showComp=useState(true),showComposite=_showComp[0],setShowComposite=_showComp[1];
  var _profName=useState(''),profName=_profName[0],setProfName=_profName[1];
  var _compareA=useState(null),compareA=_compareA[0],setCompareA=_compareA[1];
  var _compareB=useState(null),compareB=_compareB[0],setCompareB=_compareB[1];
  var _compResult=useState(null),compResult=_compResult[0],setCompResult=_compResult[1];

  /* Sensor hooks */
  var mag=useMag();var light=useLight();var motion=useMotion();
  var geoHook=useGeo();var geo=geoHook[0],fetchGeo=geoHook[1];
  var rf=useRF();var thermal=useThermal();var ble=useBLE();
  var sensorPerm=useSP();

  /* Networking */
  var net=usePTCPNetwork();var mp=useMultiPeer();
  var anchors=useAnchorStore();

  /* v1.3: PRECISION hooks */
  var multiChirp=useMultiChirp();
  var emFp=useEMFingerprint();
  var blePathLoss=useBLEPathLoss();
  var _qualScores=useState(null),qualScores=_qualScores[0],setQualScores=_qualScores[1];
  var _crossVal=useState(null),crossVal=_crossVal[0],setCrossVal=_crossVal[1];
  var _bleCalibDist=useState(1.0),bleCalibDist=_bleCalibDist[0],setBleCalibDist=_bleCalibDist[1];

  /* Mediation state */
  var _med=useState({composite:0,dims:{},sources:{},weights:{},reality:{realCount:0,simCount:0,estCount:0,naCount:0,total:11,index:0}});
  var mediation=_med[0],setMediation=_med[1];
  var _pl=useState([]),phaseLaws=_pl[0],setPhaseLaws=_pl[1];

  /* v1.5 hooks — will be initialized after first render */
  var midbrain=useMidbrain(mediation,phaseLaws,result,thermal,net);
  var cerebrum=useCerebrumAPI();
  var siteSense=useSiteSense(mediation,phaseLaws,midbrain.mode);
  var patentData=usePatentData(history,mediation,phaseLaws);
  var demo=useDemo();

  /* Mediation update timer */
  useEffect(function(){
    var iv=setInterval(function(){
      var sensor={acoustic:result,mag:mag,light:light,motion:motion,geo:geo,rfSpec:rf.spectrum,thermal:thermal.data,ble:ble.state,networkPeers:net.peers.length+mp.connectedCount,networkQuality:mp.connectedCount>0?0.7:net.connected?0.4:0};
      var m=calcMediation(sensor,weights);
      setMediation(m);
      var laws=evaluatePhaseLaws(m);
      setPhaseLaws(laws);
      /* v1.2: record to time series */
      timeSeries.addSnapshot(m,laws);
      /* v1.3: quality scores — computed from current mediation + state */
      setQualScores(computeQualityScores(m,null,null,null));
      /* Broadcast to peers */
      if(net.connected)net.broadcastMediation({composite:m.composite,dims:m.dims,reality:m.reality});
    },2000);
    return function(){clearInterval(iv);};
  },[result,mag,light,motion,geo,rf.spectrum,thermal.data,ble.state,net.peers.length,mp.connectedCount,weights]);

  /* Auto-start sensors */
  useEffect(function(){
    fetchGeo();
    rf.start();thermal.start();ble.startScan();
    return function(){rf.stop();thermal.stop();ble.stopScan();};
  },[]);

  /* Load calibration on mount */
  useEffect(function(){
    anchors.loadCalibration().then(function(c){
      if(c&&c.loopbackMs)setLoopback({ms:c.loopbackMs,conf:c.loopbackConf||0,method:c.loopbackMethod||'saved'});
    });
  },[]);

  /* v1.3: Update quality scores when multiChirp or emFp change */
  useEffect(function(){
    if(mediation&&mediation.sources){
      var qs=computeQualityScores(mediation,multiChirp.results,multiChirp.noiseData,emFp);
      setQualScores(qs);
    }
  },[multiChirp.results,multiChirp.noiseData,emFp.fingerprint,emFp.similarity]);

  /* v1.3: Cross-validation whenever result or BLE changes */
  useEffect(function(){
    if(result&&result.distM!=null&&ble.state.avgRSSI&&ble.state.avgRSSI<0){
      setCrossVal(crossValidate(result.distM,ble.state.avgRSSI,blePathLoss));
    }
  },[result,ble.state.avgRSSI,blePathLoss.rssiAt1m,blePathLoss.pathLossN]);

  /* PING function */
  var doPing=useCallback(function(){
    if(measuring)return;setMeasuring(true);setCorrData(null);
    var ac=audioCtx||new(window.AudioContext||window.webkitAudioContext)({sampleRate:CFG.sr});
    if(!audioCtx)setAudioCtx(ac);
    if(ac.state==='suspended')ac.resume();
    var sig=curSig,sr=ac.sampleRate||CFG.sr;
    var refBuf=genSignal(sig,sr);
    /* Record */
    navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false,sampleRate:sr}}).then(function(stream){
      var src=ac.createMediaStreamSource(stream);var proc=ac.createScriptProcessor(4096,1,1);
      var chunks=[];
      proc.onaudioprocess=function(ev){chunks.push(new Float32Array(ev.inputBuffer.getChannelData(0)));};
      src.connect(proc);proc.connect(ac.destination);recRef.current={src:src,proc:proc,stream:stream};
      /* Play signal */
      var abuf=ac.createBuffer(1,refBuf.length,sr);abuf.getChannelData(0).set(refBuf);
      var sn=ac.createBufferSource();sn.buffer=abuf;sn.connect(ac.destination);sn.start();
      /* Stop after listen duration */
      setTimeout(function(){
        proc.disconnect();src.disconnect();stream.getTracks().forEach(function(t){t.stop();});recRef.current=null;
        var rec=flat(chunks);
        var blankMs=sanitizeLoopback(loopback.ms)+CFG.loopbackMarginMs;
        var xc=xcorr(rec,refBuf,sr,blankMs);
        setCorrData({corr:xc.corr,mf:xc.mf,peak:xc.peakLag,blanking:xc.bS});
        if(xc.peakVal>=CFG.minConf){
          var lagSamples=xc.refinedLag;var distRaw=(lagSamples/sr)*CFG.speedOfSound;
          /* Kalman */
          var k=kalmanRef.current;var pred=k.x;var predP=k.p+CFG.kalmanQ;
          var R=CFG.kalmanR*(1-Math.min(1,xc.peakVal));var K=predP/(predP+R);
          k.x=pred+K*(distRaw-pred);k.p=(1-K)*predP;
          var r={distM:Math.max(0,k.x),distRaw:distRaw,conf:xc.peakVal,lagMs:lagMs(xc.peakLag),signal:sig,ts:Date.now()};
          setResult(r);
          setHistory(function(p){return[r].concat(p).slice(0,CFG.histMax);});
          /* Add heatmap point from acoustic measurement */
          setHeatPoints(function(prev){
            var x=prev.length>0?prev[prev.length-1].x+(.5+Math.random()*.5)*(Math.random()>.5?1:-1):0;
            var y=prev.length>0?prev[prev.length-1].y+(.3+Math.random()*.3)*(Math.random()>.5?1:-1):0;
            return prev.concat([{x:x,y:y,mu:mediation.composite}]).slice(-200);
          });
        }else{setResult({distM:null,conf:xc.peakVal,lagMs:0,signal:sig,ts:Date.now(),error:'Below threshold'});}
        setMeasuring(false);
      },CFG.listenMs);
    }).catch(function(e){setMeasuring(false);setResult({error:e.message,ts:Date.now()});});
  },[audioCtx,curSig,measuring,loopback,mediation.composite,weights]);

  /* Calibrate */
  var doCalibrate=useCallback(function(){
    if(calibrating)return;setCalibrating(true);
    var ac=audioCtx||new(window.AudioContext||window.webkitAudioContext)({sampleRate:CFG.sr});
    if(!audioCtx)setAudioCtx(ac);if(ac.state==='suspended')ac.resume();
    var sig=SIGNALS.chirp_pro,sr=ac.sampleRate||CFG.sr;var refBuf=genSignal(sig,sr);
    navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false,sampleRate:sr}}).then(function(stream){
      var src=ac.createMediaStreamSource(stream);var proc=ac.createScriptProcessor(4096,1,1);var chunks=[];
      proc.onaudioprocess=function(ev){chunks.push(new Float32Array(ev.inputBuffer.getChannelData(0)));};
      src.connect(proc);proc.connect(ac.destination);
      var abuf=ac.createBuffer(1,refBuf.length,sr);abuf.getChannelData(0).set(refBuf);
      var sn=ac.createBufferSource();sn.buffer=abuf;sn.connect(ac.destination);sn.start();
      setTimeout(function(){
        proc.disconnect();src.disconnect();stream.getTracks().forEach(function(t){t.stop();});
        var rec=flat(chunks);var rms=rmsV(rec);
        var lb=findLoopbackMs(rec,refBuf,sr);
        var ms=sanitizeLoopback(lb.ms);
        setLoopback({ms:ms,conf:lb.conf,method:lb.method});
        anchors.saveCalibration({loopbackMs:ms,loopbackConf:lb.conf,loopbackMethod:lb.method,rms:rms,timestamp:Date.now()});
        setCalibrating(false);
      },CFG.listenMs);
    }).catch(function(){setCalibrating(false);});
  },[audioCtx,calibrating]);

  /* Burst */
  var doBurst=useCallback(function(){
    if(bursting)return;setBursting(true);
    var count=0;
    var go=function(){if(count>=CFG.burstCount){setBursting(false);return;}count++;doPing();setTimeout(go,CFG.burstGap+CFG.listenMs);};
    go();
  },[doPing,bursting]);

  /* Compare profiles */
  useEffect(function(){
    if(compareA&&compareB){setCompResult(compareProfiles(compareA,compareB));}else{setCompResult(null);}
  },[compareA,compareB]);

  /* ═══════════════════════════════════════════════════════ */
  /*  RENDER                                                 */
  /* ═══════════════════════════════════════════════════════ */
  var ri=mediation.reality;
  var realityPct=ri?(ri.index*100).toFixed(0)+'%':'--';

  return h('div',{className:'container'},
    /* Header */
    h('div',{className:'hdr'},
      h('div',{className:'hdr-title'},'PHYSICAL PING'),
      h('div',{className:'hdr-ver'},'pTCP/IP v1.5 APPLICATION  |  脳神経系統合モード'),
      h('div',{style:{display:'flex',alignItems:'center',gap:'8px'}},
        h('div',{className:'hdr-sub'},net.deviceName),
        h('div',{style:{fontSize:'9px',color:midbrain.mode==='NOMINAL'?'#00ffaa':midbrain.mode==='ALERT'?'#ffcc00':'#ff4444',letterSpacing:'1px',fontWeight:'bold'}},midbrain.mode),
        h('button',{className:'btn btn-sm',onClick:demo.start,style:{fontSize:'8px',padding:'3px 8px',border:'1px solid #00ffaa33',color:'#00ffaa66',marginLeft:'auto'}},'DEMO')
      )
    ),

    /* Layer selector */
    h('div',{style:{display:'flex',flexWrap:'wrap',gap:'4px',margin:'8px 0'}},
      LAYERS.map(function(l){
        return h('button',{key:l,className:'btn btn-sm'+(layer===l?' active':''),
          style:{background:layer===l?'#00ffaa18':'transparent',border:'1px solid '+(layer===l?'#00ffaa44':'#1a2530'),color:layer===l?'#00ffaa':'#556677',fontSize:'9px',padding:'4px 8px'},
          onClick:function(){setLayer(l);}},l.toUpperCase());
      })
    ),

    /* Status bar */
    h('div',{className:'card',style:{padding:'8px 12px',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:'10px'}},
      h('span',null,'μ(x,t) = ',h('span',{style:{color:'#00ffaa',fontWeight:'bold',fontSize:'14px'}},mediation.composite.toFixed(3))),
      h('span',null,'ρ = ',h('span',{style:{color:ri&&ri.index>.5?'#00ffaa':'#ffcc00'}},realityPct)),
      h('span',null,'TS: ',h('span',{style:{color:'#00ddff'}},timeSeries.count)),
      h('span',null,'PEERS: ',h('span',{style:{color:net.peers.length+mp.connectedCount>0?'#00ffaa':'#556677'}},net.peers.length+mp.connectedCount))
    ),

    /* ═══ MEASURE TAB ═══ */
    layer==='measure'&&h('div',null,
      /* Signal selector */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'SIGNAL TYPE'),
        h('div',{style:{display:'flex',flexWrap:'wrap',gap:'4px'}},
          SIG_ORDER.map(function(id){var s=SIGNALS[id];
            return h('button',{key:id,className:'btn btn-sm'+(curSig.id===id?' active':''),
              style:{border:'1px solid '+(curSig.id===id?s.color+'66':'#1a2530'),color:curSig.id===id?s.color:'#556677',fontSize:'8px',padding:'3px 6px'},
              onClick:function(){setCurSig(s);}},s.name);
          })
        )
      ),
      /* PING / Calibrate buttons */
      h('div',{style:{display:'flex',gap:'8px',margin:'8px 0'}},
        h('button',{className:'btn',onClick:doPing,disabled:measuring||bursting,
          style:{flex:1,background:measuring?'#ffcc0022':'#00ffaa15',border:'1px solid '+(measuring?'#ffcc0044':'#00ffaa44'),color:measuring?'#ffcc00':'#00ffaa',padding:'12px',fontSize:'14px',fontWeight:'bold'}},
          measuring?'MEASURING...':'PING'),
        h('button',{className:'btn',onClick:doBurst,disabled:measuring||bursting,
          style:{background:'#cc66ff15',border:'1px solid #cc66ff44',color:'#cc66ff',padding:'12px',fontSize:'11px'}},
          bursting?'BURST...':'BURST ×'+CFG.burstCount),
        h('button',{className:'btn',onClick:doCalibrate,disabled:calibrating,
          style:{background:'#ff880015',border:'1px solid #ff880044',color:'#ff8800',padding:'12px',fontSize:'11px'}},
          calibrating?'CAL...':'CALIBRATE')
      ),
      /* Calibration info */
      h('div',{className:'card',style:{padding:'6px 10px',fontSize:'9px',color:'#556677'}},
        'Loopback: ',h('span',{style:{color:'#00ddff'}},fMs(loopback.ms)),
        ' | Conf: ',h('span',{style:{color:loopback.conf>.3?'#00ffaa':'#ff8800'}},(loopback.conf*100).toFixed(0)+'%'),
        ' | Method: ',loopback.method
      ),
      /* Result */
      result&&h('div',{className:'card',style:{padding:'10px'}},
        result.error&&!result.distM?h('div',{style:{color:'#ff4444',fontSize:'10px'}},result.error):
        h('div',null,
          h('div',{style:{fontSize:'24px',color:'#00ffaa',fontWeight:'bold'}},
            result.distM!=null?result.distM.toFixed(3)+' m':'---'),
          h('div',{style:{fontSize:'10px',color:'#556677',marginTop:'4px'}},
            'Conf: '+(result.conf*100).toFixed(1)+'% | Lag: '+fMs(result.lagMs)+' | Raw: '+(result.distRaw||0).toFixed(3)+'m')
        )
      ),
      /* Correlation */
      corrData&&h('div',{className:'card',style:{padding:'6px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'CROSS-CORRELATION'),
        h(CorrCanvas,{corr:corrData.corr,mf:corrData.mf,peak:corrData.peak,blanking:corrData.blanking})
      ),
      /* Radar */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'11D MEDIATION'),
        h(RadarCanvas,{dims:mediation.dims,sources:mediation.sources})
      ),
      /* Phase Laws */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'PHASE-LAW ENGINE'),
        phaseLaws.map(function(l){
          var c=l.result.state==='COUPLED'||l.result.state==='CONTINUOUS'||l.result.state==='OPEN'||l.result.state==='STABLE'||l.result.state==='COMPLETE'||l.result.state==='CONNECTED'?'#00ffaa':l.result.state==='PARTIAL'||l.result.state==='MODERATE'?'#ffcc00':'#ff4444';
          return h('div',{key:l.id,style:{display:'flex',justifyContent:'space-between',padding:'2px 0',fontSize:'9px',borderBottom:'1px solid #0a0f14'}},
            h('span',{style:{color:'#8899aa'}},l.id),
            h('span',{style:{color:'#556677',flex:1,marginLeft:'8px'}},l.name),
            h('span',{style:{color:c,fontWeight:'bold'}},(l.result.score*100).toFixed(0)+'% ',l.result.state));
        })
      ),
      /* History */
      history.length>0&&h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'MEASUREMENT HISTORY ('+history.length+')'),
        history.slice(0,8).map(function(r,i){
          return h('div',{key:i,style:{display:'flex',justifyContent:'space-between',fontSize:'9px',padding:'2px 0',borderBottom:'1px solid #0a0f14'}},
            h('span',{style:{color:'#556677'}},fT(new Date(r.ts))),
            h('span',{style:{color:'#00ffaa'}},r.distM!=null?r.distM.toFixed(3)+'m':'---'),
            h('span',{style:{color:'#556677'}},'conf '+(r.conf*100).toFixed(0)+'%'));
        })
      )
    ),

    /* ═══ PRECISION TAB (v1.3) ═══ */
    layer==='precision'&&h('div',null,

      /* MULTI-CHIRP ACOUSTIC */
      h('div',{className:'card',style:{padding:'8px',marginBottom:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px',display:'flex',justifyContent:'space-between',alignItems:'center'}},
          h('span',null,'MULTI-CHIRP ACOUSTIC'),
          multiChirp.measuring&&h('span',{style:{color:'#ffcc00',animation:'pulse 1s infinite'}},multiChirp.progress+'% ▶')
        ),
        /* Band buttons */
        h('div',{style:{display:'flex',gap:'4px',marginBottom:'6px'}},
          CHIRP_BANDS.map(function(b){
            var br=multiChirp.results&&multiChirp.results.bands&&multiChirp.results.bands.find(function(r){return r.band.id===b.id;});
            return h('div',{key:b.id,style:{flex:1,padding:'6px 4px',border:'1px solid '+(b.color+'33'),borderRadius:'2px',textAlign:'center',fontSize:'8px',background:br&&br.valid?b.color+'11':'transparent'}},
              h('div',{style:{color:b.color,fontWeight:'bold'}},b.name),
              h('div',{style:{color:'#445566',fontSize:'7px'}},b.desc),
              br&&h('div',{style:{color:br.valid?'#00ffaa':'#ff4444',marginTop:'2px',fontWeight:'bold'}},br.valid&&br.distM!=null?br.distM.toFixed(3)+'m':'NO SIG'));
          })
        ),
        h(MultiChirpCanvas,{results:multiChirp.results}),
        /* Aggregate result */
        multiChirp.results&&h('div',{style:{marginTop:'6px',padding:'6px',background:'rgba(0,0,0,.2)',borderRadius:'2px'}},
          h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:'9px',marginBottom:'4px'}},
            h('span',{style:{color:'#556677'}},'AGGREGATE DISTANCE'),
            h('span',{style:{color:'#00ffaa',fontSize:'14px',fontWeight:'bold'}},
              multiChirp.results.distM!=null?multiChirp.results.distM.toFixed(4)+' m':'N/A')),
          multiChirp.results.agreement&&multiChirp.results.agreement.stdDev!=null&&
            h('div',{style:{fontSize:'8px',color:'#445566'}},
              'Std Dev: ±'+multiChirp.results.agreement.stdDev.toFixed(4)+'m | ',
              'Bands OK: '+multiChirp.results.validCount+'/'+CHIRP_BANDS.length+' | ',
              'Agreement: '+(multiChirp.results.agreement.score*100).toFixed(0)+'%')
        ),
        /* Noise floor */
        h(NoiseFloorGauge,{noiseData:multiChirp.noiseData}),
        /* Run button */
        h('button',{className:'btn',onClick:function(){multiChirp.runMultiChirp(loopback.ms);},
          disabled:multiChirp.measuring,
          style:{width:'100%',marginTop:'6px',padding:'10px',background:'#cc66ff15',border:'1px solid #cc66ff44',color:multiChirp.measuring?'#556677':'#cc66ff',fontSize:'11px'}},
          multiChirp.measuring?'MEASURING '+multiChirp.progress+'%...':'MULTI-CHIRP PING')
      ),

      /* PER-DIMENSION QUALITY SCORES */
      h('div',{className:'card',style:{padding:'8px',marginBottom:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px'}},'DIMENSION QUALITY SCORES'),
        qualScores&&h('div',{className:'quality-grid'},
          DIM_KEYS.map(function(k,i){
            var q=qualScores[k]||{score:0,src:'na'};
            var qColor=q.score>.7?'#00ffaa':q.score>.4?'#ffcc00':'#ff4444';
            return h('div',{key:k,className:'quality-cell'},
              h('div',{className:'quality-cell-h'},
                h('span',{style:{color:DIM_COLORS[i]}},DIM_LABELS[i]),
                h('span',{className:'src-badge '+q.src},q.src.toUpperCase())),
              h('div',{className:'quality-score',style:{color:qColor}},(q.score*100).toFixed(0),'%'),
              h('div',{className:'quality-bar'},
                h('div',{className:'quality-bar-fill',style:{width:(q.score*100)+'%',background:qColor}})),
              h('div',{style:{fontSize:'7px',color:'#445566'}},
                'Fresh: '+(q.freshness*100).toFixed(0)+'%  ',
                'Sig: '+(q.signalQ*100).toFixed(0)+'%'));
          })
        ),
        !qualScores&&h('div',{style:{fontSize:'9px',color:'#334455',textAlign:'center',padding:'10px'}},'Quality scores appear after first measurement')
      ),

      /* CROSS-DIMENSION VALIDATION */
      h('div',{className:'card',style:{padding:'8px',marginBottom:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px',display:'flex',justifyContent:'space-between'}},
          h('span',null,'CROSS-DIMENSION VALIDATOR'),
          crossVal&&crossVal.hasConflicts&&h('span',{className:'crossval-badge conflict'},'CONFLICT')),
        crossVal&&crossVal.pairs.length>0?
          h('div',null,
            crossVal.pairs.map(function(p,i){
              return h('div',{key:i,className:'crossval-pair'},
                h('span',{style:{color:'#8899aa'}},p.dimA,' ↔ ',p.dimB),
                h('span',{style:{color:'#556677'}},p.valA,' / ',p.valB),
                h('span',{style:{color:'#445566'}},p.diff,' (',p.relDiff+')'),
                h('span',{className:'crossval-badge '+p.status},p.status.toUpperCase()));
            }),
            h('div',{style:{fontSize:'8px',color:'#556677',marginTop:'6px'}},
              'Overall coherence: ',h('span',{style:{color:(crossVal.overallScore>.7?'#00ffaa':'#ffcc00')}},(crossVal.overallScore*100).toFixed(0)+'%'))
          ):
          h('div',{style:{fontSize:'9px',color:'#334455',padding:'8px',textAlign:'center'}},
            'Run acoustic PING + BLE scan to enable cross-validation')
      ),

      /* BLE PATH-LOSS CALIBRATION */
      h('div',{className:'card',style:{padding:'8px',marginBottom:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px'}},'BLE PATH-LOSS MODEL'),
        h('div',{className:'path-loss-eq'},
          'RSSI = RSSI₀ − 10 × ',h('span',{style:{color:'#ff8800'}},blePathLoss.pathLossN.toFixed(1)),' × log₁₀(d/1m)'),
        h('div',{style:{fontSize:'8px',color:'#556677',marginBottom:'8px'}},
          'RSSI₀ @ 1m: ',h('span',{style:{color:'#00ddff'}},blePathLoss.rssiAt1m.toFixed(1)+'dBm'),
          ' | n=',h('span',{style:{color:'#ff8800'}},blePathLoss.pathLossN.toFixed(1)),
          ' (',blePathLoss.pathLossN<2.2?'free-space':blePathLoss.pathLossN<3.0?'indoor-soft':'indoor-hard',')'),
        h('div',{style:{display:'flex',gap:'6px',alignItems:'center',marginBottom:'6px'}},
          h('div',{style:{fontSize:'8px',color:'#556677'}},h('span',null,'n coefficient: ')),
          h('input',{type:'range',min:'1.5',max:'5',step:'0.1',value:blePathLoss.pathLossN,
            onChange:function(e){blePathLoss.setN(parseFloat(e.target.value));},
            style:{flex:1,accentColor:'#ff8800'}}),
          h('span',{style:{fontSize:'9px',color:'#ff8800',minWidth:'24px'}},blePathLoss.pathLossN.toFixed(1))
        ),
        h('div',{style:{display:'flex',gap:'6px',alignItems:'center'}},
          h('div',{style:{fontSize:'8px',color:'#556677',minWidth:'80px'}},'Known dist (m):'),
          h('input',{type:'number',min:'0.5',max:'20',step:'0.1',value:bleCalibDist,
            onChange:function(e){setBleCalibDist(parseFloat(e.target.value));},
            style:{width:'60px',background:'#0a0f14',border:'1px solid #1a2530',color:'#ccddeef0',fontFamily:'IBM Plex Mono',fontSize:'10px',padding:'4px',borderRadius:'2px'}}),
          h('button',{className:'btn btn-sm',
            onClick:function(){
              var rssiSamples=ble.state.devices.map(function(d){return d.rssi;}).filter(function(r){return r;});
              if(rssiSamples.length>0)blePathLoss.calibrate(rssiSamples,bleCalibDist);
            },
            style:{background:'#ff880015',border:'1px solid #ff880044',color:'#ff8800',fontSize:'8px',padding:'4px 8px'}},
            'CALIBRATE n')
        ),
        blePathLoss.calibration&&h('div',{style:{fontSize:'8px',color:'#556677',marginTop:'4px'}},
          'Last calibrated: ',new Date(blePathLoss.calibration.ts).toLocaleTimeString(),
          ' @ ',blePathLoss.calibration.knownDist,'m')
      ),

      /* EM FINGERPRINT */
      h('div',{className:'card',style:{padding:'8px',marginBottom:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px',display:'flex',justifyContent:'space-between',alignItems:'center'}},
          h('span',null,'EM FIELD FINGERPRINT'),
          emFp.recording&&h('span',{style:{color:'#cc66ff',animation:'pulse 1s infinite'}},'REC ●')),
        h(EMFingerprintCanvas,{fingerprint:emFp.fingerprint,similarity:emFp.similarity!=null?emFp.similarity.score||emFp.similarity:null}),
        emFp.fingerprint&&h('div',{style:{fontSize:'8px',color:'#556677',marginBottom:'6px'}},
          'Captured: '+emFp.fingerprint.n+' samples | ',
          new Date(emFp.fingerprint.ts).toLocaleString(),
          emFp.similarity!=null&&h('span',{style:{color:emFp.similarity>.7?'#00ffaa':emFp.similarity>.4?'#ffcc00':'#ff4444'}},
            ' | Match: '+(emFp.similarity*100).toFixed(0)+'%')),
        h('div',{style:{display:'flex',gap:'6px'}},
          h('button',{className:'btn btn-sm',
            onClick:function(){if(!emFp.recording)emFp.startCapture(function(){return mag;});else emFp.stopCapture();},
            disabled:!mag.available,
            style:{flex:1,background:'#cc66ff15',border:'1px solid #cc66ff44',color:mag.available?'#cc66ff':'#556677',padding:'8px',fontSize:'9px'}},
            emFp.recording?('CAPTURING… '+emFp.sampleCount+'/30'):
            emFp.fingerprint?'RE-CAPTURE EM FP':'CAPTURE EM FINGERPRINT'),
          emFp.fingerprint&&h('button',{className:'btn btn-sm',
            onClick:function(){dbPut(CALIB_STORE,Object.assign({key:'em_fingerprint'},emFp.fingerprint));},
            style:{background:'#00ddff11',border:'1px solid #00ddff33',color:'#00ddff',padding:'8px',fontSize:'9px'}},
            'SAVE')
        ),
        !mag.available&&h('div',{style:{fontSize:'8px',color:'#ff8800',marginTop:'4px'}},'⚠ Magnetometer not available on this device')
      ),

      /* SIM → REAL MIGRATION GUIDE */
      h('div',{className:'card',style:{padding:'8px',marginBottom:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px',display:'flex',justifyContent:'space-between'}},
          h('span',null,'SIM → REAL MIGRATION GUIDE'),
          mediation.reality&&h('span',{style:{color:'#00ffaa'}},'ρ = '+(mediation.reality.index*100).toFixed(0)+'%')),
        DIM_KEYS.map(function(k,i){
          var src=mediation.sources[k]||'na';
          var status=getMigrationStatus(k,src);
          var m=MIGRATION_GUIDE[k];if(!m)return null;
          return h('div',{key:k,className:'migration-card '+status},
            h('div',{className:'migration-label'},
              h('span',{style:{color:DIM_COLORS[i]}},m.label),
              h('span',{style:{color:status==='done'?'#00ffaa':status==='partial'?'#ffcc00':'#556677'}},
                status==='done'?'✓ REAL':status==='partial'?'◎ EST':'○ SIM')),
            m.steps.map(function(step,si){
              var done=step.check(src);
              return h('div',{key:si,className:'migration-step '+(done?'done':'')},step.text);
            })
          );
        })
      )
    ),

    /* ═══ SPECTRUM TAB ═══ */
    layer==='spectrum'&&h('div',null,
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'RF SPECTRUM — '+rf.band.name),
        h('div',{style:{display:'flex',gap:'4px',marginBottom:'6px'}},
          Object.keys(RF_BANDS).map(function(bid){
            return h('button',{key:bid,className:'btn btn-sm',
              style:{border:'1px solid '+(rf.bandId===bid?RF_BANDS[bid].color+'66':'#1a2530'),color:rf.bandId===bid?RF_BANDS[bid].color:'#556677',fontSize:'8px',padding:'3px 6px'},
              onClick:function(){rf.setBandId(bid);}},RF_BANDS[bid].name);
          })
        ),
        h(SpecCanvas,{spectrum:rf.spectrum,band:rf.band})
      ),
      /* Sensor data cards */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'SENSOR DATA'),
        h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'4px',fontSize:'9px'}},
          h('div',null,'MAG: ',h('span',{style:{color:mag.available?'#00ffaa':'#556677'}},mag.available?mag.mag.toFixed(1)+'µT':'N/A')),
          h('div',null,'LUX: ',h('span',{style:{color:light.available?'#ffcc00':'#556677'}},light.lux!=null?Math.round(light.lux):'N/A')),
          h('div',null,'ACCEL: ',h('span',{style:{color:motion.available?'#00ddff':'#556677'}},motion.available?motion.mag.toFixed(1)+'m/s²':'N/A')),
          h('div',null,'THERM: ',h('span',{style:{color:thermal.data.available?'#ff8800':'#556677'}},thermal.data.est!=null?thermal.data.est+'°C':'N/A')),
          h('div',null,'GEO: ',h('span',{style:{color:geo.available?'#22ee88':'#556677'}},geo.available?'±'+Math.round(geo.acc)+'m':'N/A')),
          h('div',null,'BLE: ',h('span',{style:{color:ble.state.scanning?'#4488ff':'#556677'}},ble.state.total+' devices'))
        )
      )
    ),

    /* ═══ PEERS TAB (WebRTC) ═══ */
    layer==='peers'&&h('div',null,
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px'}},'WEBRTC P2P — ',h('span',{style:{color:mp.isConnected?'#00ffaa':'#556677'}},mp.state.toUpperCase())),
        h('div',{style:{display:'flex',gap:'6px',marginBottom:'8px'}},
          h('button',{className:'btn btn-sm',onClick:mp.createOffer,disabled:mp.state==='creating_offer'||mp.state==='waiting_answer',
            style:{background:'#00ffaa15',border:'1px solid #00ffaa44',color:'#00ffaa',padding:'6px 12px'}},'CREATE OFFER'),
          h('button',{className:'btn btn-sm',onClick:mp.close,style:{background:'#ff333315',border:'1px solid #ff333344',color:'#ff3333',padding:'6px 12px'}},'CLOSE ALL')
        ),
        mp.qrImg&&h('div',{style:{textAlign:'center',marginBottom:'8px'}},
          h('img',{src:mp.qrImg,style:{maxWidth:'200px',imageRendering:'pixelated'}}),
          h('div',{style:{fontSize:'8px',color:'#556677',marginTop:'4px'}},mp.state==='waiting_answer'?'Scan on peer device':'Show to initiator')
        ),
        h(QRScanner,{onScan:function(data){
          if(mp.state==='waiting_answer')mp.processAnswer(data);
          else mp.processOffer(data);
        }}),
        mp.error&&h('div',{style:{color:'#ff4444',fontSize:'9px',margin:'6px 0'}},mp.error),
        mp.peers.length>0&&h('div',{style:{marginTop:'8px'}},
          mp.peers.map(function(p){
            return h('div',{key:p.id,className:'card',style:{padding:'6px',marginBottom:'4px',border:'1px solid '+(p.state==='connected'?'#00ffaa22':'#ff444422')}},
              h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:'9px'}},
                h('span',{style:{color:'#00ddff'}},p.name),
                h('span',{style:{color:p.state==='connected'?'#00ffaa':'#ff4444'}},p.state)
              ),
              h('div',{style:{fontSize:'8px',color:'#556677',marginTop:'2px'}},
                'ICE: '+p.iceType+' | RTT: '+(p.rtt||'---')+'ms | Quality: '+(p.quality?p.quality.label:'---'))
            );
          })
        )
      )
    ),

    /* ═══ HEATMAP TAB (v1.2) ═══ */
    layer==='heatmap'&&h('div',null,
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'SPATIAL HEATMAP — μ(x,t) | ',heatPoints.length,' points'),
        h(HeatmapCanvas,{points:heatPoints}),
        h('div',{style:{display:'flex',gap:'6px',marginTop:'6px'}},
          h('button',{className:'btn btn-sm',onClick:function(){setHeatPoints([]);},
            style:{border:'1px solid #ff333344',color:'#ff3333',fontSize:'8px',padding:'3px 8px'}},'CLEAR'),
          h('button',{className:'btn btn-sm',onClick:function(){exportJSON(heatPoints,'ptcp_heatmap_'+Date.now()+'.json');},
            style:{border:'1px solid #00ddff44',color:'#00ddff',fontSize:'8px',padding:'3px 8px'}},'EXPORT JSON')
        )
      ),
      /* Mini time-series chart */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'TIME-SERIES — μ(x,t) | ',timeSeries.count,' snapshots'),
        h(TimeSeriesCanvas,{data:timeSeries.data,activeDims:activeDims,showComposite:showComposite,height:160}),
        h('div',{style:{display:'flex',flexWrap:'wrap',gap:'3px',marginTop:'4px'}},
          DIM_KEYS.map(function(k,i){
            var active=activeDims.indexOf(k)>=0;
            return h('button',{key:k,className:'btn btn-sm',
              style:{fontSize:'7px',padding:'2px 4px',border:'1px solid '+(active?DIM_COLORS[i]+'44':'#1a2530'),color:active?DIM_COLORS[i]:'#334455'},
              onClick:function(){setActiveDims(function(p){return active?p.filter(function(d){return d!==k;}):p.concat([k]);});}},DIM_LABELS[i]);
          }),
          h('button',{className:'btn btn-sm',style:{fontSize:'7px',padding:'2px 4px',border:'1px solid '+(showComposite?'#ffffff44':'#1a2530'),color:showComposite?'#ffffff':'#334455'},
            onClick:function(){setShowComposite(!showComposite);}},'COMP')
        )
      )
    ),

    /* ═══ TIMELINE TAB (v1.2) ═══ */
    layer==='timeline'&&h('div',null,
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'PHASE-LAW TIMELINE'),
        timeSeries.data.length>2?h(PhaseTimelineCanvas,{data:timeSeries.data,laws:phaseLaws}):
          h('div',{style:{fontSize:'9px',color:'#334455',textAlign:'center',padding:'20px'}},'需要3+ スナップショット')
      ),
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'PHASE-LAW CURRENT STATE'),
        phaseLaws.map(function(l){
          var c=l.result.score>.65?'#00ffaa':l.result.score>.35?'#ffcc00':'#ff4444';
          return h('div',{key:l.id,style:{marginBottom:'4px'}},
            h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:'9px'}},
              h('span',{style:{color:'#8899aa'}},l.id,' ',l.name),
              h('span',{style:{color:c,fontWeight:'bold'}},l.result.state)
            ),
            h('div',{style:{height:'4px',background:'#0a0f14',borderRadius:'2px',overflow:'hidden'}},
              h('div',{style:{width:(l.result.score*100)+'%',height:'100%',background:c,transition:'width .3s'}}))
          );
        })
      )
    ),

    /* ═══ DASHBOARD TAB (v1.2) ═══ */
    layer==='dashboard'&&h('div',null,
      /* Interactive radar with weight sliders */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'INTERACTIVE 11D RADAR'),
        h(InteractiveRadar,{dims:mediation.dims,sources:mediation.sources,weights:weights}),
        h('div',{style:{marginTop:'8px'}},
          DIM_KEYS.map(function(k,i){
            return h('div',{key:k,className:'weight-slider',style:{display:'flex',alignItems:'center',gap:'6px',marginBottom:'2px',fontSize:'8px'}},
              h('span',{style:{color:DIM_COLORS[i],width:'40px'}},DIM_LABELS[i]),
              h('input',{type:'range',min:0,max:100,value:Math.round((weights[k]||0)*100),
                style:{flex:1,accentColor:DIM_COLORS[i],height:'12px'},
                onChange:function(ev){setWeights(function(w){var nw=Object.assign({},w);nw[k]=ev.target.value/100;return nw;});}}),
              h('span',{style:{color:'#556677',width:'28px',textAlign:'right'}},(weights[k]||0).toFixed(2))
            );
          })
        ),
        h('button',{className:'btn btn-sm',onClick:function(){setWeights(Object.assign({},DEFAULT_WEIGHTS));},
          style:{marginTop:'6px',border:'1px solid #ff880044',color:'#ff8800',fontSize:'8px',padding:'3px 8px'}},'RESET WEIGHTS')
      ),
      /* Stats */
      (function(){
        var stats=timeSeries.getStats();
        return stats?h('div',{className:'card',style:{padding:'8px'}},
          h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'STATISTICS ('+stats.count+' samples)'),
          h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:'4px'}},
            h('div',{className:'dash-stat'},h('div',{style:{fontSize:'16px',color:'#00ffaa'}},stats.composite.mean.toFixed(3)),h('div',{style:{fontSize:'7px',color:'#556677'}},'MEAN μ')),
            h('div',{className:'dash-stat'},h('div',{style:{fontSize:'16px',color:'#ffcc00'}},stats.composite.std.toFixed(3)),h('div',{style:{fontSize:'7px',color:'#556677'}},'STD DEV')),
            h('div',{className:'dash-stat'},h('div',{style:{fontSize:'16px',color:'#00ddff'}},stats.composite.min.toFixed(3)),h('div',{style:{fontSize:'7px',color:'#556677'}},'MIN')),
            h('div',{className:'dash-stat'},h('div',{style:{fontSize:'16px',color:'#cc66ff'}},stats.composite.max.toFixed(3)),h('div',{style:{fontSize:'7px',color:'#556677'}},'MAX'))
          )
        ):h('div',{className:'card',style:{padding:'20px',textAlign:'center',fontSize:'9px',color:'#334455'}},'計測データ待ち...');
      })(),
      /* Export buttons */
      h('div',{style:{display:'flex',gap:'6px',margin:'8px 0'}},
        h('button',{className:'btn btn-sm',onClick:function(){exportCSV(timeSeries.data,'ptcp_ts_'+Date.now()+'.csv');},
          style:{border:'1px solid #00ffaa44',color:'#00ffaa',fontSize:'8px',padding:'4px 10px'}},'EXPORT CSV'),
        h('button',{className:'btn btn-sm',onClick:function(){exportJSON({timeSeries:timeSeries.data,mediation:mediation,phaseLaws:phaseLaws},'ptcp_session_'+Date.now()+'.json');},
          style:{border:'1px solid #00ddff44',color:'#00ddff',fontSize:'8px',padding:'4px 10px'}},'EXPORT JSON'),
        h('button',{className:'btn btn-sm',onClick:function(){timeSeries.clear();setHeatPoints([]);},
          style:{border:'1px solid #ff333344',color:'#ff3333',fontSize:'8px',padding:'4px 10px'}},'CLEAR ALL')
      )
    ),

    /* ═══ PROFILES TAB (v1.2) ═══ */
    layer==='profiles'&&h('div',null,
      /* Save profile */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'SAVE PROFILE'),
        h('div',{style:{display:'flex',gap:'6px'}},
          h('input',{type:'text',value:profName,onChange:function(e){setProfName(e.target.value);},
            placeholder:'Profile name...',
            style:{flex:1,background:'#0a0f14',border:'1px solid #1a2530',color:'#ccddeef0',fontFamily:'"IBM Plex Mono",monospace',fontSize:'10px',padding:'6px 8px',borderRadius:'2px'}}),
          h('button',{className:'btn btn-sm',onClick:function(){
            profileMgr.saveProfile(profName||'Profile '+new Date().toLocaleString(),timeSeries.data,mediation,phaseLaws);
            setProfName('');
          },style:{background:'#00ffaa15',border:'1px solid #00ffaa44',color:'#00ffaa',padding:'6px 12px',fontSize:'9px'}},'SAVE')
        )
      ),
      /* Profile list */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'SAVED PROFILES ('+profileMgr.profiles.length+')'),
        profileMgr.profiles.length===0?
          h('div',{style:{fontSize:'9px',color:'#334455',textAlign:'center',padding:'12px'}},'No profiles saved'):
          profileMgr.profiles.map(function(p){
            return h('div',{key:p.id,className:'profile-card',style:{padding:'6px',marginBottom:'4px',border:'1px solid #1a2530',borderRadius:'2px'}},
              h('div',{style:{display:'flex',justifyContent:'space-between',marginBottom:'4px'}},
                h('span',{style:{color:'#00ddff',fontSize:'10px'}},p.name),
                h('span',{style:{color:'#556677',fontSize:'8px'}},new Date(p.created).toLocaleDateString())
              ),
              p.stats&&h('div',{style:{fontSize:'8px',color:'#556677',marginBottom:'4px'}},
                'μ='+p.stats.mean.toFixed(3)+' ±'+p.stats.std.toFixed(3)+' | n='+p.stats.count),
              h('div',{style:{display:'flex',gap:'4px'}},
                h('button',{className:'btn btn-sm',onClick:function(){profileMgr.exportProfile(p);},
                  style:{fontSize:'7px',padding:'2px 6px',border:'1px solid #00ddff44',color:'#00ddff'}},'EXPORT'),
                h('button',{className:'btn btn-sm',onClick:function(){setCompareA(p);},
                  style:{fontSize:'7px',padding:'2px 6px',border:'1px solid #ffcc0044',color:'#ffcc00'}},'CMP A'),
                h('button',{className:'btn btn-sm',onClick:function(){setCompareB(p);},
                  style:{fontSize:'7px',padding:'2px 6px',border:'1px solid #cc66ff44',color:'#cc66ff'}},'CMP B'),
                h('button',{className:'btn btn-sm',onClick:function(){profileMgr.deleteProfile(p.id);},
                  style:{fontSize:'7px',padding:'2px 6px',border:'1px solid #ff333344',color:'#ff3333'}},'DEL')
              )
            );
          })
      ),
      /* Compare result */
      compResult&&h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'COMPARISON: ',
          h('span',{style:{color:'#ffcc00'}},compareA&&compareA.name),' vs ',
          h('span',{style:{color:'#cc66ff'}},compareB&&compareB.name)),
        h('div',{style:{fontSize:'11px',color:compResult.compositeDiff>0?'#00ffaa':'#ff4444',marginBottom:'6px'}},
          'Δμ = '+(compResult.compositeDiff>0?'+':'')+compResult.compositeDiff.toFixed(4)),
        compResult.alerts.length>0&&h('div',{style:{marginBottom:'6px'}},
          compResult.alerts.map(function(a,i){
            return h('div',{key:i,style:{fontSize:'8px',color:a.severity==='crit'?'#ff4444':'#ffcc00',padding:'2px 0'}},
              (a.severity==='crit'?'⚠ ':'△ ')+a.msg);
          })
        ),
        h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'3px',fontSize:'8px'}},
          DIM_KEYS.map(function(k,i){
            var dd=compResult.dimDiffs[k];
            return h('div',{key:k,style:{padding:'3px',background:'#0a0f14',borderRadius:'2px'}},
              h('div',{style:{color:DIM_COLORS[i]}},DIM_LABELS[i]),
              h('div',{style:{color:dd.diff>0?'#00ffaa':'#ff4444'}},(dd.diff>0?'+':'')+dd.diff.toFixed(3)),
              h('div',{style:{color:'#556677'}},dd.pct.toFixed(0)+'%'));
          })
        )
      ),
      /* Import */
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'IMPORT PROFILE'),
        h('textarea',{style:{width:'100%',background:'#0a0f14',border:'1px solid #1a2530',color:'#8899aa',fontFamily:'"IBM Plex Mono",monospace',fontSize:'9px',padding:'6px',borderRadius:'2px',resize:'vertical',height:'50px'},
          placeholder:'Paste exported JSON...',
          onChange:function(ev){var val=ev.target.value.trim();if(val.length>50){var r=profileMgr.importProfile(val);}}})
      )
    ),

    /* ═══ NETWORK TAB ═══ */
    layer==='network'&&h('div',null,
      h('div',{className:'card',style:{padding:'8px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'6px'}},'pTCP/IP MESH — ',h('span',{style:{color:net.connected?'#00ffaa':'#ff4444'}},net.connected?'CONNECTED':'DISCONNECTED')),
        h('div',{style:{display:'flex',gap:'6px',marginBottom:'8px'}},
          !net.connected?h('button',{className:'btn btn-sm',onClick:net.connect,style:{background:'#00ffaa15',border:'1px solid #00ffaa44',color:'#00ffaa',padding:'6px 12px'}},'CONNECT'):
            h('button',{className:'btn btn-sm',onClick:net.disconnect,style:{background:'#ff333315',border:'1px solid #ff333344',color:'#ff3333',padding:'6px 12px'}},'DISCONNECT')
        ),
        h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:'4px',fontSize:'8px',marginBottom:'6px'}},
          h('div',null,'TX: ',h('span',{style:{color:'#00ffaa'}},net.stats.sent)),
          h('div',null,'RX: ',h('span',{style:{color:'#00ddff'}},net.stats.recv)),
          h('div',null,'DROP: ',h('span',{style:{color:'#ff4444'}},net.stats.dropped)),
          h('div',null,'UP: ',h('span',{style:{color:'#ffcc00'}},net.stats.uptime+'s'))
        ),
        net.peers.length>0&&net.peers.map(function(p){
          return h('div',{key:p.id,style:{padding:'4px 0',borderBottom:'1px solid #0a0f14',fontSize:'9px'}},
            h('div',{style:{display:'flex',justifyContent:'space-between'}},
              h('span',{style:{color:'#00ddff'}},p.name||p.id.slice(0,12)),
              h('span',{style:{color:p.connected?'#00ffaa':'#ff4444'}},p.connected?'ONLINE':'OFFLINE')
            ),
            h('div',{style:{color:'#556677',fontSize:'8px'}},'μ='+(p.mediation||0).toFixed(3)+' | RTT='+(p.rtt||'---')+'ms')
          );
        })
      )
    ),


    /* ═══ MIDBRAIN TAB (v1.5) ═══ */
    layer==='midbrain'&&h('div',null,
      /* 4-layer architecture overview */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'8px'}},'人工神経系 — 4層アーキテクチャ'),
        h('div',{className:'brain-layer L3'},
          h('div',{className:'brain-layer-id',style:{color:'#00ffaa'}},'L3'),
          h('div',null,
            h('div',{className:'brain-layer-name',style:{color:'#00ffaa'}},'大脳 — Cerebrum (Claude API)'),
            h('div',{style:{fontSize:'9px',color:'#445566'}},'自然言語解釈 · 状況報告 · 推奨アクション')
          ),
          h('div',{className:'brain-layer-status',style:{background:'rgba(0,255,170,.1)',border:'1px solid #00ffaa33',color:'#00ffaa'}},
            cerebrum.callCount>0?'ACTIVE ('+cerebrum.callCount+'calls)':'STANDBY')
        ),
        h('div',{className:'brain-flow'},'↑ 意味 · 判断 · 言語 ↑  /  ↓ 指令 · 制約 · 承認 ↓'),
        h('div',{className:'brain-layer L2'},
          h('div',{className:'brain-layer-id',style:{color:'#00ddff'}},'L2'),
          h('div',null,
            h('div',{className:'brain-layer-name',style:{color:'#00ddff'}},'調整層 — SiteSense Application'),
            h('div',{style:{fontSize:'9px',color:'#445566'}},'ゾーン管理 · 作業員追跡 · 安全ダッシュボード')
          ),
          h('div',{className:'brain-layer-status',style:{background:'rgba(0,221,255,.1)',border:'1px solid #00ddff33',color:'#00ddff'}},siteSense.alerts.length>0?siteSense.alerts.length+'ALERT':'NORMAL')
        ),
        h('div',{className:'brain-flow'},'↑ 顕著性信号 / 整理済み現実 ↑  /  ↓ 閾値調整 ↓'),
        h('div',{className:'brain-layer L1'},
          h('div',{className:'brain-layer-id',style:{color:'#ffcc00'}},'L1'),
          h('div',null,
            h('div',{className:'brain-layer-name',style:{color:'#ffcc00'}},'中脳 — Artificial Midbrain'),
            h('div',{style:{fontSize:'9px',color:'#445566'}},'Reflex Gate · Salience Filter · Mode FSM · Embodiment Core')
          ),
          h('div',{className:'mode-badge mode-'+midbrain.mode,style:{padding:'3px 10px',fontSize:'9px',margin:0}},midbrain.mode)
        ),
        h('div',{className:'brain-flow'},'↑ Phase-Law評価 / センサーデータ ↑'),
        h('div',{className:'brain-layer L0'},
          h('div',{className:'brain-layer-id',style:{color:'#cc66ff'}},'L0'),
          h('div',null,
            h('div',{className:'brain-layer-name',style:{color:'#cc66ff'}},'小脳 — Phase-Law Engine (Physical Ping)'),
            h('div',{style:{fontSize:'9px',color:'#445566'}},'11D Sensor Fusion · 8 Phase-Laws · pTCP/IP Protocol')
          ),
          h('div',{className:'brain-layer-status',style:{background:'rgba(204,102,255,.1)',border:'1px solid #cc66ff33',color:'#cc66ff'}},
            phaseLaws.filter(function(l){return l.result.state==='DECOUPLED'||l.result.state==='MISMATCHED';}).length===0?'COUPLED':'DECOUPLED×'+phaseLaws.filter(function(l){return l.result.state==='DECOUPLED'||l.result.state==='MISMATCHED';}).length)
        )
      ),

      /* Mode FSM + Salience queue */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'L1 中脳 — 現在状態'),
        h('div',{style:{display:'flex',alignItems:'center',gap:'10px',marginBottom:'8px'}},
          h('div',{className:'mode-badge mode-'+midbrain.mode},midbrain.mode),
          h('button',{className:'btn btn-sm',onClick:midbrain.resetMode,style:{fontSize:'8px',padding:'3px 10px',border:'1px solid #334455',color:'#556677'}},'RESET → NOMINAL')
        ),
        h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'顕著性フィルタ (Salience Filter)'),
        h('div',{className:'salience-queue'},
          midbrain.salienceQueue.length===0?
            h('span',{style:{fontSize:'8px',color:'#334455'}},'信号なし — 沈黙デフォルト'):
            midbrain.salienceQueue.map(function(s){
              return h('span',{key:s.id,className:'salience-tag',style:{background:s.color+'22',border:'1px solid '+s.color+'44',color:s.color}},s.label);
            })
        )
      ),

      /* Cerebrum (Claude API) */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'L3 大脳 — Claude API Cerebrum'),
        h('div',{style:{display:'flex',gap:'8px',marginBottom:'8px',flexWrap:'wrap'}},
          h('button',{className:'btn btn-sm',disabled:cerebrum.loading,
            onClick:function(){
              midbrain.computeSalience();
              cerebrum.query({
                composite:mediation.composite,reality:mediation.reality,
                result_dist:result&&result.distM,result_conf:result&&result.conf,
                emMag:mag.mag||0,bleDensity:ble.state.density||0,thermalEst:thermal.data&&thermal.data.est
              },midbrain.mode,midbrain.salienceQueue,phaseLaws);
            },
            style:{background:'#00ffaa15',border:'1px solid #00ffaa44',color:'#00ffaa',padding:'6px 12px',fontSize:'9px'}},
            cerebrum.loading?'大脳処理中...':'大脳クエリ実行'),
          cerebrum.loading&&h('button',{className:'btn btn-sm',onClick:cerebrum.abort,style:{border:'1px solid #ff333344',color:'#ff3333',fontSize:'8px',padding:'4px 8px'}},'ABORT'),
          cerebrum.lastCall&&h('span',{style:{fontSize:'8px',color:'#334455',lineHeight:'2'}},cerebrum.lastCall.toLocaleTimeString())
        ),
        cerebrum.loading&&h('div',{className:'cerebrum-thinking'},h('div',{className:'cerebrum-spinner'}),' Claude 思考中 (中脳がフィルタリング済みデータを大脳へ送信)'),
        cerebrum.apiErr&&h('div',{style:{fontSize:'9px',color:'#ff6666',padding:'6px',marginBottom:'6px'}},'⚠ '+cerebrum.apiErr),
        cerebrum.responses.length===0&&!cerebrum.loading&&h('div',{style:{fontSize:'9px',color:'#334455',padding:'10px',textAlign:'center'}},
          '大脳は沈黙中 — 顕著な変化を検知した際に自動起動、または手動クエリ可能'),
        cerebrum.responses.slice(0,3).map(function(r){
          return h('div',{key:r.id,className:'cerebrum-panel'},
            h('div',{className:'cerebrum-response'},r.response),
            h('div',{className:'cerebrum-meta'},
              h('span',null,'MODE: '+r.mode),
              h('span',null,'SIGNALS: '+r.signals),
              h('span',null,'LATENCY: '+(r.latency/1000).toFixed(1)+'s'),
              h('span',null,new Date(r.ts).toLocaleTimeString())
            )
          );
        })
      ),

      /* Reflex Gate Log */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'4px'}},'反射ゲートログ (Reflex Gate Log)'),
        h('div',{className:'reflex-log'},
          midbrain.reflexLog.length===0?h('div',{style:{fontSize:'8px',color:'#334455',padding:'8px',textAlign:'center'}},'正常動作中 — イベントなし'):
          midbrain.reflexLog.slice(0,15).map(function(e,i){
            return h('div',{key:i,className:'reflex-entry '+e.level},
              h('span',{style:{color:'#445566',minWidth:'55px',flexShrink:0}},new Date(e.ts).toLocaleTimeString()),
              h('span',null,e.msg)
            );
          })
        )
      ),

      /* Embodiment Core */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'4px'}},'身体性コア (Embodiment Core) — 物理制約'),
        midbrain.embStatus.map(function(c){
          return h('div',{key:c.id,className:'emb-constraint'},
            h('span',{style:{color:'#8899aa'}},c.name),
            h('span',{style:{color:'#445566'}},c.limit),
            h('span',{className:c.ok?'emb-ok':'emb-viol'},c.ok?'✓':'✗'),
            h('span',{style:{color:'#667788',minWidth:'60px',textAlign:'right'}},c.val)
          );
        })
      )
    ),

    /* ═══ SITESENSE TAB (v1.5) ═══ */
    layer==='site'&&h('div',null,
      /* Active alerts */
      siteSense.alerts.length>0&&h('div',{style:{marginBottom:'8px'}},
        siteSense.alerts.map(function(a){
          return h('div',{key:a.id,className:'ss-alert '+a.sev},
            h('span',{style:{fontSize:'14px'}},a.sev==='CRIT'?'🚨':a.sev==='DANGER'?'⚠️':'⚡'),
            h('div',null,a.msg)
          );
        })
      ),

      /* Environmental report */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'環境計測レポート'),
        siteSense.report&&h('div',{className:'ss-report-grid'},
          Object.entries(siteSense.report).map(function(kv){
            var k=kv[0],v=kv[1];
            return h('div',{key:k,className:'ss-report-card'},
              h('div',{className:'ss-report-val',style:{color:v.ok?'#00ffaa':'#ff8800'}},v.val+v.unit),
              h('div',{className:'ss-report-lbl'},v.label)
            );
          })
        ),
        h('div',{style:{display:'flex',gap:'6px',marginTop:'8px'}},
          h('button',{className:'btn btn-sm',onClick:siteSense.exportReport,style:{border:'1px solid #00ffaa44',color:'#00ffaa',fontSize:'9px',padding:'5px 12px'}},'レポートExport'),
          h('button',{className:'btn btn-sm',onClick:function(){siteSense.addKYEntry('WARNING','手動KYエントリ: 現場確認完了');},style:{border:'1px solid #ffcc0044',color:'#ffcc00',fontSize:'9px',padding:'5px 12px'}},'KY記録')
        )
      ),

      /* Mode badge */
      h('div',{className:'card',style:{padding:'10px',display:'flex',alignItems:'center',gap:'10px'}},
        h('div',null,
          h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'システムモード'),
          h('div',{className:'mode-badge mode-'+midbrain.mode},midbrain.mode)
        ),
        h('div',null,
          h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'μ(x,t)'),
          h('div',{style:{fontSize:'20px',fontWeight:700,color:mediation.composite>.6?'#00ffaa':mediation.composite>.3?'#ffcc00':'#ff4444'}},mediation.composite.toFixed(3))
        ),
        h('div',null,
          h('div',{style:{fontSize:'9px',color:'#556677',marginBottom:'4px'}},'作業員確認'),
          h('div',{style:{fontSize:'20px',fontWeight:700,color:'#00ddff'}},siteSense.workers.length)
        )
      ),

      /* Zone list */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'安全ゾーン管理'),
        siteSense.zones.map(function(z){
          var color=ZONE_COLORS[z.type];
          var alerting=midbrain.mode!=='NOMINAL'&&(z.type==='DANGER'||z.type==='EXCLUSION');
          return h('div',{key:z.id,className:'ss-zone '+z.type,style:{boxShadow:alerting?'0 0 12px '+color+'44':'none'}},
            h('div',{className:'ss-zone-header'},
              h('div',{className:'ss-zone-name',style:{color:color}},z.name),
              h('div',{className:'ss-zone-badge',style:{background:color+'22',border:'1px solid '+color+'44',color:color}},z.type)
            ),
            h('div',{style:{fontSize:'9px',color:'#556677',display:'flex',gap:'12px'}},
              h('span',null,'作業員: ',h('span',{style:{color:z.workers>0?'#00ddff':'#334455'}},z.workers)),
              h('span',null,'μ閾値: ',h('span',{style:{color:'#8899aa'}},z.mu_threshold.toFixed(1))),
              alerting&&h('span',{style:{color:color,fontWeight:'bold'}},'⚠ アラート')
            )
          );
        })
      ),

      /* Worker tracking */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'作業員追跡 — BLE'),
        siteSense.workers.map(function(w){
          var z=siteSense.zones.find(function(z){return z.id===w.zone;});
          var zColor=z?ZONE_COLORS[z.type]:'#556677';
          return h('div',{key:w.id,className:'ss-worker'},
            h('div',{style:{width:'28px',height:'28px',borderRadius:'50%',background:zColor+'33',border:'1px solid '+zColor+'66',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'14px'}},'👷'),
            h('div',{style:{flex:1}},
              h('div',{style:{color:'#aabbcc',fontSize:'10px'}},w.name),
              h('div',{style:{fontSize:'8px',color:'#556677'}},z?z.name:'---',' | ',w.ble,' | RSSI:',h('span',{style:{color:w.rssi>-65?'#00ffaa':'#ffcc00'}},w.rssi+'dBm'))
            ),
            h('div',{style:{fontSize:'8px',color:w.status==='ACTIVE'?'#00ffaa':'#ffcc00',letterSpacing:'1px'}},w.status)
          );
        })
      ),

      /* KY/Hiyari-hat log */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'4px'}},'KY・ヒヤリハットログ'),
        h('div',{className:'ky-log'},
          siteSense.kyLog.length===0?
            h('div',{style:{fontSize:'9px',color:'#334455',padding:'10px',textAlign:'center'}},'ログなし — 正常稼働中'):
            siteSense.kyLog.slice(0,20).map(function(e){
              var sevColor=e.sev==='DANGER'?'#ff4444':e.sev==='WARNING'?'#ffcc00':'#00ddff';
              return h('div',{key:e.id,className:'ky-entry'},
                h('span',{className:'ky-time'},new Date(e.ts).toLocaleTimeString()),
                h('span',{className:'ky-sev',style:{color:sevColor}},e.sev),
                h('span',{className:'ky-msg'},e.msg)
              );
            })
        )
      )
    ),

    /* ═══ PATENT TAB (v1.5) ═══ */
    layer==='patent'&&h('div',null,
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'特許実証データセット収集'),
        (function(){
          var m=patentData.metrics();
          var current=patentData.current;
          return h('div',null,
            !patentData.collecting?
              h('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'8px'}},
                ['10回','20回','30回','50回'].map(function(label,i){
                  var n=[10,20,30,50][i];
                  return h('button',{key:n,className:'btn btn-sm',onClick:function(){patentData.startCollection(n);},style:{border:'1px solid #00ffaa44',color:'#00ffaa',fontSize:'9px',padding:'5px 12px'}},label+'収集');
                })
              ):
              h('div',{style:{marginBottom:'8px'}},
                h('div',{style:{display:'flex',alignItems:'center',gap:'10px',marginBottom:'6px'}},
                  h('div',{style:{fontSize:'11px',color:'#00ffaa'}},
                    (current?current.samples.length:0),' / ',(current?current.targetN:'?'),' サンプル'),
                  h('div',{style:{flex:1,height:'6px',background:'#0a0f14',borderRadius:'3px',overflow:'hidden'}},
                    h('div',{style:{height:'100%',background:'#00ffaa',borderRadius:'3px',width:current?(current.samples.length/current.targetN*100).toFixed(0)+'%':'0%',transition:'width .3s'}})
                  ),
                  h('button',{className:'btn btn-sm',onClick:patentData.stopCollection,style:{border:'1px solid #ff333344',color:'#ff3333',fontSize:'8px',padding:'3px 8px'}},'STOP')
                ),
                m&&h('div',{className:'patent-grid'},
                  h('div',{className:'patent-metric '+(m.std<0.03?'pass':m.std<0.05?'warn':'fail')},
                    h('div',{className:'patent-metric-val'},m.std!=null?(m.std*100).toFixed(1)+'cm':'---'),
                    h('div',{className:'patent-metric-lbl'},'標準偏差 (SD)'),
                    h('div',{className:'patent-metric-target'},'目標: <3cm')
                  ),
                  h('div',{className:'patent-metric '+(m.ci95<0.05?'pass':m.ci95<0.1?'warn':'fail')},
                    h('div',{className:'patent-metric-val'},m.ci95!=null?'±'+(m.ci95*100).toFixed(1)+'cm':'---'),
                    h('div',{className:'patent-metric-lbl'},'信頼区間 CI95%'),
                    h('div',{className:'patent-metric-target'},'目標: ±5cm')
                  ),
                  h('div',{className:'patent-metric '+(m.mean?'pass':'warn')},
                    h('div',{className:'patent-metric-val'},m.mean!=null?m.mean.toFixed(3)+'m':'---'),
                    h('div',{className:'patent-metric-lbl'},'平均距離'),
                    h('div',{className:'patent-metric-target'},'測定値')
                  ),
                  h('div',{className:'patent-metric '+(m.reproducibility==='EXCELLENT'||m.reproducibility==='GOOD'?'pass':m.reproducibility==='FAIR'?'warn':'fail')},
                    h('div',{className:'patent-metric-val'},m.reproducibility||'---'),
                    h('div',{className:'patent-metric-lbl'},'再現性評価'),
                    h('div',{className:'patent-metric-target'},'目標: GOOD以上')
                  )
                )
              )
          );
        })()
      ),

      /* Completed sessions */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'完了セッション ('+patentData.sessions.length+')'),
        h('div',{style:{display:'flex',gap:'6px',marginBottom:'8px'}},
          h('button',{className:'btn btn-sm',onClick:patentData.exportPatentDataset,disabled:patentData.sessions.length===0,style:{border:'1px solid #00ffaa44',color:'#00ffaa',fontSize:'9px',padding:'5px 12px'}},'特許データセットExport'),
          h('button',{className:'btn btn-sm',onClick:function(){
            var data={timestamp:new Date().toISOString(),mediation:mediation.composite,phaseLaws:phaseLaws.map(function(l){return{id:l.id,state:l.result.state,score:l.result.score};}),history:history.slice(0,50)};
            var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
            var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='ptcp_snapshot_'+Date.now()+'.json';a.click();URL.revokeObjectURL(url);
          },style:{border:'1px solid #00ddff44',color:'#00ddff',fontSize:'9px',padding:'5px 12px'}},'スナップショットExport')
        ),
        patentData.sessions.length===0?
          h('div',{style:{fontSize:'9px',color:'#334455',padding:'10px',textAlign:'center'}},'セッションなし — 上のボタンで収集開始'):
          patentData.sessions.map(function(s){
            return h('div',{key:s.id,style:{padding:'8px',border:'1px solid #1a2530',borderRadius:'2px',marginBottom:'4px'}},
              h('div',{style:{display:'flex',justifyContent:'space-between',marginBottom:'3px'}},
                h('span',{style:{color:'#00ddff',fontSize:'10px'}},'Session #'+s.id.slice(0,6)),
                h('span',{style:{color:'#556677',fontSize:'8px'}},new Date(s.started).toLocaleString())
              ),
              s.stats&&h('div',{style:{fontSize:'9px',color:'#8899aa'}},
                'n='+s.stats.n,' μ='+s.stats.mean.toFixed(3),' σ='+s.stats.std.toFixed(4),' CI95=±'+s.stats.ci95.toFixed(4),
                ' ',h('span',{style:{color:s.stats.reproducibility==='EXCELLENT'||s.stats.reproducibility==='GOOD'?'#00ffaa':'#ffcc00'}},s.stats.reproducibility)
              )
            );
          })
      ),

      /* v1.5 patent targets */
      h('div',{className:'card',style:{padding:'10px'}},
        h('div',{style:{fontSize:'9px',color:'#556677',letterSpacing:'2px',marginBottom:'6px'}},'v2.0成功指標'),
        h('div',{className:'patent-grid'},
          [
            {label:'音響精度 1m以内',target:'±3cm',cur:result&&result.distM!=null&&result.distM<1.0?'測定中':'未計測',ok:!!result&&result.distM!=null&&result.distM<1.0},
            {label:'Reality Index',target:'70%+',cur:mediation.reality?(mediation.reality.index*100).toFixed(0)+'%':'--',ok:mediation.reality&&mediation.reality.index>0.7},
            {label:'同時接続ピア',target:'5台+',cur:(net.peers.length+mp.connectedCount)+'台',ok:net.peers.length+mp.connectedCount>=5},
            {label:'空間再認識',target:'80%+',cur:'要v2.0',ok:false},
          ].map(function(t,i){
            return h('div',{key:i,className:'patent-metric '+(t.ok?'pass':'warn')},
              h('div',{className:'patent-metric-val'},t.cur),
              h('div',{className:'patent-metric-lbl'},t.label),
              h('div',{className:'patent-metric-target'},'目標: '+t.target)
            );
          })
        )
      )
    ),

    /* iOS sensor permission banner */
    sensorPerm.needsRequest&&h('div',{className:'card',style:{padding:'8px',margin:'8px 0',border:'1px solid #ff880044'}},
      h('div',{style:{fontSize:'9px',color:'#ff8800',marginBottom:'4px'}},'iOS: センサーパーミッション必要'),
      h('button',{className:'btn btn-sm',onClick:sensorPerm.requestAll,
        style:{background:'#ff880015',border:'1px solid #ff880044',color:'#ff8800',padding:'6px 12px',width:'100%'}},'GRANT SENSOR ACCESS')
    ),

    /* ═══ DEMO OVERLAY ═══ */
    demo.open&&h('div',{className:'demo-overlay',onClick:function(e){if(e.target===e.currentTarget)demo.close();}},
      h('div',{className:'demo-card'},
        h('div',{className:'demo-step'},'STEP '+(demo.step+1)+' / '+demo.total+' — PHYSICAL PING v1.5 DEMO'),
        h('div',{className:'demo-progress'},
          DEMO_STEPS.map(function(_,i){return h('div',{key:i,className:'demo-pip '+(i<demo.step?'done':i===demo.step?'active':'')});})
        ),
        h('div',{className:'demo-title'},demo.current.title),
        h('div',{className:'demo-desc'},demo.current.desc),
        h('div',{className:'demo-nav'},
          h('button',{className:'btn',onClick:demo.prev,disabled:demo.step===0,style:{border:'1px solid #334455',color:'#556677',padding:'8px 16px',fontSize:'10px'}},'← BACK'),
          h('button',{className:'btn',onClick:demo.close,style:{border:'1px solid #334455',color:'#556677',padding:'8px 16px',fontSize:'10px'}},'CLOSE'),
          demo.step<demo.total-1?
            h('button',{className:'btn',onClick:demo.next,style:{background:'#00ffaa15',border:'1px solid #00ffaa44',color:'#00ffaa',padding:'8px 20px',fontSize:'10px',fontWeight:'bold'}},'NEXT →'):
            h('button',{className:'btn',onClick:demo.close,style:{background:'#00ffaa22',border:'1px solid #00ffaa88',color:'#00ffaa',padding:'8px 20px',fontSize:'10px',fontWeight:'bold'}},'完了 ✓')
        )
      )
    ),

    /* Footer */
    h('div',{style:{textAlign:'center',padding:'12px',fontSize:'8px',color:'#334455',borderTop:'1px solid #0a0f14',marginTop:'12px'}},
      'PHYSICAL PING — pTCP/IP v1.5 APPLICATION',
      h('br'),
      'L0小脳 Phase-Law  ·  L1中脳 Midbrain  ·  L3大脳 Claude API ')
  );
}

/* Mount */
ReactDOM.render(h(App),document.getElementById('root'));
</script>
</body>
</html>
